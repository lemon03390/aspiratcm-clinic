(()=>{var e={};e.id=530,e.ids=[530],e.modules={7849:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external")},2934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},5403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},4580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},4749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},5869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},9491:e=>{"use strict";e.exports=require("assert")},6113:e=>{"use strict";e.exports=require("crypto")},2361:e=>{"use strict";e.exports=require("events")},7147:e=>{"use strict";e.exports=require("fs")},3685:e=>{"use strict";e.exports=require("http")},5687:e=>{"use strict";e.exports=require("https")},2037:e=>{"use strict";e.exports=require("os")},1017:e=>{"use strict";e.exports=require("path")},2781:e=>{"use strict";e.exports=require("stream")},6224:e=>{"use strict";e.exports=require("tty")},7310:e=>{"use strict";e.exports=require("url")},3837:e=>{"use strict";e.exports=require("util")},9796:e=>{"use strict";e.exports=require("zlib")},4599:(e,s,r)=>{"use strict";r.r(s),r.d(s,{GlobalError:()=>a.a,__next_app__:()=>u,originalPathname:()=>m,pages:()=>c,routeModule:()=>g,tree:()=>d});var t=r(482),o=r(9108),i=r(2563),a=r.n(i),l=r(8300),n={};for(let e in l)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(n[e]=()=>l[e]);r.d(s,n);let d=["",{children:["patient_registration",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(r.bind(r,9692)),"/Users/mountainfung/Desktop/AWS-Aspiratcm_local/frontend/src/app/patient_registration/page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(r.bind(r,1334)),"/Users/mountainfung/Desktop/AWS-Aspiratcm_local/frontend/src/app/layout.tsx"],"not-found":[()=>Promise.resolve().then(r.t.bind(r,9361,23)),"next/dist/client/components/not-found-error"]}],c=["/Users/mountainfung/Desktop/AWS-Aspiratcm_local/frontend/src/app/patient_registration/page.tsx"],m="/patient_registration/page",u={require:r,loadChunk:()=>Promise.resolve()},g=new t.AppPageRouteModule({definition:{kind:o.x.APP_PAGE,page:"/patient_registration/page",pathname:"/patient_registration",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:d}})},3654:(e,s,r)=>{Promise.resolve().then(r.t.bind(r,2583,23)),Promise.resolve().then(r.t.bind(r,6840,23)),Promise.resolve().then(r.t.bind(r,8771,23)),Promise.resolve().then(r.t.bind(r,3225,23)),Promise.resolve().then(r.t.bind(r,9295,23)),Promise.resolve().then(r.t.bind(r,3982,23))},7721:(e,s,r)=>{Promise.resolve().then(r.bind(r,5927))},1379:(e,s,r)=>{Promise.resolve().then(r.bind(r,7039))},5927:(e,s,r)=>{"use strict";r.r(s),r.d(s,{default:()=>a});var t=r(5344),o=r(6506),i=r(8428);function a(){let e=(0,i.usePathname)();return t.jsx("nav",{className:"bg-white shadow-md",children:t.jsx("div",{className:"container mx-auto px-4",children:(0,t.jsxs)("div",{className:"flex justify-between h-16",children:[t.jsx("div",{className:"flex items-center",children:t.jsx(o.default,{href:"/dashboard",children:(0,t.jsxs)("div",{className:"flex items-center",children:[t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-8 h-8 text-blue-600 mr-2",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z"})}),t.jsx("span",{className:"font-bold text-lg text-gray-800",children:"診所管理系統"})]})})}),t.jsx("div",{className:"flex space-x-4",children:[{href:"/dashboard",label:"儀表板"},{href:"/appointments",label:"預約管理"},{href:"/patient_registration",label:"患者登記"},{href:"/medical_record",label:"病歷系統"},{href:"/admin/settings",label:"設定管理"}].map(s=>t.jsx(o.default,{href:s.href,className:`inline-flex items-center px-3 py-2 border-b-2 text-sm font-medium leading-5 transition duration-150 ease-in-out ${e===s.href?"border-blue-500 text-blue-600 focus:outline-none focus:border-blue-700":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none focus:text-gray-700 focus:border-gray-300"}`,children:s.label},s.href))})]})})})}},7039:(e,s,r)=>{"use strict";r.r(s),r.d(s,{default:()=>f});var t=r(5344),o=r(3729),i=r(8428),a=r(984),l=r(7665);function n(e){return e.startsWith("/")?e:e.startsWith("http:")?(console.log("⚠️ 將 HTTP URL 替換為 HTTPS:",e),e.replace("http:","https:")):e}async function d(){let e={basic_diseases:["我沒有任何基礎病","高血壓","糖尿病","心臟病","其他，請列明"],drug_allergies:["我沒有任何藥物過敏","青黴素","非類固醇消炎藥","其他藥物，請列明"],food_allergies:["我沒有任何食物過敏","海鮮","堅果","其他食物，請列明"],data_sources:["朋友介紹","網絡","Instagram","Facebook"],regions:{香港:{中西區:["中環","上環"]}},doctors:[]},s=async(e,r=3,t=1e3)=>{try{let s=await fetch(e,{method:"GET",headers:{Accept:"application/json","Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},cache:"no-store"});if(!s.ok)throw Error(`HTTP error ${s.status}`);return s}catch(o){if(r<=1)throw o;return console.log(`重試請求 (${4-r}/3): ${e}`),await new Promise(e=>setTimeout(e,t)),s(e,r-1,1.5*t)}};try{let r=n((0,a.l9)("/patient_registration/reference-data/"));console.log("\uD83D\uDD12 請求參考資料:",r);let t=await s(r),o=await t.json();if(console.log("\uD83D\uDCCA 成功獲取參考資料，資料結構:",Object.keys(o)),o.doctors&&Array.isArray(o.doctors)&&0!==o.doctors.length)console.log("✅ 參考資料中已包含醫師資料，數量:",o.doctors.length);else{console.warn("⚠️ 參考資料中沒有醫師資料，嘗試從醫師 API 獲取");try{let e=n((0,a.l9)("/doctors/")),r=await s(e),t=await r.json();console.log("✅ 成功從專用 API 獲取醫師資料:",t),Array.isArray(t)&&t.length>0?o.doctors=t:console.warn("⚠️ 醫師 API 返回空數據或格式錯誤")}catch(e){console.error("❌ 無法從專用 API 獲取醫師資料:",e)}}for(let s of["basic_diseases","drug_allergies","food_allergies","data_sources"])o[s]&&Array.isArray(o[s])&&0!==o[s].length||(console.warn(`⚠️ 參考資料中缺少 ${s}，使用備用數據`),o[s]=e[s]);return o.regions&&0!==Object.keys(o.regions).length||(console.warn("⚠️ 參考資料中缺少 regions，使用備用數據"),o.regions=e.regions),o}catch(r){console.error("❌ 獲取參考資料失敗:",r);try{let r=n((0,a.l9)("/doctors/"));console.log("\uD83D\uDD04 嘗試從醫師 API 獲取醫師資料（最後嘗試）:",r);let t=await s(r,2),o=await t.json();Array.isArray(o)&&o.length>0&&(console.log("✅ 成功獲取醫師資料:",o),e.doctors=o)}catch(e){console.error("❌ 最終嘗試獲取醫師資料失敗")}return console.log("\uD83D\uDD04 使用後備參考資料:",e),e}}async function c(e){try{let s=e.replace(/[\(\)]/g,"").trim();console.log("\uD83D\uDD0D 格式化後的身份證號碼:",s);let r=n((0,a.l9)("/patient_registration/check-id-number/"));return(await l.Z.get(r,{params:{id_number:s}})).data}catch(e){if(console.error("檢查身份證號碼失敗:",e),e.response){if(404===e.response.status)return{exists:!1,patient:null};if(500===e.response.status)throw console.error("後端處理身份證號碼時出錯:",e.response.data),Error("系統處理身份證號碼時出錯，請稍後再試或聯絡客服")}throw e}}async function m(e){try{let s={...e};s.email&&""!==s.email&&"undefined"!==s.email&&("string"!=typeof s.email||""!==s.email.trim())||(console.log("API 調用前檢查: email 欄位為空，設置為 no@no.com"),s.email="no@no.com"),console.log("API 最終請求數據:",JSON.stringify(s));try{let e=await c(s.id_number);if(e.exists&&e.patient){console.log("患者已存在，更新現有記錄而非創建新記錄");let r=e.patient.id,t={chinese_name:s.chinese_name,english_name:s.english_name,birth_date:s.birth_date,phone_number:s.phone_number,email:s.email,gender:s.gender,basic_diseases:s.basic_diseases,drug_allergies:s.drug_allergies,food_allergies:s.food_allergies,note:s.note,doctor_id:s.doctor_id,data_source:s.data_source,region:s.region,district:s.district,sub_district:s.sub_district},o=await g(r,t);return console.log("✅ 患者資料更新成功:",o),o}}catch(e){console.log("檢查患者是否存在時出錯，嘗試直接創建:",e)}let r=n((0,a.l9)("/patient_registration/"));console.log("\uD83D\uDD37 提交患者數據到:",r);let t=await l.Z.post(r,s);return console.log("✅ 患者創建成功:",t.data),t.data}catch(r){if(console.error("❌ 創建患者失敗:",r),r.response&&409===r.response.status)try{let s=await c(e.id_number);if(s.exists&&s.patient){console.log("處理409衝突: 患者已存在，嘗試更新資料");let r=s.patient.id,t={chinese_name:e.chinese_name,english_name:e.english_name,birth_date:e.birth_date,phone_number:e.phone_number,email:e.email,gender:e.gender,basic_diseases:e.basic_diseases,drug_allergies:e.drug_allergies,food_allergies:e.food_allergies,note:e.note,doctor_id:e.doctor_id,data_source:e.data_source,region:e.region,district:e.district,sub_district:e.sub_district},o=await g(r,t);return console.log("✅ 成功處理409衝突並更新患者資料:",o),o}}catch(e){console.error("恢復409衝突時出錯:",e)}if(r.response&&422===r.response.status){let e=r.response.data?.detail||[],s={},t="資料驗證失敗";Array.isArray(e)?(e.forEach(e=>{if(e.loc&&Array.isArray(e.loc)&&e.loc.length>1){let r=e.loc.slice(1).join(".");s[r]=e.msg,console.error(`欄位 "${r}" 驗證失敗:`,e.msg)}}),Object.keys(s).length>0&&(t=`資料驗證失敗: ${Object.keys(s).map(e=>`${e} (${s[e]})`).join(", ")}`)):"object"==typeof r.response.data&&(t=r.response.data.detail||"資料驗證失敗，請檢查輸入",s=r.response.data);let o=Error(t);throw o.response=r.response,o.validationErrors=s,o.isValidationError=!0,o.status=422,o}if(r.response){console.error(`服務器回應 ${r.response.status} 錯誤:`,r.response.data);let e=Error(r.response.data?.detail||r.response.data?.message||`伺服器回應錯誤 (${r.response.status})`);throw e.response=r.response,e.status=r.response.status,e}let s=Error("連接伺服器失敗，請檢查網絡連接");throw s.isNetworkError=!0,s}}async function u(e){try{let s=e.replace(/[\s\-\(\)]/g,"");console.log("\uD83D\uDD0D 格式化後的電話號碼:",s);let r=n((0,a.l9)(`/patient_registration/by-phone-number/${s}/`));return(await l.Z.get(r)).data}catch(s){if(console.error(`通過電話號碼 ${e} 獲取患者失敗:`,s),s.response){if(404===s.response.status)throw Error(`未找到電話號碼為 ${e} 的患者記錄`);if(500===s.response.status)throw console.error("後端處理電話號碼時出錯:",s.response.data),Error("系統處理電話號碼時出錯，請稍後再試或聯絡客服");if(s.response.data&&s.response.data.detail)throw Error(s.response.data.detail)}throw Error("無法查詢電話號碼，請確認格式正確或稍後再試")}}async function g(e,s){try{let r=n((0,a.l9)(`/patient_registration/${e}/`));return(await l.Z.patch(r,s)).data}catch(s){throw console.error(`更新患者 ID ${e} 失敗:`,s),s}}let h=({regions:e,value:s,onChange:r,required:i=!1,readOnly:a=!1})=>{let[l,n]=(0,o.useState)([]),[d,c]=(0,o.useState)([]);return(0,o.useEffect)(()=>{if(s.region&&e[s.region]){let t=Object.keys(e[s.region]);n(t),t.length>0&&!t.includes(s.district)&&r({...s,district:"",subDistrict:""})}else n([]),c([])},[s.region,e]),(0,o.useEffect)(()=>{if(s.region&&s.district&&e[s.region]&&e[s.region][s.district]){let t=e[s.region][s.district];c(t),t.length>0&&!t.includes(s.subDistrict)&&r({...s,subDistrict:""})}else c([])},[s.region,s.district,e]),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["區域 ",i&&t.jsx("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{value:s.region,onChange:e=>{r({region:e.target.value,district:"",subDistrict:""})},className:`mt-1 block w-full px-3 py-2 ${a?"bg-gray-100":"bg-white"} border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,required:i,disabled:a,children:[t.jsx("option",{value:"",children:"請選擇區域"}),Object.keys(e).map(e=>t.jsx("option",{value:e,children:e},e))]})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["地區 ",i&&t.jsx("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{value:s.district,onChange:e=>{r({...s,district:e.target.value,subDistrict:""})},className:`mt-1 block w-full px-3 py-2 ${a?"bg-gray-100":"bg-white"} border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,disabled:a||!s.region||0===l.length,required:i,children:[t.jsx("option",{value:"",children:"請選擇地區"}),l.map(e=>t.jsx("option",{value:e,children:e},e))]})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["細分地區 ",i&&t.jsx("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{value:s.subDistrict,onChange:e=>{r({...s,subDistrict:e.target.value})},className:`mt-1 block w-full px-3 py-2 ${a?"bg-gray-100":"bg-white"} border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,disabled:a||!s.district||0===d.length,required:i,children:[t.jsx("option",{value:"",children:"請選擇細分地區"}),d.map(e=>t.jsx("option",{value:e,children:e},e))]})]})]})};class x extends o.Component{constructor(e){super(e),this.state={hasError:!1,error:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,s){console.error("PatientForm 錯誤邊界捕獲到錯誤:",e,s)}render(){return this.state.hasError?this.props.fallback?this.props.fallback:(0,t.jsxs)("div",{className:"p-4 bg-red-50 border border-red-200 rounded-md text-red-700",children:[t.jsx("h3",{className:"text-lg font-medium mb-2",children:"發生錯誤"}),t.jsx("p",{className:"mb-4",children:"很抱歉，表單處理過程中發生錯誤。"}),(0,t.jsxs)("details",{className:"text-sm text-red-600",children:[t.jsx("summary",{children:"錯誤詳情"}),t.jsx("pre",{className:"mt-2 whitespace-pre-wrap",children:this.state.error?.toString()})]}),t.jsx("button",{onClick:()=>window.location.reload(),className:"mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"重新載入頁面"})]}):this.props.children}}let b=()=>{(0,i.useRouter)();let[e,s]=(0,o.useState)(!1),[r,l]=(0,o.useState)(null),[n,g]=(0,o.useState)(null),[b,p]=(0,o.useState)(!0),[f,_]=(0,o.useState)(""),[y,j]=(0,o.useState)(!1),[v,w]=(0,o.useState)(null),[N,k]=(0,o.useState)(!1),[$,D]=(0,o.useState)(!1),[C,A]=(0,o.useState)(!1),[E,P]=(0,o.useState)(""),[q,S]=(0,o.useState)(""),[W,O]=(0,o.useState)(""),[I,T]=(0,o.useState)({chinese_name:"",english_name:"",id_number:"",birth_date:"",phone_number:"",email:"no@no.com",gender:"",basic_diseases:["我沒有任何基礎病"],drug_allergies:["我沒有任何藥物過敏"],food_allergies:["我沒有任何食物過敏"],note:"",has_appointment:!1,doctor_id:void 0,data_source:"",region:"",district:"",sub_district:"",chief_complaint:""});(0,o.useEffect)(()=>{(async()=>{try{if("serviceWorker"in navigator)try{navigator.serviceWorker.getRegistrations().then(e=>{e.forEach(e=>{console.log("\uD83E\uDDF9 清除 Service Worker 緩存:",e),e.unregister()})})}catch(e){console.warn("無法清除 Service Worker 緩存:",e)}let e=(0,a.l9)("/patient_registration/reference-data/");console.log("\uD83D\uDD0D 測試 URL 生成:",e),console.log("\uD83D\uDD0D window.location.origin =",window.location.origin),console.log("\uD83D\uDD0D window.location.protocol =",window.location.protocol),e.startsWith("http:")&&console.error("⛔ URL 協議錯誤，使用了 HTTP:",e),console.log("\uD83D\uDD52 正在請求參考數據，時間戳:",new Date().toISOString());let s=await d();console.log("✅ 成功獲取參考數據!",s);let r=s.doctors;if(!r||!Array.isArray(r)||0===r.length){console.warn("⚠️ 未能從 API 獲取醫師數據，嘗試獲取緊急備用方案");try{r=[{id:1,name:"郭鎮峰",specialty:"中醫師"}],console.log("✅ 使用硬編碼的醫師資料:",r),s.doctors=r}catch(e){console.error("❌ 緊急備用方案失敗:",e)}}s.doctors&&s.doctors.length>0?console.log("\uD83D\uDC68‍⚕️ 成功載入醫師數據:",s.doctors):console.warn("⚠️ 醫師數據為空或不存在:",s.doctors),g(s)}catch(s){console.error("❌ 獲取參考數據失敗:",s),s instanceof Error&&(console.error("錯誤名稱:",s.name),console.error("錯誤訊息:",s.message),console.error("錯誤堆疊:",s.stack));let e={basic_diseases:["我沒有任何基礎病","高血壓","糖尿病","心臟病","其他，請列明"],drug_allergies:["我沒有任何藥物過敏","青黴素","非類固醇消炎藥","其他藥物，請列明"],food_allergies:["我沒有任何食物過敏","海鮮","堅果","其他食物，請列明"],data_sources:["朋友介紹","網絡","Instagram","Facebook"],regions:{香港:{中西區:["中環","上環"]}},doctors:[{id:1,name:"郭鎮峰",specialty:"中醫師"}]};console.log("\uD83D\uDD04 使用後備參考資料:",e),g(e),l({type:"error",text:"無法加載參考數據，已使用基本資料。您可以繼續填寫表單，但若無法提交請刷新頁面重試。"})}})()},[]),(0,o.useEffect)(()=>{let e=async()=>{if(I.id_number.length>=8)try{(await c(I.id_number)).exists?l({type:"error",text:"此身份證/護照號碼已存在，請選擇複診或修改號碼。"}):l(null)}catch(e){console.error("檢查患者錯誤:",e)}};if(b){let s=setTimeout(e,500);return()=>clearTimeout(s)}},[I.id_number,b]);let H=e=>{let{name:s,value:r}=e.target;T(e=>({...e,[s]:r}))},U=(e,s,r)=>{console.log(`複選框變更: ${e}, ${s}, ${r}`),T(t=>{let o=[...t[e]],i=s.includes("我沒有"),a=s.includes("其他");return r?i?(o=[s],"basic_diseases"===e?P(""):"drug_allergies"===e?S(""):"food_allergies"===e&&O("")):(o=o.filter(e=>!e.includes("我沒有"))).push(s):(o=o.filter(e=>e!==s),a&&("basic_diseases"===e?P(""):"drug_allergies"===e?S(""):"food_allergies"===e&&O("")),0===o.length&&(o="basic_diseases"===e?["我沒有任何基礎病"]:"drug_allergies"===e?["我沒有任何藥物過敏"]:["我沒有任何食物過敏"])),console.log(`${e} 最終選項:`,o),{...t,[e]:o}})},z=(e,s)=>{let r="basic_diseases"===e?"其他，請列明":"drug_allergies"===e?"其他藥物，請列明":"其他食物，請列明";console.log(`其他選項輸入變更: ${e}, "${r}", 值: "${s}"`),"basic_diseases"===e?P(s):"drug_allergies"===e?S(s):O(s),I[e].includes(r)||(console.log(`強制將 "${r}" 選項添加到 ${e}`),T(s=>{let t=s[e].filter(e=>!e.includes("我沒有"));return t.includes(r)?s:{...s,[e]:[...t,r]}}))},M=e=>{p(e),e?(T({chinese_name:"",english_name:"",id_number:"",birth_date:"",phone_number:"",email:"no@no.com",gender:"",basic_diseases:["我沒有任何基礎病"],drug_allergies:["我沒有任何藥物過敏"],food_allergies:["我沒有任何食物過敏"],note:"",has_appointment:!1,doctor_id:void 0,data_source:"",region:"",district:"",sub_district:"",chief_complaint:""}),P(""),S(""),O(""),l(null),j(!1),k(!1),D(!1),A(!1)):(_(""),l({type:"info",text:"請輸入身份證號碼或電話號碼查詢現有患者"}),setTimeout(()=>{let e=document.getElementById("patient-search");e&&e.focus()},100))},L=async()=>{if(!f||f.length<5){l({type:"error",text:"請輸入有效的身份證號碼或電話號碼"});return}s(!0);try{let e;if(/^\d+$/.test(f))e=await u(f);else{let s=await c(f);if(s.exists&&s.patient)e=s.patient;else throw Error("找不到此身份證對應的患者記錄")}T({chinese_name:e.chinese_name,english_name:e.english_name,id_number:e.id_number,birth_date:e.birth_date,phone_number:e.phone_number,email:e.email||"",gender:e.gender||"",basic_diseases:e.basic_diseases,drug_allergies:e.drug_allergies,food_allergies:e.food_allergies,note:e.note||"",has_appointment:e.has_appointment,doctor_id:e.doctor_id,data_source:e.data_source,region:e.region,district:e.district,sub_district:e.sub_district,chief_complaint:e.chief_complaint||""}),V(e.basic_diseases,"basic_diseases"),V(e.drug_allergies,"drug_allergies"),V(e.food_allergies,"food_allergies"),k(!e.basic_diseases.some(e=>e.includes("我沒有"))),D(!e.drug_allergies.some(e=>e.includes("我沒有"))),A(!e.food_allergies.some(e=>e.includes("我沒有"))),j(!0),l({type:"success",text:`已找到患者: ${e.chinese_name} (${e.registration_number})`})}catch(e){console.error("查詢患者失敗:",e),l({type:"error",text:e.message||"無法找到患者記錄，請檢查輸入或轉為初診"})}finally{s(!1)}},V=(e,s)=>{let r=e.find(e=>e.startsWith("其他:")||e.startsWith("其他，請列明:")||e.startsWith("其他藥物:")||e.startsWith("其他食物:"));if(!r)return;let t="";r.startsWith("其他:")?t=r.replace("其他:","").trim():r.startsWith("其他，請列明:")?t=r.replace("其他，請列明:","").trim():r.startsWith("其他藥物:")?t=r.replace("其他藥物:","").trim():r.startsWith("其他食物:")&&(t=r.replace("其他食物:","").trim()),"basic_diseases"===s?(P(t),T(e=>({...e,[s]:[...e[s].filter(e=>!e.startsWith("其他:")&&!e.startsWith("其他，請列明:")),"其他疾病，請列明"]}))):"drug_allergies"===s?(S(t),T(e=>({...e,[s]:[...e[s].filter(e=>!e.startsWith("其他藥物:")&&!e.startsWith("其他，請列明:")),"其他藥物，請列明"]}))):"food_allergies"===s&&(O(t),T(e=>({...e,[s]:[...e[s].filter(e=>!e.startsWith("其他食物:")&&!e.startsWith("其他，請列明:")),"其他食物，請列明"]})))},R=async e=>{e.preventDefault(),s(!0),l(null),w(null);try{if(!I.doctor_id){l({type:"error",text:"請選擇醫師"}),s(!1);return}let e=["chinese_name","english_name","id_number","birth_date","phone_number","data_source","region","district","sub_district"].filter(e=>!I[e]);if(e.length>0){l({type:"error",text:`以下欄位為必填: ${e.join(", ")}`}),s(!1);return}if(!/^[\u4e00-\u9fa5]{2,10}$/.test(I.chinese_name)){l({type:"error",text:"中文姓名必須為2-10個中文字"}),s(!1);return}if(!/^[A-Za-z\s]+$/.test(I.english_name)){l({type:"error",text:"英文姓名只能包含英文字母和空格"}),s(!1);return}let r={...I};if(console.log("處理 email 之前:",r.email,typeof r.email),void 0===r.email||null===r.email||""===r.email||"undefined"===r.email||"string"==typeof r.email&&""===r.email.trim()?(console.log("Email 欄位無效，設置為 no@no.com"),r.email="no@no.com"):"string"!=typeof r.email||/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r.email)||(console.log("Email 格式不正確:",r.email),console.log("自動轉換為 no@no.com"),r.email="no@no.com"),console.log("處理 email 之後:",r.email),r.basic_diseases.includes("其他，請列明")&&E.trim()){let e=[...r.basic_diseases],s=e.indexOf("其他，請列明");-1!==s&&(e[s]=`其他，請列明: ${E.trim()}`,r.basic_diseases=e)}else r.basic_diseases.includes("其他，請列明")&&(r.basic_diseases=r.basic_diseases.filter(e=>"其他，請列明"!==e),0===r.basic_diseases.length&&(r.basic_diseases=["我沒有任何基礎病"]));if(r.drug_allergies.includes("其他藥物，請列明")&&q.trim()){let e=[...r.drug_allergies],s=e.indexOf("其他藥物，請列明");-1!==s&&(e[s]=`其他藥物: ${q.trim()}`,r.drug_allergies=e)}else r.drug_allergies.includes("其他藥物，請列明")&&(r.drug_allergies=r.drug_allergies.filter(e=>"其他藥物，請列明"!==e),0===r.drug_allergies.length&&(r.drug_allergies=["我沒有任何藥物過敏"]));if(r.food_allergies.includes("其他食物，請列明")&&W.trim()){let e=[...r.food_allergies],s=e.indexOf("其他食物，請列明");-1!==s&&(e[s]=`其他食物: ${W.trim()}`,r.food_allergies=e)}else r.food_allergies.includes("其他食物，請列明")&&(r.food_allergies=r.food_allergies.filter(e=>"其他食物，請列明"!==e),0===r.food_allergies.length&&(r.food_allergies=["我沒有任何食物過敏"]));console.log("✅ 嘗試提交表單數據:",JSON.stringify(r)),console.log("確認 Email 值:",r.email),r.email&&""!==r.email&&"string"==typeof r.email||(r.email="no@no.com",console.log("最終安全檢查: 設置 email 為 no@no.com"));let t=await m(r);console.log("✅ 患者創建成功:",t);let o=n?.doctors?.find(e=>e.id===I.doctor_id)?.name||"未知醫師";w({chinese_name:I.chinese_name,registration_number:t.registration_number,doctor_name:o,registration_time:new Date().toLocaleString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}),l({type:"success",text:`患者登記成功！掛號編號: ${t.registration_number}`}),j(!1),P(""),S(""),O("")}catch(e){if(console.error("❌ 提交患者登記表單錯誤:",e),e.isValidationError||e.response&&422===e.response.status){if(e.validationErrors&&Object.keys(e.validationErrors).length>0){let s=Object.entries(e.validationErrors).map(([e,s])=>`${e}: ${s}`).join("\n");l({type:"error",text:`請檢查以下欄位:
${s}`})}else if(e.response?.data?.detail){let s="";s=Array.isArray(e.response.data.detail)?e.response.data.detail.map(e=>{let s=e.loc&&e.loc.length>1?e.loc.slice(1).join("."):"未知欄位";return`${s}: ${e.msg}`}).join("\n"):e.response.data.detail,l({type:"error",text:`資料驗證失敗:
${s}`})}else l({type:"error",text:e.message||"資料驗證失敗，請檢查輸入"})}else e.isNetworkError?l({type:"error",text:"連接伺服器失敗，請檢查網絡連接並稍後再試"}):e.response?l({type:"error",text:`伺服器錯誤 (${e.response.status}): ${e.response.data?.detail||e.response.data?.message||e.message||"請稍後再試"}`}):l({type:"error",text:`錯誤: ${e.message||"提交表單時發生未知錯誤"}`})}finally{s(!1)}};return((0,o.useEffect)(()=>{console.log("當前表單狀態:"),console.log("- 基礎疾病:",I.basic_diseases),console.log("- 藥物過敏:",I.drug_allergies),console.log("- 食物過敏:",I.food_allergies),console.log("- 其他基礎疾病值:",E),console.log("- 其他藥物過敏值:",q),console.log("- 其他食物過敏值:",W)},[I.basic_diseases,I.drug_allergies,I.food_allergies,E,q,W]),(0,o.useEffect)(()=>{let e=I.drug_allergies.includes("其他藥物，請列明"),s=I.food_allergies.includes("其他食物，請列明");console.log("渲染檢查:"),console.log("- 藥物過敏包含「其他」選項:",e),console.log("- 食物過敏包含「其他」選項:",s),n&&console.log("- 醫師列表狀態:",n.doctors?`有效 (${Array.isArray(n.doctors)?n.doctors.length:"非數組"})`:"無效")},[I.drug_allergies,I.food_allergies,n]),(0,o.useEffect)(()=>{if(console.log("初始化頁面狀態:"),console.log("- 參考資料:",n),console.log("- 表單數據:",I),n&&(!n.doctors||!Array.isArray(n.doctors)||0===n.doctors.length)){console.warn("⚠️ 醫師資料加載失敗，嘗試重新載入");let e=setTimeout(async()=>{try{console.log("\uD83D\uDD04 自動重試載入醫師資料");let e=await d();e.doctors&&Array.isArray(e.doctors)&&e.doctors.length>0?(console.log("✅ 重試成功，載入了醫師資料:",e.doctors),g(e),l({type:"success",text:"醫師資料已自動更新"})):(console.error("❌ 重試後仍無法獲取醫師資料"),l({type:"error",text:"無法載入醫師資料，請點擊「重新載入醫師資料」按鈕嘗試手動更新"}))}catch(e){console.error("❌ 自動重試載入醫師資料失敗:",e)}},3e3);return()=>clearTimeout(e)}},[n]),n)?t.jsx(x,{children:t.jsx("div",{className:"bg-white shadow-md rounded-lg p-6",children:v?v?(0,t.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[(0,t.jsxs)("div",{className:"flex items-center text-green-600 mb-4",children:[t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-8 w-8 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}),t.jsx("h2",{className:"text-xl font-semibold",children:"掛號成功"})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[(0,t.jsxs)("div",{children:[t.jsx("p",{className:"text-gray-600",children:"患者姓名"}),t.jsx("p",{className:"font-medium",children:v.chinese_name})]}),(0,t.jsxs)("div",{children:[t.jsx("p",{className:"text-gray-600",children:"掛號編號"}),t.jsx("p",{className:"font-medium",children:v.registration_number})]}),(0,t.jsxs)("div",{children:[t.jsx("p",{className:"text-gray-600",children:"主診醫師"}),t.jsx("p",{className:"font-medium",children:v.doctor_name||"未指定"})]}),(0,t.jsxs)("div",{children:[t.jsx("p",{className:"text-gray-600",children:"登記時間"}),t.jsx("p",{className:"font-medium",children:v.registration_time})]})]}),(0,t.jsxs)("div",{className:"flex flex-wrap gap-3 mt-6",children:[t.jsx("button",{onClick:()=>{T({chinese_name:"",english_name:"",id_number:"",birth_date:"",phone_number:"",email:"no@no.com",gender:"",basic_diseases:["我沒有任何基礎病"],drug_allergies:["我沒有任何藥物過敏"],food_allergies:["我沒有任何食物過敏"],note:"",has_appointment:!1,doctor_id:void 0,data_source:"",region:"",district:"",sub_district:"",chief_complaint:""}),k(!1),D(!1),A(!1),w(null)},className:"flex-1 min-w-[120px] py-2 px-4 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors",children:"再登記一位病人"}),t.jsx("a",{href:`/appointments?patient_name=${encodeURIComponent(v.chinese_name)}&phone_number=${encodeURIComponent(I.phone_number)}`,className:"flex-1 min-w-[120px] py-2 px-4 bg-orange-500 text-white rounded hover:bg-orange-600 transition-colors text-center",children:"為此患者預約"}),t.jsx("a",{href:"/medical_record",className:"flex-1 min-w-[120px] py-2 px-4 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors text-center",children:"前往病歷系統"})]})]}):null:(0,t.jsxs)("form",{onSubmit:R,children:[r&&t.jsx("div",{className:`mb-4 p-3 rounded-md ${"error"===r.type?"bg-red-50 text-red-700 border border-red-200":"success"===r.type?"bg-green-50 text-green-700 border border-green-200":"bg-blue-50 text-blue-700 border border-blue-200"}`,children:t.jsx("p",{className:"whitespace-pre-line",children:r.text})}),(0,t.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[t.jsx("div",{className:"text-lg font-bold",children:"患者登記表"}),(0,t.jsxs)("div",{className:"flex space-x-2",children:[t.jsx("button",{type:"button",className:`px-4 py-2 rounded-md ${b?"bg-blue-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,onClick:()=>M(!0),children:"初診"}),t.jsx("button",{type:"button",className:`px-4 py-2 rounded-md ${b?"bg-gray-200 text-gray-700 hover:bg-gray-300":"bg-blue-600 text-white"}`,onClick:()=>M(!1),children:"複診"})]})]}),!b&&(0,t.jsxs)("div",{className:"mb-6 p-4 bg-blue-50 rounded-md border border-blue-200",children:[t.jsx("div",{className:"text-blue-700 mb-2",children:"覆診病人需先輸入身份證或電話搜尋現有紀錄"}),(0,t.jsxs)("div",{className:"flex gap-2",children:[t.jsx("input",{id:"patient-search",type:"text",value:f,onChange:e=>_(e.target.value),placeholder:"輸入身份證號碼或電話號碼",className:"flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"}),t.jsx("button",{type:"button",onClick:L,disabled:e,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-blue-300",children:e?"搜尋中...":"搜尋"})]})]}),!b&&y&&t.jsx("div",{className:"mb-4 flex justify-end",children:(0,t.jsxs)("button",{type:"button",onClick:()=>{j(!1),l({type:"info",text:"您現在可以編輯患者資料"})},className:"px-3 py-1 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 flex items-center text-sm",children:[t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 mr-1",viewBox:"0 0 20 20",fill:"currentColor",children:t.jsx("path",{d:"M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"})}),"重新編輯"]})}),t.jsx("h2",{className:"text-xl font-bold mb-4",children:"基本資料"}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["中文姓名 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsx("input",{type:"text",name:"chinese_name",value:I.chinese_name,onChange:H,readOnly:y,className:`mt-1 block w-full px-3 py-2 border ${y?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,required:!0})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["英文姓名 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsx("input",{type:"text",name:"english_name",value:I.english_name,onChange:H,readOnly:y,className:`mt-1 block w-full px-3 py-2 border ${y?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,required:!0})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["身份證號碼 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsx("input",{type:"text",name:"id_number",value:I.id_number,onChange:H,readOnly:y,className:`mt-1 block w-full px-3 py-2 border ${y?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,required:!0})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["出生日期 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsx("input",{type:"date",name:"birth_date",value:I.birth_date,onChange:H,readOnly:y,className:`mt-1 block w-full px-3 py-2 border ${y?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,required:!0})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["手機號碼 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsx("input",{type:"tel",name:"phone_number",value:I.phone_number,onChange:H,readOnly:y,className:`mt-1 block w-full px-3 py-2 border ${y?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,required:!0})]}),(0,t.jsxs)("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"電子郵件 (選填)"}),t.jsx("input",{type:"email",name:"email",value:"no@no.com"===I.email?"":I.email,onChange:H,readOnly:y,className:`mt-1 block w-full px-3 py-2 border ${y?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,placeholder:"輸入電子郵件或留空"})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["性別 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{name:"gender",value:I.gender,onChange:H,required:!0,className:"mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",children:[t.jsx("option",{value:"",children:"請選擇"}),t.jsx("option",{value:"男",children:"男"}),t.jsx("option",{value:"女",children:"女"}),t.jsx("option",{value:"其他",children:"其他"})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["從何得知本診所 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{name:"data_source",value:I.data_source,onChange:H,disabled:y,className:`mt-1 block w-full px-3 py-2 border ${y?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,required:!0,children:[t.jsx("option",{value:"",children:"請選擇"}),n.data_sources.map(e=>t.jsx("option",{value:e,children:e},e))]})]})]}),t.jsx("h2",{className:"text-xl font-bold mb-4",children:"居住地區"}),t.jsx("div",{className:"mb-6",children:t.jsx(h,{regions:n.regions,onChange:e=>{T(s=>({...s,region:e.region,district:e.district,sub_district:e.subDistrict}))},value:{region:I.region,district:I.district,subDistrict:I.sub_district},required:!0,readOnly:y})}),t.jsx("h2",{className:"text-xl font-bold mb-4",children:"健康資訊"}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["是否有基礎疾病 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{name:"has_basic_disease",value:N?"是":"否",onChange:e=>{let s="是"===e.target.value;k(s),s||(T(e=>({...e,basic_diseases:["我沒有任何基礎病"]})),P(""))},disabled:y,className:`mt-1 block w-full px-3 py-2 border ${y?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,required:!0,children:[t.jsx("option",{value:"",children:"請選擇"}),t.jsx("option",{value:"是",children:"是"}),t.jsx("option",{value:"否",children:"否"})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["是否有藥物過敏 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{name:"has_drug_allergy",value:$?"是":"否",onChange:e=>{let s="是"===e.target.value;D(s),s||(T(e=>({...e,drug_allergies:["我沒有任何藥物過敏"]})),S(""))},disabled:y,className:`mt-1 block w-full px-3 py-2 border ${y?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,required:!0,children:[t.jsx("option",{value:"",children:"請選擇"}),t.jsx("option",{value:"是",children:"是"}),t.jsx("option",{value:"否",children:"否"})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["是否有食物過敏 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{name:"has_food_allergy",value:C?"是":"否",onChange:e=>{let s="是"===e.target.value;A(s),s||(T(e=>({...e,food_allergies:["我沒有任何食物過敏"]})),O(""))},disabled:y,className:`mt-1 block w-full px-3 py-2 border ${y?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,required:!0,children:[t.jsx("option",{value:"",children:"請選擇"}),t.jsx("option",{value:"是",children:"是"}),t.jsx("option",{value:"否",children:"否"})]})]})]}),N&&(0,t.jsxs)("div",{className:"mb-6 p-4 bg-gray-50 rounded-md border border-gray-200",children:[t.jsx("div",{className:"mb-2 font-medium",children:"請選擇基礎疾病（可多選）"}),t.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2 mb-3",children:n.basic_diseases.filter(e=>!e.includes("我沒有")).map((e,s)=>(0,t.jsxs)("label",{className:"inline-flex items-center",children:[t.jsx("input",{type:"checkbox",checked:I.basic_diseases.includes(e),onChange:s=>U("basic_diseases",e,s.target.checked),disabled:y,className:"h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"}),t.jsx("span",{className:"ml-2 text-sm text-gray-700",children:e})]},`basic_disease_${s}`))}),I.basic_diseases.includes("其他，請列明")&&(0,t.jsxs)("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"其他基礎疾病，請列明"}),t.jsx("input",{type:"text",value:E,onChange:e=>z("basic_diseases",e.target.value),disabled:y,className:`mt-1 block w-full px-3 py-2 border ${y?"bg-gray-100":"bg-gray-50"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,placeholder:"請詳細說明其他基礎疾病"}),I.basic_diseases.includes("其他，請列明")&&!E&&t.jsx("p",{className:"text-sm text-red-600 mt-1",children:"請填寫基礎疾病細節"})]})]}),$&&(0,t.jsxs)("div",{className:"mb-6 p-4 bg-gray-50 rounded-md border border-gray-200",children:[t.jsx("div",{className:"mb-2 font-medium",children:"請選擇藥物過敏（可多選）"}),t.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2 mb-3",children:n.drug_allergies.filter(e=>!e.includes("我沒有")).map((e,s)=>(0,t.jsxs)("label",{className:"inline-flex items-center",children:[t.jsx("input",{type:"checkbox",checked:I.drug_allergies.includes(e),onChange:s=>U("drug_allergies",e,s.target.checked),disabled:y,className:"h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"}),t.jsx("span",{className:"ml-2 text-sm text-gray-700",children:e})]},`drug_allergy_${s}`))}),I.drug_allergies.includes("其他藥物，請列明")&&(0,t.jsxs)("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"其他藥物過敏，請列明"}),t.jsx("input",{type:"text",value:q,onChange:e=>z("drug_allergies",e.target.value),disabled:y,className:`mt-1 block w-full px-3 py-2 border ${y?"bg-gray-100":"bg-gray-50"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,placeholder:"請詳細說明其他藥物過敏"}),I.drug_allergies.includes("其他藥物，請列明")&&!q&&t.jsx("p",{className:"text-sm text-red-600 mt-1",children:"請填寫藥物過敏細節"})]})]}),C&&(0,t.jsxs)("div",{className:"mb-6 p-4 bg-gray-50 rounded-md border border-gray-200",children:[t.jsx("div",{className:"mb-2 font-medium",children:"請選擇食物過敏（可多選）"}),t.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2 mb-3",children:n.food_allergies.filter(e=>!e.includes("我沒有")).map((e,s)=>(0,t.jsxs)("label",{className:"inline-flex items-center",children:[t.jsx("input",{type:"checkbox",checked:I.food_allergies.includes(e),onChange:s=>U("food_allergies",e,s.target.checked),disabled:y,className:"h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"}),t.jsx("span",{className:"ml-2 text-sm text-gray-700",children:e})]},`food_allergy_${s}`))}),I.food_allergies.includes("其他食物，請列明")&&(0,t.jsxs)("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"其他食物過敏，請列明"}),t.jsx("input",{type:"text",value:W,onChange:e=>z("food_allergies",e.target.value),disabled:y,className:`mt-1 block w-full px-3 py-2 border ${y?"bg-gray-100":"bg-gray-50"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,placeholder:"請詳細說明其他食物過敏"}),I.food_allergies.includes("其他食物，請列明")&&!W&&t.jsx("p",{className:"text-sm text-red-600 mt-1",children:"請填寫食物過敏細節"})]})]}),(0,t.jsxs)("div",{className:"mb-6",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"備註（選填）"}),t.jsx("textarea",{name:"note",value:I.note,onChange:H,disabled:y,rows:3,className:`mt-1 block w-full px-3 py-2 border ${y?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,placeholder:"例如：偏好女醫師，懂英語，請準備輪椅"})]}),(0,t.jsxs)("div",{className:"mb-6",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"自述主訴（選填）"}),t.jsx("textarea",{name:"chief_complaint",value:I.chief_complaint,onChange:H,disabled:y,rows:3,className:`mt-1 block w-full px-3 py-2 border ${y?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,placeholder:"請簡述您的不適或求診原因"})]}),t.jsx("h2",{className:"text-xl font-bold mb-4",children:"診所資訊"}),(0,t.jsxs)("div",{className:"mb-6",children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["主診醫師 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{name:"doctor_id",value:I.doctor_id?.toString()||"",onChange:e=>{let s=e.target.value?parseInt(e.target.value,10):void 0;T(e=>({...e,doctor_id:s}))},className:"mt-1 block w-full px-3 py-2 border bg-white border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",required:!0,children:[t.jsx("option",{value:"",children:"請選擇醫師"}),n.doctors?.map(e=>t.jsxs("option",{value:e.id.toString(),children:[e.name," ",e.specialty?`(${e.specialty})`:""]},e.id))]})]}),t.jsx("div",{className:"flex justify-end",children:t.jsx("button",{type:"submit",disabled:e,className:"px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-300 flex items-center",children:e?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("svg",{className:"animate-spin -ml-1 mr-2 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[t.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),t.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"處理中..."]}):"提交表單"})})]})})}):(0,t.jsxs)("div",{className:"p-6 bg-white rounded-lg shadow-md",children:[t.jsx("div",{className:"flex items-center justify-center h-40",children:(0,t.jsxs)("div",{className:"animate-pulse flex flex-col items-center",children:[t.jsx("div",{className:"h-12 w-12 rounded-full bg-blue-200 mb-4"}),t.jsx("div",{className:"h-4 w-48 bg-blue-200 rounded mb-2"}),t.jsx("div",{className:"h-3 w-32 bg-blue-100 rounded"})]})}),t.jsx("p",{className:"text-center text-gray-500 mt-4",children:"載入中，請稍候..."})]})};class p extends o.Component{constructor(e){super(e),this.state={hasError:!1,error:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,s){console.error("患者登記頁面錯誤:",e,s)}render(){return this.state.hasError?t.jsx("div",{className:"container mx-auto py-8 px-4",children:(0,t.jsxs)("div",{className:"max-w-4xl mx-auto p-8 bg-red-50 border border-red-200 rounded-lg shadow text-red-800",children:[t.jsx("h2",{className:"text-2xl font-bold mb-4",children:"頁面載入錯誤"}),t.jsx("p",{className:"mb-4",children:"很抱歉，患者登記系統暫時無法使用，請稍後再試。"}),(0,t.jsxs)("details",{className:"mb-4",children:[t.jsx("summary",{className:"cursor-pointer font-medium",children:"技術詳情"}),t.jsx("pre",{className:"mt-2 p-4 bg-red-100 rounded text-sm overflow-auto",children:this.state.error?.toString()})]}),(0,t.jsxs)("div",{className:"flex gap-4",children:[t.jsx("button",{onClick:()=>window.location.reload(),className:"px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"重新載入"}),t.jsx("a",{href:"/appointments",className:"px-6 py-2 bg-gray-600 text-white rounded hover:bg-gray-700",children:"返回預約系統"})]})]})}):this.props.children}}function f(){return t.jsx(p,{children:(0,t.jsxs)("div",{className:"container mx-auto py-8 px-4",children:[t.jsx("h1",{className:"text-3xl font-bold text-center mb-8",children:"患者登記系統"}),t.jsx(b,{})]})})}},984:(e,s,r)=>{"use strict";r.d(s,{l9:()=>o});var t=r(7665);let o=(e="")=>{let s=e.startsWith("/")?e:`/${e}`;return`https://clinic.aspiratcm.com/api/v1${s}`},i=t.Z.create({baseURL:o(),headers:{"Content-Type":"application/json",Accept:"application/json"},timeout:15e3});i.interceptors.request.use(e=>{if(console.log(`[API請求] ${e.method?.toUpperCase()} ${e.url}`),e.params&&console.log(`[請求參數] ${JSON.stringify(e.params)}`),e.data&&"string"!=typeof e.data)try{console.log(`[請求數據] ${JSON.stringify(e.data)}`)}catch{console.log("[請求數據] 無法序列化")}return e},e=>(console.error("[API請求錯誤]",e),Promise.reject(e))),i.interceptors.response.use(e=>(console.log(`[API響應] ${e.status} ${e.config.url}`),e),e=>{let s=e?.response?.status,r=e?.config?.url,t=e?.config?.method?.toUpperCase();return s?console.error(`[${t} ${r}] 錯誤 ${s}`,e.response.data):console.error("[API錯誤]",e.message),Promise.reject(e)})},1334:(e,s,r)=>{"use strict";r.r(s),r.d(s,{default:()=>d,metadata:()=>n});var t=r(5036);r(5023);let o=(0,r(6843).createProxy)(String.raw`/Users/mountainfung/Desktop/AWS-Aspiratcm_local/frontend/src/app/components/Navbar.tsx`),{__esModule:i,$$typeof:a}=o,l=o.default,n={title:"中醫診所管理系統",description:"診所預約管理系統"};function d({children:e}){return t.jsx("html",{lang:"zh-TW",children:(0,t.jsxs)("body",{suppressHydrationWarning:!0,className:"bg-gray-100 min-h-screen antialiased text-slate-800 font-sans",children:[t.jsx(l,{}),t.jsx("div",{className:"pt-16",children:e})]})})}},9692:(e,s,r)=>{"use strict";r.r(s),r.d(s,{$$typeof:()=>i,__esModule:()=>o,default:()=>a});let t=(0,r(6843).createProxy)(String.raw`/Users/mountainfung/Desktop/AWS-Aspiratcm_local/frontend/src/app/patient_registration/page.tsx`),{__esModule:o,$$typeof:i}=t,a=t.default},5023:()=>{}};var s=require("../../webpack-runtime.js");s.C(e);var r=e=>s(s.s=e),t=s.X(0,[638,173,665],()=>r(4599));module.exports=t})();