(()=>{var e={};e.id=6530,e.ids=[6530],e.modules={47849:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external")},72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},55403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},94749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},39491:e=>{"use strict";e.exports=require("assert")},6113:e=>{"use strict";e.exports=require("crypto")},82361:e=>{"use strict";e.exports=require("events")},57147:e=>{"use strict";e.exports=require("fs")},13685:e=>{"use strict";e.exports=require("http")},95687:e=>{"use strict";e.exports=require("https")},22037:e=>{"use strict";e.exports=require("os")},71017:e=>{"use strict";e.exports=require("path")},12781:e=>{"use strict";e.exports=require("stream")},76224:e=>{"use strict";e.exports=require("tty")},57310:e=>{"use strict";e.exports=require("url")},73837:e=>{"use strict";e.exports=require("util")},59796:e=>{"use strict";e.exports=require("zlib")},4599:(e,s,r)=>{"use strict";r.r(s),r.d(s,{GlobalError:()=>a.a,__next_app__:()=>m,originalPathname:()=>u,pages:()=>c,routeModule:()=>g,tree:()=>d});var t=r(50482),o=r(69108),i=r(62563),a=r.n(i),l=r(68300),n={};for(let e in l)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(n[e]=()=>l[e]);r.d(s,n);let d=["",{children:["patient_registration",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(r.bind(r,19692)),"/Users/mountainfung/Desktop/AWS-Aspiratcm_local/frontend/src/app/patient_registration/page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(r.bind(r,61334)),"/Users/mountainfung/Desktop/AWS-Aspiratcm_local/frontend/src/app/layout.tsx"],"not-found":[()=>Promise.resolve().then(r.t.bind(r,69361,23)),"next/dist/client/components/not-found-error"]}],c=["/Users/mountainfung/Desktop/AWS-Aspiratcm_local/frontend/src/app/patient_registration/page.tsx"],u="/patient_registration/page",m={require:r,loadChunk:()=>Promise.resolve()},g=new t.AppPageRouteModule({definition:{kind:o.x.APP_PAGE,page:"/patient_registration/page",pathname:"/patient_registration",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:d}})},13654:(e,s,r)=>{Promise.resolve().then(r.t.bind(r,2583,23)),Promise.resolve().then(r.t.bind(r,26840,23)),Promise.resolve().then(r.t.bind(r,38771,23)),Promise.resolve().then(r.t.bind(r,13225,23)),Promise.resolve().then(r.t.bind(r,9295,23)),Promise.resolve().then(r.t.bind(r,43982,23))},77721:(e,s,r)=>{Promise.resolve().then(r.bind(r,85927))},81379:(e,s,r)=>{Promise.resolve().then(r.bind(r,17039))},85927:(e,s,r)=>{"use strict";r.r(s),r.d(s,{default:()=>a});var t=r(95344),o=r(56506),i=r(8428);function a(){let e=(0,i.usePathname)();return t.jsx("nav",{className:"bg-white shadow-md",children:t.jsx("div",{className:"container mx-auto px-4",children:(0,t.jsxs)("div",{className:"flex justify-between h-16",children:[t.jsx("div",{className:"flex items-center",children:t.jsx(o.default,{href:"/dashboard",children:(0,t.jsxs)("div",{className:"flex items-center",children:[t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-8 h-8 text-blue-600 mr-2",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z"})}),t.jsx("span",{className:"font-bold text-lg text-gray-800",children:"診所管理系統"})]})})}),t.jsx("div",{className:"flex space-x-4",children:[{href:"/dashboard",label:"儀表板"},{href:"/appointments",label:"預約管理"},{href:"/member",label:"診所會員"},{href:"/patient_registration",label:"患者登記"},{href:"/medical_record",label:"病歷系統"},{href:"/admin/settings",label:"設定管理"}].map(s=>t.jsx(o.default,{href:s.href,className:`inline-flex items-center px-3 py-2 border-b-2 text-sm font-medium leading-5 transition duration-150 ease-in-out ${e===s.href?"border-blue-500 text-blue-600 focus:outline-none focus:border-blue-700":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none focus:text-gray-700 focus:border-gray-300"}`,children:s.label},s.href))})]})})})}},17039:(e,s,r)=>{"use strict";r.r(s),r.d(s,{default:()=>y});var t=r(95344),o=r(3729),i=r(8428),a=r(20984),l=r(47665);function n(e){return e.startsWith("/")?e:e.startsWith("http:")?(console.log("⚠️ 將 HTTP URL 替換為 HTTPS:",e),e.replace("http:","https:")):e}async function d(){let e={basic_diseases:["我沒有任何基礎病","高血壓","糖尿病","心臟病","其他，請列明"],drug_allergies:["我沒有任何藥物過敏","青黴素","非類固醇消炎藥","其他藥物，請列明"],food_allergies:["我沒有任何食物過敏","海鮮","堅果","其他食物，請列明"],data_sources:["朋友介紹","網絡","Instagram","Facebook"],regions:{香港:{中西區:["中環","上環"]}},doctors:[]},s=async(e,r=3,t=1e3)=>{try{let s=await fetch(e,{method:"GET",headers:{Accept:"application/json","Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},cache:"no-store"});if(!s.ok)throw Error(`HTTP error ${s.status}`);return s}catch(o){if(r<=1)throw o;return console.log(`重試請求 (${4-r}/3): ${e}`),await new Promise(e=>setTimeout(e,t)),s(e,r-1,1.5*t)}};try{let r=n((0,a.l9)("/patient_registration/reference-data/"));console.log("\uD83D\uDD12 請求參考資料:",r);let t=await s(r),o=await t.json();if(console.log("\uD83D\uDCCA 成功獲取參考資料，資料結構:",Object.keys(o)),o.doctors&&Array.isArray(o.doctors)&&0!==o.doctors.length)console.log("✅ 參考資料中已包含醫師資料，數量:",o.doctors.length);else{console.warn("⚠️ 參考資料中沒有醫師資料，嘗試從醫師 API 獲取");try{let e=n((0,a.l9)("/doctors/")),r=await s(e),t=await r.json();console.log("✅ 成功從專用 API 獲取醫師資料:",t),Array.isArray(t)&&t.length>0?o.doctors=t:console.warn("⚠️ 醫師 API 返回空數據或格式錯誤")}catch(e){console.error("❌ 無法從專用 API 獲取醫師資料:",e)}}for(let s of["basic_diseases","drug_allergies","food_allergies","data_sources"])o[s]&&Array.isArray(o[s])&&0!==o[s].length||(console.warn(`⚠️ 參考資料中缺少 ${s}，使用備用數據`),o[s]=e[s]);return o.regions&&0!==Object.keys(o.regions).length||(console.warn("⚠️ 參考資料中缺少 regions，使用備用數據"),o.regions=e.regions),o}catch(r){console.error("❌ 獲取參考資料失敗:",r);try{let r=n((0,a.l9)("/doctors/"));console.log("\uD83D\uDD04 嘗試從醫師 API 獲取醫師資料（最後嘗試）:",r);let t=await s(r,2),o=await t.json();Array.isArray(o)&&o.length>0&&(console.log("✅ 成功獲取醫師資料:",o),e.doctors=o)}catch(e){console.error("❌ 最終嘗試獲取醫師資料失敗")}return console.log("\uD83D\uDD04 使用後備參考資料:",e),e}}async function c(e){try{let s=e.replace(/[\(\)]/g,"").trim();console.log("\uD83D\uDD0D 格式化後的身份證號碼:",s);let r=n((0,a.l9)("/patient_registration/check-id-number/"));return(await l.Z.get(r,{params:{id_number:s}})).data}catch(e){if(console.error("檢查身份證號碼失敗:",e),e.response){if(404===e.response.status)return{exists:!1,patient:null};if(500===e.response.status)throw console.error("後端處理身份證號碼時出錯:",e.response.data),Error("系統處理身份證號碼時出錯，請稍後再試或聯絡客服")}throw e}}async function u(e){try{let s={...e};s.email&&""!==s.email&&"undefined"!==s.email&&("string"!=typeof s.email||""!==s.email.trim())||(console.log("API 調用前檢查: email 欄位為空，設置為 no@no.com"),s.email="no@no.com"),console.log("API 最終請求數據:",JSON.stringify(s));try{if(s.id_number){console.log(`首先嘗試通過身份證號碼檢查患者是否存在: ${s.id_number}`);let e=await c(s.id_number);if(e.exists&&e.patient){console.log("發現患者已存在，自動處理為覆診流程");let r=e.patient.id,t={doctor_id:s.doctor_id,note:s.note,basic_diseases:s.basic_diseases,drug_allergies:s.drug_allergies,food_allergies:s.food_allergies,chief_complaint:s.chief_complaint},o=await h(r,t);return console.log("✅ 患者覆診資料更新成功:",o),o}}if(s.phone_number){console.log(`嘗試通過電話號碼檢查患者是否存在: ${s.phone_number}`);try{let e=await g(s.phone_number);if(e){console.log("通過電話號碼找到現有患者，自動處理為覆診流程");let r=e.id,t={doctor_id:s.doctor_id,note:s.note,basic_diseases:s.basic_diseases,drug_allergies:s.drug_allergies,food_allergies:s.food_allergies,chief_complaint:s.chief_complaint},o=await h(r,t);return console.log("✅ 通過電話號碼找到患者並更新成功:",o),o}}catch(e){console.log("使用電話號碼查詢患者失敗，繼續嘗試其他方法:",e)}}}catch(e){console.log("預先檢查患者是否存在時出錯，繼續嘗試提交流程:",e)}let r=n((0,a.l9)("/patient_registration/"));console.log("\uD83D\uDD37 提交患者數據到:",r);try{let e=await l.Z.post(r,s);return console.log("✅ 患者創建成功:",e.data),e.data}catch(e){if(console.error("❌ POST 請求失敗，檢查錯誤類型:",e),e.response&&409===e.response.status){console.log("處理409衝突: 患者已存在，嘗試獲取患者信息並自動處理為覆診流程");try{let r=null,t=null;if(e.response.data&&e.response.data.patient_id){t=e.response.data.patient_id,console.log(`從409響應中獲取患者ID: ${t}`);try{r=await m(t)}catch(e){console.log(`通過ID ${t} 獲取患者失敗:`,e)}}if(!r&&e.response.data&&e.response.data.detail){let s=e.response.data.detail;console.log("分析錯誤詳情尋找患者ID:",s);let o=/patient_id: (\d+)/.exec(s)||/patient id: (\d+)/.exec(s)||/id: (\d+)/.exec(s);if(o&&o[1]){t=parseInt(o[1]),console.log(`從錯誤詳情中提取到患者ID: ${t}`);try{r=await m(t)}catch(e){console.log(`通過提取的ID ${t} 獲取患者失敗:`,e)}}}if(!r&&s.id_number){console.log(`使用身份證再次檢查獲取患者: ${s.id_number}`);try{let e=await c(s.id_number);e.exists&&e.patient&&(t=(r=e.patient).id)}catch(e){console.log("使用身份證查詢失敗:",e)}}if(!r&&s.phone_number){console.log(`使用電話號碼再次嘗試獲取患者: ${s.phone_number}`);try{(r=await g(s.phone_number))&&(t=r.id)}catch(e){console.log("使用電話號碼查詢失敗:",e)}}if(r&&t){console.log("成功找到現有患者記錄:",r);let e={doctor_id:s.doctor_id,note:s.note,chief_complaint:s.chief_complaint,basic_diseases:s.basic_diseases,drug_allergies:s.drug_allergies,food_allergies:s.food_allergies};try{console.log(`嘗試使用主要 API 路徑更新患者 ID ${t}`);let s=await h(t,e);return console.log("✅ 成功處理409衝突並更新患者覆診資料:",s),s}catch(e){console.error("使用主要 API 路徑更新患者失敗，嘗試備用方法:",e);try{let e=n((0,a.l9)("/patients/revisit"));console.log("嘗試使用覆診專用端點:",e);let r={...s,patient_id:t},o=await l.Z.post(e,r);return console.log("✅ 使用覆診專用端點成功:",o.data),o.data}catch(e){throw console.error("覆診專用端點也失敗:",e),Error("此患者已存在，但系統無法自動完成掛號。請先切換到覆診模式，然後搜尋此患者資料再提交。")}}}else{console.warn("409錯誤處理: 仍然無法找到相關患者信息，嘗試最後的應急方法");try{let e=n((0,a.l9)("/patients/revisit"));console.log("嘗試使用覆診專用端點:",e);let r=await l.Z.post(e,s);return console.log("✅ 使用覆診專用端點成功:",r.data),r.data}catch(e){throw console.error("覆診專用端點也失敗:",e),Error("此患者已存在，但系統無法自動完成掛號。請先切換到覆診模式，然後搜尋此患者資料再提交。")}}}catch(e){throw console.error("恢復409衝突時出錯:",e),Error("此患者已在系統中，但系統無法自動處理為覆診流程。請切換到覆診模式，搜尋患者後再提交。")}}throw e}}catch(r){if(console.error("❌ 創建患者失敗，處理各種錯誤情況:",r),r.response&&404===r.response.status){console.log("患者不存在，嘗試創建新患者");try{let s=n((0,a.l9)("/patients/"));console.log("\uD83D\uDD37 使用替代 API 端點嘗試創建患者:",s);let r=await l.Z.post(s,e);return console.log("✅ 使用替代端點成功創建患者:",r.data),r.data}catch(e){throw console.error("使用替代端點創建患者失敗:",e),Error("無法創建患者記錄，請稍後再試或聯絡櫃檯人員協助。")}}if(r.response&&422===r.response.status){let e=r.response.data?.detail||[],s={},t="資料驗證失敗";Array.isArray(e)?(e.forEach(e=>{if(e.loc&&Array.isArray(e.loc)&&e.loc.length>1){let r=e.loc.slice(1).join(".");s[r]=e.msg,console.error(`欄位 "${r}" 驗證失敗:`,e.msg)}}),Object.keys(s).length>0&&(t=`資料驗證失敗: ${Object.keys(s).map(e=>`${e} (${s[e]})`).join(", ")}`)):"object"==typeof r.response.data&&(t=r.response.data.detail||"資料驗證失敗，請檢查輸入",s=r.response.data);let o=Error(t);throw o.response=r.response,o.validationErrors=s,o.isValidationError=!0,o.status=422,o}if(r.response){console.error(`服務器回應 ${r.response.status} 錯誤:`,r.response.data);let e="系統處理請求時發生錯誤，請稍後再試";401===r.response.status||403===r.response.status?e="您沒有權限執行此操作，請聯絡系統管理員":r.response.status>=500&&(e="系統內部錯誤，請稍後再試或聯絡技術支援");let s=Error(e);throw s.response=r.response,s.status=r.response.status,s}let s=Error("連接伺服器失敗，請檢查網絡連接");throw s.isNetworkError=!0,s}}async function m(e){try{let s=n((0,a.l9)(`/patient_registration/${e}`));return(await l.Z.get(s)).data}catch(s){if(console.error(`獲取患者 ID ${e} 失敗:`,s),s.response)throw console.error(`API響應狀態: ${s.response.status}`),console.error(`請求URL: ${s.config?.url}`),console.error(`回應數據: `,s.response.data),Error(`獲取患者資料失敗(${s.response.status}): 可能是程式邏輯錯誤，請通知技術人員`);throw s}}async function g(e){try{let s=e.replace(/[\s\-\(\)]/g,"");console.log("\uD83D\uDD0D 格式化後的電話號碼:",s);try{let e=n((0,a.l9)(`/patients/by-phone-number?phone=${s}`));return console.log("嘗試使用查詢參數格式 API 端點:",e),(await l.Z.get(e,{timeout:5e3})).data}catch(r){console.warn("使用新 API 路徑失敗，嘗試舊路徑格式:",r.message);let e=n((0,a.l9)(`/patient_registration/by-phone-number/${s}/`));return console.log("嘗試使用原始路徑參數格式 API 端點（即將淘汰）:",e),(await l.Z.get(e)).data}}catch(s){if(console.error(`通過電話號碼 ${e} 獲取患者失敗:`,s),s.response){if(console.error(`API響應狀態: ${s.response.status}`),console.error(`請求URL: ${s.config?.url}`),console.error(`回應數據: `,s.response.data),404===s.response.status)throw Error(`未找到電話號碼為 ${e} 的患者記錄`);if(500===s.response.status)throw console.error("後端處理電話號碼時出錯:",s.response.data),Error("系統處理電話號碼時出錯 (500): 可能是程式邏輯錯誤，請通知技術人員");if(s.response.data&&s.response.data.detail)throw Error(s.response.data.detail)}throw Error("無法查詢電話號碼，請確認格式正確或稍後再試")}}async function h(e,s){try{let r=n((0,a.l9)(`/patient_registration/${e}`));return console.log(`嘗試更新患者 ID ${e}，URL: ${r}`),(await l.Z.patch(r,s)).data}catch(r){if(console.error(`更新患者 ID ${e} 失敗:`,r),r.response){if(console.error(`API響應狀態: ${r.response.status}`),console.error(`請求URL: ${r.config?.url}`),console.error(`回應數據: `,r.response.data),404===r.response.status){console.log(`主要患者更新端點返回 404，嘗試備用端點...`);try{let r=n((0,a.l9)(`/patients/update/${e}`));return console.log(`嘗試使用備用 API 路徑更新患者 ID ${e}，URL: ${r}`),(await l.Z.patch(r,s)).data}catch(e){console.error(`備用患者更新端點也失敗:`,e)}}throw Error(`更新患者資料失敗(${r.response.status}): 可能是程式邏輯錯誤，請通知技術人員`)}throw r}}let p=({regions:e,value:s,onChange:r,required:i=!1,readOnly:a=!1})=>{let[l,n]=(0,o.useState)([]),[d,c]=(0,o.useState)([]);return(0,o.useEffect)(()=>{if(s.region&&e[s.region]){let t=Object.keys(e[s.region]);n(t),t.length>0&&!t.includes(s.district)&&r({...s,district:"",subDistrict:""})}else n([]),c([])},[s.region,e]),(0,o.useEffect)(()=>{if(s.region&&s.district&&e[s.region]&&e[s.region][s.district]){let t=e[s.region][s.district];c(t),t.length>0&&!t.includes(s.subDistrict)&&r({...s,subDistrict:""})}else c([])},[s.region,s.district,e]),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["區域 ",i&&t.jsx("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{value:s.region,onChange:e=>{r({region:e.target.value,district:"",subDistrict:""})},className:`mt-1 block w-full px-3 py-2 ${a?"bg-gray-100":"bg-white"} border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,required:i,disabled:a,children:[t.jsx("option",{value:"",children:"請選擇區域"}),Object.keys(e).map(e=>t.jsx("option",{value:e,children:e},e))]})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["地區 ",i&&t.jsx("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{value:s.district,onChange:e=>{r({...s,district:e.target.value,subDistrict:""})},className:`mt-1 block w-full px-3 py-2 ${a?"bg-gray-100":"bg-white"} border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,disabled:a||!s.region||0===l.length,required:i,children:[t.jsx("option",{value:"",children:"請選擇地區"}),l.map(e=>t.jsx("option",{value:e,children:e},e))]})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["細分地區 ",i&&t.jsx("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{value:s.subDistrict,onChange:e=>{r({...s,subDistrict:e.target.value})},className:`mt-1 block w-full px-3 py-2 ${a?"bg-gray-100":"bg-white"} border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,disabled:a||!s.district||0===d.length,required:i,children:[t.jsx("option",{value:"",children:"請選擇細分地區"}),d.map(e=>t.jsx("option",{value:e,children:e},e))]})]})]})};class x extends o.Component{constructor(e){super(e),this.state={hasError:!1,error:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,s){console.error("PatientForm 錯誤邊界捕獲到錯誤:",e,s)}render(){return this.state.hasError?this.props.fallback?this.props.fallback:(0,t.jsxs)("div",{className:"p-4 bg-red-50 border border-red-200 rounded-md text-red-700",children:[t.jsx("h3",{className:"text-lg font-medium mb-2",children:"發生錯誤"}),t.jsx("p",{className:"mb-4",children:"很抱歉，表單處理過程中發生錯誤。"}),(0,t.jsxs)("details",{className:"text-sm text-red-600",children:[t.jsx("summary",{children:"錯誤詳情"}),t.jsx("pre",{className:"mt-2 whitespace-pre-wrap",children:this.state.error?.toString()})]}),t.jsx("button",{onClick:()=>window.location.reload(),className:"mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"重新載入頁面"})]}):this.props.children}}let b=()=>{(0,i.useRouter)();let[e,s]=(0,o.useState)(!1),[r,l]=(0,o.useState)(null),[n,m]=(0,o.useState)(null),[h,b]=(0,o.useState)(!0),[f,y]=(0,o.useState)(""),[_,j]=(0,o.useState)(!1),[w,v]=(0,o.useState)(null),[N,$]=(0,o.useState)(!1),[D,k]=(0,o.useState)(!1),[A,E]=(0,o.useState)(!1),[P,C]=(0,o.useState)(""),[S,q]=(0,o.useState)(""),[I,W]=(0,o.useState)(""),[O,T]=(0,o.useState)({chinese_name:"",english_name:"",id_number:"",birth_date:"",phone_number:"",email:"no@no.com",gender:"",basic_diseases:["我沒有任何基礎病"],drug_allergies:["我沒有任何藥物過敏"],food_allergies:["我沒有任何食物過敏"],note:"",has_appointment:!1,doctor_id:void 0,data_source:"",region:"",district:"",sub_district:"",chief_complaint:""});(0,o.useEffect)(()=>{(async()=>{try{if("serviceWorker"in navigator)try{navigator.serviceWorker.getRegistrations().then(e=>{e.forEach(e=>{console.log("\uD83E\uDDF9 清除 Service Worker 緩存:",e),e.unregister()})})}catch(e){console.warn("無法清除 Service Worker 緩存:",e)}let e=(0,a.l9)("/patient_registration/reference-data/");console.log("\uD83D\uDD0D 測試 URL 生成:",e),console.log("\uD83D\uDD0D window.location.origin =",window.location.origin),console.log("\uD83D\uDD0D window.location.protocol =",window.location.protocol),e.startsWith("http:")&&console.error("⛔ URL 協議錯誤，使用了 HTTP:",e),console.log("\uD83D\uDD52 正在請求參考數據，時間戳:",new Date().toISOString());let s=await d();console.log("✅ 成功獲取參考數據!",s);let r=s.doctors;if(!r||!Array.isArray(r)||0===r.length){console.warn("⚠️ 未能從 API 獲取醫師數據，嘗試獲取緊急備用方案");try{r=[{id:1,name:"郭鎮峰",specialty:"中醫師"}],console.log("✅ 使用硬編碼的醫師資料:",r),s.doctors=r}catch(e){console.error("❌ 緊急備用方案失敗:",e)}}s.doctors&&s.doctors.length>0?console.log("\uD83D\uDC68‍⚕️ 成功載入醫師數據:",s.doctors):console.warn("⚠️ 醫師數據為空或不存在:",s.doctors),m(s)}catch(s){console.error("❌ 獲取參考數據失敗:",s),s instanceof Error&&(console.error("錯誤名稱:",s.name),console.error("錯誤訊息:",s.message),console.error("錯誤堆疊:",s.stack));let e={basic_diseases:["我沒有任何基礎病","高血壓","糖尿病","心臟病","其他，請列明"],drug_allergies:["我沒有任何藥物過敏","青黴素","非類固醇消炎藥","其他藥物，請列明"],food_allergies:["我沒有任何食物過敏","海鮮","堅果","其他食物，請列明"],data_sources:["朋友介紹","網絡","Instagram","Facebook"],regions:{香港:{中西區:["中環","上環"]}},doctors:[{id:1,name:"郭鎮峰",specialty:"中醫師"}]};console.log("\uD83D\uDD04 使用後備參考資料:",e),m(e),l({type:"error",text:"無法加載參考數據，已使用基本資料。您可以繼續填寫表單，但若無法提交請刷新頁面重試。"})}})()},[]),(0,o.useEffect)(()=>{let e=async()=>{if(O.id_number.length>=8)try{(await c(O.id_number)).exists?l({type:"info",text:"此身份證/護照號碼已存在，系統將自動使用覆診流程。若要建立新患者，請確認身份證是否正確。"}):l(null)}catch(e){console.error("檢查患者錯誤:",e)}};if(h){let s=setTimeout(e,500);return()=>clearTimeout(s)}},[O.id_number,h]);let L=e=>{let{name:s,value:r}=e.target;T(e=>({...e,[s]:r}))},U=(e,s,r)=>{console.log(`複選框變更: ${e}, ${s}, ${r}`),T(t=>{let o=[...t[e]],i=s.includes("我沒有"),a=s.includes("其他");return r?i?(o=[s],"basic_diseases"===e?C(""):"drug_allergies"===e?q(""):"food_allergies"===e&&W("")):(o=o.filter(e=>!e.includes("我沒有"))).push(s):(o=o.filter(e=>e!==s),a&&("basic_diseases"===e?C(""):"drug_allergies"===e?q(""):"food_allergies"===e&&W("")),0===o.length&&(o="basic_diseases"===e?["我沒有任何基礎病"]:"drug_allergies"===e?["我沒有任何藥物過敏"]:["我沒有任何食物過敏"])),console.log(`${e} 最終選項:`,o),{...t,[e]:o}})},H=(e,s)=>{let r="basic_diseases"===e?"其他，請列明":"drug_allergies"===e?"其他藥物，請列明":"其他食物，請列明";console.log(`其他選項輸入變更: ${e}, "${r}", 值: "${s}"`),"basic_diseases"===e?C(s):"drug_allergies"===e?q(s):W(s),O[e].includes(r)||(console.log(`強制將 "${r}" 選項添加到 ${e}`),T(s=>{let t=s[e].filter(e=>!e.includes("我沒有"));return t.includes(r)?s:{...s,[e]:[...t,r]}}))},R=e=>{b(e),e?(T({chinese_name:"",english_name:"",id_number:"",birth_date:"",phone_number:"",email:"no@no.com",gender:"",basic_diseases:["我沒有任何基礎病"],drug_allergies:["我沒有任何藥物過敏"],food_allergies:["我沒有任何食物過敏"],note:"",has_appointment:!1,doctor_id:void 0,data_source:"",region:"",district:"",sub_district:"",chief_complaint:""}),C(""),q(""),W(""),l(null),j(!1),$(!1),k(!1),E(!1)):(y(""),l({type:"info",text:"請輸入身份證號碼或電話號碼查詢現有患者"}),setTimeout(()=>{let e=document.getElementById("patient-search");e&&e.focus()},100))},M=async()=>{if(!f||f.length<5){l({type:"error",text:"請輸入有效的身份證號碼或電話號碼"});return}s(!0);try{let e;if(/^\d+$/.test(f))e=await g(f);else{let s=await c(f);if(s){if(s.exists&&s.patient)e=s.patient;else throw Error("找不到此身份證對應的患者記錄")}else throw Error("查詢身份證號碼失敗，請稍後再試")}T({chinese_name:e.chinese_name,english_name:e.english_name,id_number:e.id_number,birth_date:e.birth_date,phone_number:e.phone_number,email:e.email||"",gender:e.gender||"",basic_diseases:e.basic_diseases,drug_allergies:e.drug_allergies,food_allergies:e.food_allergies,note:e.note||"",has_appointment:e.has_appointment,doctor_id:e.doctor_id,data_source:e.data_source,region:e.region,district:e.district,sub_district:e.sub_district,chief_complaint:e.chief_complaint||""}),z(e.basic_diseases,"basic_diseases"),z(e.drug_allergies,"drug_allergies"),z(e.food_allergies,"food_allergies"),$(!e.basic_diseases.some(e=>e.includes("我沒有"))),k(!e.drug_allergies.some(e=>e.includes("我沒有"))),E(!e.food_allergies.some(e=>e.includes("我沒有"))),j(!0),l({type:"success",text:`已找到患者: ${e.chinese_name} (${e.registration_number})，請選擇主診醫師並完成覆診掛號`})}catch(e){console.error("查詢患者失敗:",e),l({type:"error",text:e.message||"無法找到患者記錄，請檢查輸入或轉為初診"})}finally{s(!1)}},z=(e,s)=>{let r=e.find(e=>e.startsWith("其他:")||e.startsWith("其他，請列明:")||e.startsWith("其他藥物:")||e.startsWith("其他食物:"));if(!r)return;let t="";r.startsWith("其他:")?t=r.replace("其他:","").trim():r.startsWith("其他，請列明:")?t=r.replace("其他，請列明:","").trim():r.startsWith("其他藥物:")?t=r.replace("其他藥物:","").trim():r.startsWith("其他食物:")&&(t=r.replace("其他食物:","").trim()),"basic_diseases"===s?(C(t),T(e=>({...e,[s]:[...e[s].filter(e=>!e.startsWith("其他:")&&!e.startsWith("其他，請列明:")),"其他疾病，請列明"]}))):"drug_allergies"===s?(q(t),T(e=>({...e,[s]:[...e[s].filter(e=>!e.startsWith("其他藥物:")&&!e.startsWith("其他，請列明:")),"其他藥物，請列明"]}))):"food_allergies"===s&&(W(t),T(e=>({...e,[s]:[...e[s].filter(e=>!e.startsWith("其他食物:")&&!e.startsWith("其他，請列明:")),"其他食物，請列明"]})))},Z=async e=>{e.preventDefault(),s(!0),l(null),v(null);try{if(!O.doctor_id){l({type:"error",text:"請選擇醫師"}),s(!1);return}let e=["chinese_name","english_name","id_number","birth_date","phone_number","data_source","region","district","sub_district"].filter(e=>!O[e]);if(e.length>0){l({type:"error",text:`以下欄位為必填: ${e.join(", ")}`}),s(!1);return}if(!/^[\u4e00-\u9fa5]{2,10}$/.test(O.chinese_name)){l({type:"error",text:"中文姓名必須為2-10個中文字"}),s(!1);return}if(!/^[A-Za-z\s]+$/.test(O.english_name)){l({type:"error",text:"英文姓名只能包含英文字母和空格"}),s(!1);return}let r={...O};if(r.email&&""!==r.email&&"undefined"!==r.email&&("string"!=typeof r.email||""!==r.email.trim())||(console.log("處理 email 之前:",r.email,typeof r.email),console.log("Email 欄位無效，設置為 no@no.com"),r.email="no@no.com"),console.log("處理 email 之後:",r.email),h)try{(await c(r.id_number)).exists&&(console.log("初診流程發現患者已存在，自動轉為覆診流程"),l({type:"info",text:"此身份證號碼已存在，系統將自動使用覆診流程"}))}catch(e){console.log("檢查患者是否存在時出錯，繼續流程:",e)}if(r.basic_diseases.includes("其他，請列明")&&P.trim()){let e=[...r.basic_diseases],s=e.indexOf("其他，請列明");-1!==s&&(e[s]=`其他，請列明: ${P.trim()}`,r.basic_diseases=e)}else r.basic_diseases.includes("其他，請列明")&&(r.basic_diseases=r.basic_diseases.filter(e=>"其他，請列明"!==e),0===r.basic_diseases.length&&(r.basic_diseases=["我沒有任何基礎病"]));if(r.drug_allergies.includes("其他藥物，請列明")&&S.trim()){let e=[...r.drug_allergies],s=e.indexOf("其他藥物，請列明");-1!==s&&(e[s]=`其他藥物: ${S.trim()}`,r.drug_allergies=e)}else r.drug_allergies.includes("其他藥物，請列明")&&(r.drug_allergies=r.drug_allergies.filter(e=>"其他藥物，請列明"!==e),0===r.drug_allergies.length&&(r.drug_allergies=["我沒有任何藥物過敏"]));if(r.food_allergies.includes("其他食物，請列明")&&I.trim()){let e=[...r.food_allergies],s=e.indexOf("其他食物，請列明");-1!==s&&(e[s]=`其他食物: ${I.trim()}`,r.food_allergies=e)}else r.food_allergies.includes("其他食物，請列明")&&(r.food_allergies=r.food_allergies.filter(e=>"其他食物，請列明"!==e),0===r.food_allergies.length&&(r.food_allergies=["我沒有任何食物過敏"]));console.log("✅ 嘗試提交表單數據:",JSON.stringify(r)),console.log("確認 Email 值:",r.email),r.email&&""!==r.email&&"string"==typeof r.email||(r.email="no@no.com",console.log("最終安全檢查: 設置 email 為 no@no.com"));let t=await u(r);console.log("✅ 患者創建/更新成功:",t);let o=n?.doctors?.find(e=>e.id===O.doctor_id)?.name||"未知醫師";v({chinese_name:O.chinese_name,registration_number:t.registration_number,doctor_name:o,registration_time:new Date().toLocaleString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}),l({type:"success",text:`患者${h?"登記":"覆診"}成功！掛號編號: ${t.registration_number}`}),j(!1),C(""),q(""),W("")}catch(e){if(console.error("❌ 提交患者登記表單錯誤:",e),e.isValidationError||e.response&&422===e.response.status){if(e.validationErrors&&Object.keys(e.validationErrors).length>0){let s=Object.entries(e.validationErrors).map(([e,s])=>`${e}: ${s}`).join("\n");l({type:"error",text:`請檢查以下欄位:
${s}`})}else if(e.response?.data?.detail){let s="";s=Array.isArray(e.response.data.detail)?e.response.data.detail.map(e=>{let s=e.loc&&e.loc.length>1?e.loc.slice(1).join("."):"未知欄位";return`${s}: ${e.msg}`}).join("\n"):e.response.data.detail,l({type:"error",text:`資料驗證失敗:
${s}`})}else l({type:"error",text:e.message||"資料驗證失敗，請檢查輸入"})}else if(e.isNetworkError)l({type:"error",text:"連接伺服器失敗，請檢查網絡連接並稍後再試"});else if(e.response){if(409===e.response.status){let s=e.message||"";s.includes("請先切換到覆診模式")||s.includes("請切換到覆診模式")?(l({type:"info",text:e.message}),setTimeout(()=>{b(!1),y(O.id_number||O.phone_number||""),l({type:"info",text:"系統已自動切換為覆診模式，請點擊「搜尋」按鈕查詢患者資料"})},1e3)):l({type:"info",text:"此患者已存在，系統嘗試自動處理為覆診流程但未成功。請手動切換到覆診模式並搜尋患者資料。"})}else 404===e.response.status?h?l({type:"info",text:"系統處理患者資料時遇到問題，正在嘗試自動恢復。請稍後再試或聯絡技術支援。"}):l({type:"error",text:"系統找不到此患者記錄。如果是新患者，請切換到初診模式進行登記。"}):l({type:"error",text:e.message&&(e.message.includes("患者")||e.message.includes("病人")||e.message.includes("覆診"))?e.message:`系統處理請求時發生錯誤 (${e.response.status})，請稍後再試或聯絡櫃檯人員`})}else l({type:"error",text:e.message||"發生未知錯誤，請稍後再試"})}finally{s(!1)}};return((0,o.useEffect)(()=>{console.log("當前表單狀態:"),console.log("- 基礎疾病:",O.basic_diseases),console.log("- 藥物過敏:",O.drug_allergies),console.log("- 食物過敏:",O.food_allergies),console.log("- 其他基礎疾病值:",P),console.log("- 其他藥物過敏值:",S),console.log("- 其他食物過敏值:",I)},[O.basic_diseases,O.drug_allergies,O.food_allergies,P,S,I]),(0,o.useEffect)(()=>{let e=O.drug_allergies.includes("其他藥物，請列明"),s=O.food_allergies.includes("其他食物，請列明");console.log("渲染檢查:"),console.log("- 藥物過敏包含「其他」選項:",e),console.log("- 食物過敏包含「其他」選項:",s),n&&console.log("- 醫師列表狀態:",n.doctors?`有效 (${Array.isArray(n.doctors)?n.doctors.length:"非數組"})`:"無效")},[O.drug_allergies,O.food_allergies,n]),(0,o.useEffect)(()=>{if(console.log("初始化頁面狀態:"),console.log("- 參考資料:",n),console.log("- 表單數據:",O),n&&(!n.doctors||!Array.isArray(n.doctors)||0===n.doctors.length)){console.warn("⚠️ 醫師資料加載失敗，嘗試重新載入");let e=setTimeout(async()=>{try{console.log("\uD83D\uDD04 自動重試載入醫師資料");let e=await d();e.doctors&&Array.isArray(e.doctors)&&e.doctors.length>0?(console.log("✅ 重試成功，載入了醫師資料:",e.doctors),m(e),l({type:"success",text:"醫師資料已自動更新"})):(console.error("❌ 重試後仍無法獲取醫師資料"),l({type:"error",text:"無法載入醫師資料，請點擊「重新載入醫師資料」按鈕嘗試手動更新"}))}catch(e){console.error("❌ 自動重試載入醫師資料失敗:",e)}},3e3);return()=>clearTimeout(e)}},[n]),n)?t.jsx(x,{children:t.jsx("div",{className:"bg-white shadow-md rounded-lg p-6",children:w?w?(0,t.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[(0,t.jsxs)("div",{className:"flex items-center text-green-600 mb-4",children:[t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-8 w-8 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}),t.jsx("h2",{className:"text-xl font-semibold",children:"掛號成功"})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[(0,t.jsxs)("div",{children:[t.jsx("p",{className:"text-gray-600",children:"患者姓名"}),t.jsx("p",{className:"font-medium",children:w.chinese_name})]}),(0,t.jsxs)("div",{children:[t.jsx("p",{className:"text-gray-600",children:"掛號編號"}),t.jsx("p",{className:"font-medium",children:w.registration_number})]}),(0,t.jsxs)("div",{children:[t.jsx("p",{className:"text-gray-600",children:"主診醫師"}),t.jsx("p",{className:"font-medium",children:w.doctor_name||"未指定"})]}),(0,t.jsxs)("div",{children:[t.jsx("p",{className:"text-gray-600",children:"登記時間"}),t.jsx("p",{className:"font-medium",children:w.registration_time})]})]}),(0,t.jsxs)("div",{className:"flex flex-wrap gap-3 mt-6",children:[t.jsx("button",{onClick:()=>{T({chinese_name:"",english_name:"",id_number:"",birth_date:"",phone_number:"",email:"no@no.com",gender:"",basic_diseases:["我沒有任何基礎病"],drug_allergies:["我沒有任何藥物過敏"],food_allergies:["我沒有任何食物過敏"],note:"",has_appointment:!1,doctor_id:void 0,data_source:"",region:"",district:"",sub_district:"",chief_complaint:""}),$(!1),k(!1),E(!1),v(null)},className:"flex-1 min-w-[120px] py-2 px-4 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors",children:"再登記一位病人"}),t.jsx("a",{href:`/appointments?patient_name=${encodeURIComponent(w.chinese_name)}&phone_number=${encodeURIComponent(O.phone_number)}`,className:"flex-1 min-w-[120px] py-2 px-4 bg-orange-500 text-white rounded hover:bg-orange-600 transition-colors text-center",children:"為此患者預約"}),t.jsx("a",{href:"/medical_record",className:"flex-1 min-w-[120px] py-2 px-4 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors text-center",children:"前往病歷系統"})]})]}):null:(0,t.jsxs)("form",{onSubmit:Z,children:[r&&t.jsx("div",{className:`mb-4 p-3 rounded-md ${"error"===r.type?"bg-red-50 text-red-700 border border-red-200":"success"===r.type?"bg-green-50 text-green-700 border border-green-200":"bg-blue-50 text-blue-700 border border-blue-200"}`,children:t.jsx("p",{className:"whitespace-pre-line",children:r.text})}),(0,t.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[t.jsx("div",{className:"text-lg font-bold",children:"患者登記表"}),(0,t.jsxs)("div",{className:"flex space-x-2",children:[t.jsx("button",{type:"button",className:`px-4 py-2 rounded-md ${h?"bg-blue-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,onClick:()=>R(!0),children:"初診"}),t.jsx("button",{type:"button",className:`px-4 py-2 rounded-md ${h?"bg-gray-200 text-gray-700 hover:bg-gray-300":"bg-blue-600 text-white"}`,onClick:()=>R(!1),children:"覆診"})]})]}),!h&&(0,t.jsxs)("div",{className:"mb-6 p-4 bg-blue-50 rounded-md border border-blue-200",children:[t.jsx("div",{className:"text-blue-700 mb-2",children:"覆診病人需先輸入身份證或電話搜尋現有紀錄"}),(0,t.jsxs)("div",{className:"flex gap-2",children:[t.jsx("input",{id:"patient-search",type:"text",value:f,onChange:e=>y(e.target.value),placeholder:"輸入身份證號碼或電話號碼",className:"flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"}),t.jsx("button",{type:"button",onClick:M,disabled:e,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-blue-300",children:e?"搜尋中...":"搜尋"})]})]}),!h&&_&&t.jsx("div",{className:"mb-4 flex justify-end",children:(0,t.jsxs)("button",{type:"button",onClick:()=>{j(!1),console.log("✅ 已解除唯讀狀態，fieldsReadOnly =",!1),setTimeout(()=>{let e=document.querySelectorAll('select[name="gender"]'),s=document.querySelectorAll('input[name="id_number"], input[name="birth_date"], input[name="chinese_name"]');e.forEach(e=>{e instanceof HTMLSelectElement&&(e.disabled=!1,console.log("✓ 已解除性別欄位的禁用狀態"))}),s.forEach(e=>{e instanceof HTMLInputElement&&(e.readOnly=!1,console.log(`✓ 已解除 ${e.name} 欄位的唯讀狀態`))})},100),l({type:"info",text:"您現在可以編輯患者資料。請注意，修改基本個人資料可能影響醫療記錄的一致性。"})},className:"px-3 py-1 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 flex items-center text-sm",children:[t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 mr-1",viewBox:"0 0 20 20",fill:"currentColor",children:t.jsx("path",{d:"M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"})}),"編輯患者資料"]})}),t.jsx("h2",{className:"text-xl font-bold mb-4",children:"基本資料"}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["中文姓名 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsx("input",{type:"text",name:"chinese_name",value:O.chinese_name,onChange:L,readOnly:_,className:`mt-1 block w-full px-3 py-2 border ${_?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,required:!0})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["英文姓名 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsx("input",{type:"text",name:"english_name",value:O.english_name,onChange:L,readOnly:_,className:`mt-1 block w-full px-3 py-2 border ${_?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,required:!0})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["身份證號碼 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsx("input",{type:"text",name:"id_number",value:O.id_number,onChange:L,readOnly:_,className:`mt-1 block w-full px-3 py-2 border ${_?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,required:!0})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["出生日期 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsx("input",{type:"date",name:"birth_date",value:O.birth_date,onChange:L,readOnly:_,className:`mt-1 block w-full px-3 py-2 border ${_?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,required:!0})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["手機號碼 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsx("input",{type:"tel",name:"phone_number",value:O.phone_number,onChange:L,readOnly:_,className:`mt-1 block w-full px-3 py-2 border ${_?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,required:!0})]}),(0,t.jsxs)("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"電子郵件 (選填)"}),t.jsx("input",{type:"email",name:"email",value:"no@no.com"===O.email?"":O.email,onChange:L,readOnly:_,className:`mt-1 block w-full px-3 py-2 border ${_?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,placeholder:"輸入電子郵件或留空"})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["性別 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{name:"gender",value:O.gender,onChange:L,required:!0,disabled:_,className:`mt-1 block w-full px-3 py-2 ${_?"bg-gray-100":"bg-white"} border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,children:[t.jsx("option",{value:"",children:"請選擇"}),t.jsx("option",{value:"男",children:"男"}),t.jsx("option",{value:"女",children:"女"}),t.jsx("option",{value:"其他",children:"其他"})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["從何得知本診所 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{name:"data_source",value:O.data_source,onChange:L,disabled:_,className:`mt-1 block w-full px-3 py-2 border ${_?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,required:!0,children:[t.jsx("option",{value:"",children:"請選擇"}),n.data_sources.map(e=>t.jsx("option",{value:e,children:e},e))]})]})]}),t.jsx("h2",{className:"text-xl font-bold mb-4",children:"居住地區"}),t.jsx("div",{className:"mb-6",children:t.jsx(p,{regions:n.regions,onChange:e=>{T(s=>({...s,region:e.region,district:e.district,sub_district:e.subDistrict}))},value:{region:O.region,district:O.district,subDistrict:O.sub_district},required:!0,readOnly:_})}),t.jsx("h2",{className:"text-xl font-bold mb-4",children:"健康資訊"}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["是否有基礎疾病 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{name:"has_basic_disease",value:N?"是":"否",onChange:e=>{let s="是"===e.target.value;$(s),s||(T(e=>({...e,basic_diseases:["我沒有任何基礎病"]})),C(""))},disabled:_,className:`mt-1 block w-full px-3 py-2 border ${_?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,required:!0,children:[t.jsx("option",{value:"",children:"請選擇"}),t.jsx("option",{value:"是",children:"是"}),t.jsx("option",{value:"否",children:"否"})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["是否有藥物過敏 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{name:"has_drug_allergy",value:D?"是":"否",onChange:e=>{let s="是"===e.target.value;k(s),s||(T(e=>({...e,drug_allergies:["我沒有任何藥物過敏"]})),q(""))},disabled:_,className:`mt-1 block w-full px-3 py-2 border ${_?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,required:!0,children:[t.jsx("option",{value:"",children:"請選擇"}),t.jsx("option",{value:"是",children:"是"}),t.jsx("option",{value:"否",children:"否"})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["是否有食物過敏 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{name:"has_food_allergy",value:A?"是":"否",onChange:e=>{let s="是"===e.target.value;E(s),s||(T(e=>({...e,food_allergies:["我沒有任何食物過敏"]})),W(""))},disabled:_,className:`mt-1 block w-full px-3 py-2 border ${_?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,required:!0,children:[t.jsx("option",{value:"",children:"請選擇"}),t.jsx("option",{value:"是",children:"是"}),t.jsx("option",{value:"否",children:"否"})]})]})]}),N&&(0,t.jsxs)("div",{className:"mb-6 p-4 bg-gray-50 rounded-md border border-gray-200",children:[t.jsx("div",{className:"mb-2 font-medium",children:"請選擇基礎疾病（可多選）"}),t.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2 mb-3",children:n.basic_diseases.filter(e=>!e.includes("我沒有")).map((e,s)=>(0,t.jsxs)("label",{className:"inline-flex items-center",children:[t.jsx("input",{type:"checkbox",checked:O.basic_diseases.includes(e),onChange:s=>U("basic_diseases",e,s.target.checked),disabled:_,className:"h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"}),t.jsx("span",{className:"ml-2 text-sm text-gray-700",children:e})]},`basic_disease_${s}`))}),O.basic_diseases.includes("其他，請列明")&&(0,t.jsxs)("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"其他基礎疾病，請列明"}),t.jsx("input",{type:"text",value:P,onChange:e=>H("basic_diseases",e.target.value),disabled:_,className:`mt-1 block w-full px-3 py-2 border ${_?"bg-gray-100":"bg-gray-50"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,placeholder:"請詳細說明其他基礎疾病"}),O.basic_diseases.includes("其他，請列明")&&!P&&t.jsx("p",{className:"text-sm text-red-600 mt-1",children:"請填寫基礎疾病細節"})]})]}),D&&(0,t.jsxs)("div",{className:"mb-6 p-4 bg-gray-50 rounded-md border border-gray-200",children:[t.jsx("div",{className:"mb-2 font-medium",children:"請選擇藥物過敏（可多選）"}),t.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2 mb-3",children:n.drug_allergies.filter(e=>!e.includes("我沒有")).map((e,s)=>(0,t.jsxs)("label",{className:"inline-flex items-center",children:[t.jsx("input",{type:"checkbox",checked:O.drug_allergies.includes(e),onChange:s=>U("drug_allergies",e,s.target.checked),disabled:_,className:"h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"}),t.jsx("span",{className:"ml-2 text-sm text-gray-700",children:e})]},`drug_allergy_${s}`))}),O.drug_allergies.includes("其他藥物，請列明")&&(0,t.jsxs)("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"其他藥物過敏，請列明"}),t.jsx("input",{type:"text",value:S,onChange:e=>H("drug_allergies",e.target.value),disabled:_,className:`mt-1 block w-full px-3 py-2 border ${_?"bg-gray-100":"bg-gray-50"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,placeholder:"請詳細說明其他藥物過敏"}),O.drug_allergies.includes("其他藥物，請列明")&&!S&&t.jsx("p",{className:"text-sm text-red-600 mt-1",children:"請填寫藥物過敏細節"})]})]}),A&&(0,t.jsxs)("div",{className:"mb-6 p-4 bg-gray-50 rounded-md border border-gray-200",children:[t.jsx("div",{className:"mb-2 font-medium",children:"請選擇食物過敏（可多選）"}),t.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2 mb-3",children:n.food_allergies.filter(e=>!e.includes("我沒有")).map((e,s)=>(0,t.jsxs)("label",{className:"inline-flex items-center",children:[t.jsx("input",{type:"checkbox",checked:O.food_allergies.includes(e),onChange:s=>U("food_allergies",e,s.target.checked),disabled:_,className:"h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"}),t.jsx("span",{className:"ml-2 text-sm text-gray-700",children:e})]},`food_allergy_${s}`))}),O.food_allergies.includes("其他食物，請列明")&&(0,t.jsxs)("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"其他食物過敏，請列明"}),t.jsx("input",{type:"text",value:I,onChange:e=>H("food_allergies",e.target.value),disabled:_,className:`mt-1 block w-full px-3 py-2 border ${_?"bg-gray-100":"bg-gray-50"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,placeholder:"請詳細說明其他食物過敏"}),O.food_allergies.includes("其他食物，請列明")&&!I&&t.jsx("p",{className:"text-sm text-red-600 mt-1",children:"請填寫食物過敏細節"})]})]}),(0,t.jsxs)("div",{className:"mb-6",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"備註（選填）"}),t.jsx("textarea",{name:"note",value:O.note,onChange:L,disabled:_,rows:3,className:`mt-1 block w-full px-3 py-2 border ${_?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,placeholder:"例如：偏好女醫師，懂英語，請準備輪椅"})]}),(0,t.jsxs)("div",{className:"mb-6",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"自述主訴（選填）"}),t.jsx("textarea",{name:"chief_complaint",value:O.chief_complaint,onChange:L,disabled:_,rows:3,className:`mt-1 block w-full px-3 py-2 border ${_?"bg-gray-100":"bg-white"} border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm`,placeholder:"請簡述您的不適或求診原因"})]}),t.jsx("h2",{className:"text-xl font-bold mb-4",children:"診所資訊"}),(0,t.jsxs)("div",{className:"mb-6",children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["主診醫師 ",t.jsx("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{name:"doctor_id",value:O.doctor_id?.toString()||"",onChange:e=>{let s=e.target.value?parseInt(e.target.value,10):void 0;T(e=>({...e,doctor_id:s}))},className:"mt-1 block w-full px-3 py-2 border bg-white border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",required:!0,children:[t.jsx("option",{value:"",children:"請選擇醫師"}),n.doctors?.map(e=>t.jsxs("option",{value:e.id.toString(),children:[e.name," ",e.specialty?`(${e.specialty})`:""]},e.id))]})]}),t.jsx("div",{className:"flex justify-end",children:t.jsx("button",{type:"submit",disabled:e,className:"px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-300 flex items-center",children:e?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("svg",{className:"animate-spin -ml-1 mr-2 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[t.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),t.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"處理中..."]}):"提交表單"})})]})})}):(0,t.jsxs)("div",{className:"p-6 bg-white rounded-lg shadow-md",children:[t.jsx("div",{className:"flex items-center justify-center h-40",children:(0,t.jsxs)("div",{className:"animate-pulse flex flex-col items-center",children:[t.jsx("div",{className:"h-12 w-12 rounded-full bg-blue-200 mb-4"}),t.jsx("div",{className:"h-4 w-48 bg-blue-200 rounded mb-2"}),t.jsx("div",{className:"h-3 w-32 bg-blue-100 rounded"})]})}),t.jsx("p",{className:"text-center text-gray-500 mt-4",children:"載入中，請稍候..."})]})};class f extends o.Component{constructor(e){super(e),this.state={hasError:!1,error:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,s){console.error("患者登記頁面錯誤:",e,s)}render(){return this.state.hasError?t.jsx("div",{className:"container mx-auto py-8 px-4",children:(0,t.jsxs)("div",{className:"max-w-4xl mx-auto p-8 bg-red-50 border border-red-200 rounded-lg shadow text-red-800",children:[t.jsx("h2",{className:"text-2xl font-bold mb-4",children:"頁面載入錯誤"}),t.jsx("p",{className:"mb-4",children:"很抱歉，患者登記系統暫時無法使用，請稍後再試。"}),(0,t.jsxs)("details",{className:"mb-4",children:[t.jsx("summary",{className:"cursor-pointer font-medium",children:"技術詳情"}),t.jsx("pre",{className:"mt-2 p-4 bg-red-100 rounded text-sm overflow-auto",children:this.state.error?.toString()})]}),(0,t.jsxs)("div",{className:"flex gap-4",children:[t.jsx("button",{onClick:()=>window.location.reload(),className:"px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"重新載入"}),t.jsx("a",{href:"/appointments",className:"px-6 py-2 bg-gray-600 text-white rounded hover:bg-gray-700",children:"返回預約系統"})]})]})}):this.props.children}}function y(){return t.jsx(f,{children:(0,t.jsxs)("div",{className:"container mx-auto py-8 px-4",children:[t.jsx("h1",{className:"text-3xl font-bold text-center mb-8",children:"患者登記系統"}),t.jsx(b,{})]})})}},20984:(e,s,r)=>{"use strict";r.d(s,{l9:()=>o});var t=r(47665);let o=(e="")=>{let s=e.startsWith("/")?e:`/${e}`;return`https://clinic.aspiratcm.com/api/v1${s}`},i=t.Z.create({baseURL:o(),headers:{"Content-Type":"application/json",Accept:"application/json"},timeout:15e3});i.interceptors.request.use(e=>{if(console.log(`[API請求] ${e.method?.toUpperCase()} ${e.url}`),e.params&&console.log(`[請求參數] ${JSON.stringify(e.params)}`),e.data&&"string"!=typeof e.data)try{console.log(`[請求數據] ${JSON.stringify(e.data)}`)}catch{console.log("[請求數據] 無法序列化")}return e},e=>(console.error("[API請求錯誤]",e),Promise.reject(e))),i.interceptors.response.use(e=>(console.log(`[API響應] ${e.status} ${e.config.url}`),e),e=>{let s=e?.response?.status,r=e?.config?.url,t=e?.config?.method?.toUpperCase();return s?console.error(`[${t} ${r}] 錯誤 ${s}`,e.response.data):console.error("[API錯誤]",e.message),Promise.reject(e)})},61334:(e,s,r)=>{"use strict";r.r(s),r.d(s,{default:()=>d,metadata:()=>n});var t=r(25036);r(5023);let o=(0,r(86843).createProxy)(String.raw`/Users/mountainfung/Desktop/AWS-Aspiratcm_local/frontend/src/app/components/Navbar.tsx`),{__esModule:i,$$typeof:a}=o,l=o.default,n={title:"中醫診所管理系統",description:"診所預約管理系統"};function d({children:e}){return t.jsx("html",{lang:"zh-TW",children:(0,t.jsxs)("body",{suppressHydrationWarning:!0,className:"bg-gray-100 min-h-screen antialiased text-slate-800 font-sans",children:[t.jsx(l,{}),t.jsx("div",{className:"pt-16",children:e})]})})}},19692:(e,s,r)=>{"use strict";r.r(s),r.d(s,{$$typeof:()=>i,__esModule:()=>o,default:()=>a});let t=(0,r(86843).createProxy)(String.raw`/Users/mountainfung/Desktop/AWS-Aspiratcm_local/frontend/src/app/patient_registration/page.tsx`),{__esModule:o,$$typeof:i}=t,a=t.default},5023:()=>{}};var s=require("../../webpack-runtime.js");s.C(e);var r=e=>s(s.s=e),t=s.X(0,[1638,7173,7665],()=>r(4599));module.exports=t})();