(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[142],{3166:function(e,t,s){Promise.resolve().then(s.bind(s,6526))},6526:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return eN}});var r,o,n=s(3827),a=s(4090),i=s(2545),l=e=>{let{isFirstTime:t=0,isTroublesome:s=0,isContagious:r=0,specialNote:o}=e;return(0,n.jsxs)("div",{className:"flex flex-wrap gap-2 my-1",children:[1===t&&(0,n.jsx)("span",{className:"px-2 py-1 text-xs font-medium rounded-md bg-blue-100 text-blue-800",children:"初診"}),1===s&&(0,n.jsx)("span",{className:"px-2 py-1 text-xs font-medium rounded-md bg-orange-100 text-orange-800",children:"⚠️ 特殊情況"}),1===r&&(0,n.jsx)("span",{className:"px-2 py-1 text-xs font-medium rounded-md bg-red-100 text-red-800",children:"⚠️ 傳染病風險"}),o&&(0,n.jsxs)("span",{className:"px-2 py-1 text-xs font-medium rounded-md bg-yellow-100 text-yellow-800 max-w-xs truncate",title:o,children:["\uD83D\uDCDD ",o]})]})},c=e=>{let{isTroublesome:t=0,isContagious:s=0,specialNote:r="",onUpdate:o}=e,[i,l]=(0,a.useState)(1===t),[c,d]=(0,a.useState)(1===s),[u,m]=(0,a.useState)(r||"");return(0,n.jsxs)("div",{className:"p-4 bg-white rounded-lg shadow",children:[(0,n.jsx)("h3",{className:"text-lg font-medium mb-4",children:"特殊患者標記"}),(0,n.jsxs)("div",{className:"mb-4",children:[(0,n.jsxs)("div",{className:"flex items-center mb-2",children:[(0,n.jsx)("input",{type:"checkbox",id:"troublesome",checked:i,onChange:e=>l(e.target.checked),className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),(0,n.jsx)("label",{htmlFor:"troublesome",className:"ml-2 text-sm font-medium text-gray-700",children:"特殊情況患者"})]}),(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)("input",{type:"checkbox",id:"contagious",checked:c,onChange:e=>d(e.target.checked),className:"w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500"}),(0,n.jsx)("label",{htmlFor:"contagious",className:"ml-2 text-sm font-medium text-gray-700",children:"傳染病風險"})]})]}),(0,n.jsxs)("div",{className:"mb-4",children:[(0,n.jsx)("label",{htmlFor:"specialNote",className:"block text-sm font-medium text-gray-700 mb-1",children:"特殊註記"}),(0,n.jsx)("textarea",{id:"specialNote",value:u,onChange:e=>m(e.target.value),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",placeholder:"輸入特殊情況註記..."})]}),(0,n.jsx)("button",{type:"button",onClick:()=>{o({is_troublesome:i?1:0,is_contagious:c?1:0,special_note:u})},className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:"更新標記"})]})},d=s(3370);let u=e=>{if(!e||!Array.isArray(e)||0===e.length)return[];let t=new Map,s=[];e.forEach(e=>{let r={label:e.name+(e.notes?" （".concat(e.notes,"）"):""),value:e.code,notes:e.notes,originalName:e.name,isAlias:!1},o=e.category_name||"未分類";if(o&&"未分類"!==o){var n;t.has(o)||t.set(o,[]),null===(n=t.get(o))||void 0===n||n.push(r)}else s.push(r);e.aliases&&e.aliases.length>0&&e.aliases.forEach(r=>{let n={label:"".concat(r," (又名: ").concat(e.name,")")+(e.notes?" （".concat(e.notes,"）"):""),value:e.code,notes:e.notes,originalName:e.name,isAlias:!0};if(o&&"未分類"!==o){var a;null===(a=t.get(o))||void 0===a||a.push(n)}else s.push(n)})});let r=[];if(Array.from(t.keys()).sort().forEach(e=>{let s=t.get(e)||[];if(s.length>0){let t=s.sort((e,t)=>e.label.localeCompare(t.label,"zh-Hant"));r.push({label:e,options:t})}}),s.length>0){let e=s.sort((e,t)=>e.label.localeCompare(t.label,"zh-Hant"));r.push({label:"未分類",options:e})}return r},m=e=>{if(!e||!Array.isArray(e)||0===e.length)return[];let t=[];return e.forEach(e=>{t.push({label:e.name+(e.notes?" （".concat(e.notes,"）"):""),value:e.code,notes:e.notes,originalName:e.name,isAlias:!1,category:e.category_name,categoryCode:e.category_code,parent:e.parent}),e.aliases&&e.aliases.length>0&&e.aliases.forEach(s=>{t.push({label:"".concat(s," (又名: ").concat(e.name,")")+(e.notes?" （".concat(e.notes,"）"):""),value:e.code,notes:e.notes,originalName:e.name,isAlias:!0,category:e.category_name,categoryCode:e.category_code,parent:e.parent})})}),t.sort((e,t)=>e.label.localeCompare(t.label,"zh-Hant"))},p=(e,t,s)=>{if(!e||e.length<2)return s;let r=e.toLowerCase(),o=t.filter(e=>{let t=e.label.toLowerCase().includes(r),s=!!e.notes&&e.notes.toLowerCase().includes(r),o=!!e.originalName&&e.originalName.toLowerCase().includes(r);return t||s||o}),n=new Set(o.map(e=>e.value));return s.map(e=>{let t=e.options.filter(e=>n.has(e.value));return t.length>0?{label:e.label,options:t}:null}).filter(Boolean)},g=e=>({groupedOptions:u(e),searchableList:m(e)}),h=async()=>{try{let e=await fetch("/data/modern_chinese_disease_name.json");if(!e.ok)throw Error("Failed to load modern diseases data");return await e.json()}catch(e){return console.error("Error loading modern diseases data:",e),[]}},x=async()=>{try{let e=await fetch("/data/tcm_codes_fung_version_full.json");if(!e.ok)throw Error("Failed to load TCM syndromes data");return await e.json()}catch(e){return console.error("Error loading TCM syndromes data:",e),[]}},b=async()=>{try{let e=await fetch("/data/tcm_treatment_rule.json");if(!e.ok)throw Error("Failed to load TCM principles data");return await e.json()}catch(e){return console.error("Error loading TCM principles data:",e),[]}},v=async()=>{let[e,t,s]=await Promise.all([h(),x(),b()]);return{modernDiseases:g(e),cmSyndromes:g(t),cmPrinciples:g(s)}};var y=s(5019),f=s(3343),_=s(8269),j=s(8193);let w=(e,t)=>{var s,r,o,n;let a=t.toLowerCase().trim();if(!a)return!0;let i=e.label.toLowerCase(),l=(null===(r=e.data)||void 0===r?void 0:null===(s=r.notes)||void 0===s?void 0:s.toLowerCase())||"",c=(null===(n=e.data)||void 0===n?void 0:null===(o=n.originalName)||void 0===o?void 0:o.toLowerCase())||"";return i.includes(a)||l.includes(a)||c.includes(a)},N=e=>{let{data:t}=e;return(0,n.jsx)(y.c.Option,{...e,children:(0,n.jsxs)("div",{className:"flex flex-col",children:[(0,n.jsx)("div",{children:t.label}),t.notes&&(0,n.jsx)("div",{className:"text-xs text-gray-500 mt-0.5",children:t.notes})]})})},C=e=>{let{data:t}=e;return(0,n.jsx)(y.c.MultiValue,{...e,children:(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)("span",{children:t.label}),t.notes&&(0,n.jsxs)("span",{className:"ml-1 text-xs text-gray-500",children:["（",t.notes,"）"]})]})})};var S=e=>{let{placeholder:t,options:s=[],loadOptions:r,value:o=[],onChange:i,isMulti:l=!0,allowCreation:c=!1,isAsync:d=!1,isDisabled:u=!1,isLoading:m=!1,noOptionsMessage:p="無符合選項",className:g=""}=e,[h,x]=(0,a.useState)(""),b=e=>(x(e),e),v=e=>{if(!e){i([]);return}Array.isArray(e)?i(e):i([e])},y=e=>{i([...o,{label:e,value:"custom-".concat(Math.random().toString(36).substring(2,9)),originalName:e}]),x("")},S=async e=>{if(!e||e.length<2)return[];try{if(r)return await r(e);return[]}catch(e){return console.error("加載選項失敗",e),[]}},D={control:e=>({...e,padding:"2px",borderColor:"#d1d5db",borderRadius:"0.375rem",minHeight:"38px",boxShadow:"none","&:hover":{borderColor:"#9ca3af"}}),menu:e=>({...e,zIndex:9999,maxHeight:"400px"}),menuList:e=>({...e,maxHeight:"350px"}),group:e=>({...e,paddingTop:"8px",paddingBottom:"8px"}),groupHeading:e=>({...e,fontWeight:"bold",fontSize:"0.9rem",color:"#374151",backgroundColor:"#f9fafb",padding:"6px 12px",margin:"0"}),option:(e,t)=>({...e,backgroundColor:t.isSelected?"#e6f4ff":t.isFocused?"#f0f9ff":void 0,color:"#000",fontWeight:t.isSelected?500:400,padding:"8px 12px"}),multiValue:e=>({...e,backgroundColor:"#e6f4ff",borderRadius:"4px"}),multiValueLabel:e=>({...e,color:"#1f2937",fontWeight:500}),multiValueRemove:e=>({...e,color:"#6b7280",":hover":{backgroundColor:"#dbeafe",color:"#1f2937"}}),input:e=>({...e,color:"#1f2937"}),placeholder:e=>({...e,color:"#9ca3af"})};return(0,n.jsx)("div",{className:"w-full",children:(()=>{let e={placeholder:t,value:l?o:o[0]||null,onChange:v,isMulti:l,isDisabled:u||m,isLoading:m,className:"w-full ".concat(g),classNamePrefix:"react-select",noOptionsMessage:()=>p,onInputChange:b,styles:D,filterOption:w,components:{Option:N,MultiValue:C},ignoreAccents:!0,ignoreCase:!0};return d?(0,n.jsx)(_.Z,{...e,loadOptions:S,defaultOptions:s,cacheOptions:!0}):c?(0,n.jsx)(j.Z,{...e,options:s,onCreateOption:y,formatCreateLabel:e=>'新增: "'.concat(e,'"')}):(0,n.jsx)(f.ZP,{...e,options:s})})()})};let D=e=>{let{children:t}=e;return(0,n.jsx)(d.SV,{fallbackRender:e=>{let{error:t,resetErrorBoundary:s}=e;return(0,n.jsxs)("div",{className:"bg-red-50 p-4 rounded-md border border-red-300",children:[(0,n.jsx)("h3",{className:"text-lg font-medium text-red-800",children:"診斷表單載入錯誤"}),(0,n.jsx)("p",{className:"mt-2 text-sm text-red-700",children:"資料異常，請重新載入頁面"}),(0,n.jsx)("button",{onClick:s,className:"mt-3 px-4 py-2 bg-red-100 text-red-800 rounded-md hover:bg-red-200",children:"重試"}),(0,n.jsx)("p",{className:"mt-2 text-xs text-red-600",children:(null==t?void 0:t.message)||"未知錯誤"})]})},children:t})},P=e=>{let t=(e,t)=>e?Array.isArray(e)?e.map(e=>"string"==typeof e?{code:"".concat(t,"-").concat(Math.random().toString(36).substring(2,9)),name:e}:e&&"object"==typeof e?{code:e.code||"".concat(t,"-").concat(Math.random().toString(36).substring(2,9)),name:e.name||""}:{code:"".concat(t,"-").concat(Math.random().toString(36).substring(2,9)),name:String(e)}):"string"==typeof e&&e.trim()?[{code:"".concat(t,"-").concat(Math.random().toString(36).substring(2,9)),name:e.trim()}]:e&&"object"==typeof e?[{code:e.code||"".concat(t,"-").concat(Math.random().toString(36).substring(2,9)),name:e.name||""}]:[]:[];return{modernDiseases:t(null==e?void 0:e.modernDiseases,"md"),cmSyndromes:t(null==e?void 0:e.cmSyndromes,"cs"),cmPrinciple:t(null==e?void 0:e.cmPrinciple,"cp")}},I=e=>e.map(e=>({label:e.name,value:e.code})),k=e=>e.map(e=>({code:e.value,name:e.originalName||e.label.split(" (又名:")[0].trim()}));var A=e=>{let{initialValues:t,onSave:s}=e,r=(0,a.useMemo)(()=>P(t),[t]),[o,i]=(0,a.useState)(r),[l,c]=(0,a.useState)(!0),[d,u]=(0,a.useState)({groupedOptions:[],searchableList:[]}),[m,g]=(0,a.useState)({groupedOptions:[],searchableList:[]}),[h,x]=(0,a.useState)({groupedOptions:[],searchableList:[]}),b=(0,a.useMemo)(()=>I(o.modernDiseases),[o.modernDiseases]),y=(0,a.useMemo)(()=>I(o.cmSyndromes),[o.cmSyndromes]),f=(0,a.useMemo)(()=>I(o.cmPrinciple),[o.cmPrinciple]);(0,a.useEffect)(()=>{(async()=>{c(!0);try{let e=await v();u(e.modernDiseases),g(e.cmSyndromes),x(e.cmPrinciples),console.log("診斷參考資料已載入並處理完成，共計：",{現代病名:e.modernDiseases.searchableList.length,中醫辨證:e.cmSyndromes.searchableList.length,中醫治則:e.cmPrinciples.searchableList.length})}catch(e){console.error("處理診斷參考資料時發生錯誤:",e)}finally{c(!1)}})()},[]),(0,a.useEffect)(()=>{i(r)},[r]);let _=async e=>!e||e.length<2?d.groupedOptions:p(e,d.searchableList,d.groupedOptions),j=async e=>!e||e.length<2?m.groupedOptions:p(e,m.searchableList,m.groupedOptions),w=async e=>!e||e.length<2?h.groupedOptions:p(e,h.searchableList,h.groupedOptions);return(0,n.jsx)(D,{children:(0,n.jsxs)("div",{className:"bg-white p-4 rounded-md shadow",children:[(0,n.jsx)("h2",{className:"text-lg font-semibold mb-3 text-gray-800 border-b pb-2",children:"中醫診斷"}),l?(0,n.jsxs)("div",{className:"py-4 flex justify-center",children:[(0,n.jsxs)("div",{className:"animate-pulse flex space-x-2",children:[(0,n.jsx)("div",{className:"h-3 w-3 bg-blue-500 rounded-full"}),(0,n.jsx)("div",{className:"h-3 w-3 bg-blue-500 rounded-full"}),(0,n.jsx)("div",{className:"h-3 w-3 bg-blue-500 rounded-full"})]}),(0,n.jsx)("span",{className:"ml-2 text-gray-500",children:"載入診斷選項中..."})]}):(0,n.jsxs)("form",{onSubmit:e=>{e.preventDefault(),s(o)},className:"space-y-6",children:[(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("label",{className:"block text-sm font-medium text-gray-600",children:"現代病名（多選）"}),(0,n.jsx)("div",{className:"border border-gray-300 rounded-md p-2 bg-gray-50",children:(0,n.jsx)(S,{placeholder:"搜尋或選擇現代病名...",options:d.groupedOptions,loadOptions:_,value:b,onChange:e=>{i(t=>({...t,modernDiseases:k(e)}))},isMulti:!0,allowCreation:!0,isAsync:!0,className:"w-full",noOptionsMessage:"無符合的現代病名，可直接輸入新增"})})]}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("label",{className:"block text-sm font-medium text-gray-600",children:"中醫辨證（多選）"}),(0,n.jsx)("div",{className:"border border-gray-300 rounded-md p-2 bg-gray-50",children:(0,n.jsx)(S,{placeholder:"搜尋或選擇中醫辨證...",options:m.groupedOptions,loadOptions:j,value:y,onChange:e=>{i(t=>({...t,cmSyndromes:k(e)}))},isMulti:!0,allowCreation:!0,isAsync:!0,className:"w-full",noOptionsMessage:"無符合的中醫辨證，可直接輸入新增"})})]}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("label",{className:"block text-sm font-medium text-gray-600",children:"中醫治則（多選）"}),(0,n.jsx)("div",{className:"border border-gray-300 rounded-md p-2 bg-gray-50",children:(0,n.jsx)(S,{placeholder:"搜尋或選擇中醫治則...",options:h.groupedOptions,loadOptions:w,value:f,onChange:e=>{i(t=>({...t,cmPrinciple:k(e)}))},isMulti:!0,allowCreation:!0,isAsync:!0,className:"w-full",noOptionsMessage:"無符合的中醫治則，可直接輸入新增"})})]}),(0,n.jsxs)("div",{className:"mt-6 p-4 bg-gray-50 border border-gray-300 rounded-md",children:[(0,n.jsxs)("div",{className:"flex items-center mb-2",children:[(0,n.jsx)("span",{className:"text-gray-700 font-medium",children:"\uD83E\uDD16 AI 推薦診斷"}),(0,n.jsx)("span",{className:"ml-2 px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded",children:"即將推出"})]}),(0,n.jsx)("div",{className:"text-gray-500 text-sm italic",children:(0,n.jsx)("p",{children:"未來將根據患者主訴與觀察資料，自動推薦適合的診斷選項。"})})]}),(0,n.jsx)("div",{className:"flex justify-end",children:(0,n.jsx)("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600",children:"儲存"})})]})]})})},L=e=>{let{options:t=[],placeholder:s,onSelect:r,onSearch:o,value:i,defaultValue:l="",className:c="",multiple:d=!1,selectedItems:u=[],onRemove:m,isLoading:p=!1}=e,[g,h]=(0,a.useState)(i||l||""),[x,b]=(0,a.useState)([]),[v,y]=(0,a.useState)(!1),f=(0,a.useRef)(null),_=(0,a.useRef)(null);(0,a.useEffect)(()=>{void 0!==i&&h(i)},[i]),(0,a.useEffect)(()=>{if(""===g.trim()){b([]);return}o?b(o(g)):t.length>0&&b(t.filter(e=>e.toLowerCase().includes(g.toLowerCase())).map(e=>({key:e,value:e})))},[g,t,o]),(0,a.useEffect)(()=>{let e=e=>{_.current&&!_.current.contains(e.target)&&f.current&&!f.current.contains(e.target)&&y(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[]);let j=e=>{d?(!u.includes(e.value)&&r&&r(e.value,e),h("")):(i||h(e.value),r&&r(e.value,e)),y(!1)};return(0,n.jsxs)("div",{className:"relative w-full",children:[(0,n.jsxs)("div",{className:"flex flex-wrap items-center border rounded-md ".concat(c),children:[d&&u.map((e,t)=>(0,n.jsxs)("div",{className:"flex items-center m-1 px-2 py-1 bg-blue-100 rounded-md",children:[(0,n.jsx)("span",{className:"mr-1",children:e}),(0,n.jsx)("button",{type:"button",onClick:()=>m&&m(e),className:"text-gray-500 hover:text-gray-700",children:"\xd7"})]},"".concat(e,"-").concat(t))),(0,n.jsx)("input",{ref:f,type:"text",value:g,onChange:e=>{h(e.target.value),y(!0)},placeholder:d&&u.length>0?"":s,className:"flex-grow p-2 outline-none ".concat(d?"min-w-[100px]":"w-full"),onFocus:()=>g&&y(!0)}),p&&(0,n.jsx)("div",{className:"mr-2 h-4 w-4 rounded-full border-2 border-blue-500 border-t-transparent animate-spin"})]}),v&&x.length>0&&(0,n.jsx)("div",{ref:_,className:"absolute z-10 w-full mt-1 bg-white shadow-lg rounded-md max-h-60 overflow-y-auto",children:x.map((e,t)=>(0,n.jsx)("div",{className:"px-4 py-2 cursor-pointer hover:bg-gray-100",onClick:()=>j(e),children:e.value},"".concat(e.key,"-").concat(t)))})]})},M=e=>{let{onSave:t,initialChiefComplaint:s=""}=e,[r,o]=(0,a.useState)(s),[i,l]=(0,a.useState)(""),[c,d]=(0,a.useState)({chiefComplaint:"",presentIllness:""});(0,a.useEffect)(()=>{o(s)},[s]);let u=()=>{let e=!0,t={chiefComplaint:"",presentIllness:""};return r.trim()||(t.chiefComplaint="請填寫主訴",e=!1),d(t),e};return(0,n.jsxs)("div",{className:"bg-white p-4 rounded-md shadow",children:[(0,n.jsx)("h2",{className:"text-lg font-semibold mb-3 text-gray-800 border-b pb-2",children:"主訴與現病史"}),(0,n.jsxs)("form",{onSubmit:e=>{e.preventDefault(),u()&&t({chiefComplaint:r,presentIllness:i})},className:"space-y-4",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"主訴"}),(0,n.jsx)("textarea",{value:r,onChange:e=>o(e.target.value),placeholder:"請輸入患者的主要症狀和不適",className:"w-full p-2 border ".concat(c.chiefComplaint?"border-red-500":"border-gray-300"," rounded-md min-h-[80px]")}),c.chiefComplaint&&(0,n.jsx)("p",{className:"mt-1 text-sm text-red-600",children:c.chiefComplaint})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"現病史"}),(0,n.jsx)("textarea",{value:i,onChange:e=>l(e.target.value),placeholder:"請輸入患者的發病時間、經過、治療史等",className:"w-full p-2 border ".concat(c.presentIllness?"border-red-500":"border-gray-300"," rounded-md min-h-[120px]")}),c.presentIllness&&(0,n.jsx)("p",{className:"mt-1 text-sm text-red-600",children:c.presentIllness})]}),(0,n.jsx)("div",{className:"flex justify-end",children:(0,n.jsx)("button",{type:"submit",className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:"保存"})})]})]})},O=s(4525),E=s.n(O),R=s(3107),F=s(5585);function T(e){if(null==e||"object"==typeof e&&(0===Object.keys(e).length||Array.isArray(e)&&0===e.length))return"";if("object"==typeof e&&!Array.isArray(e))try{return JSON.stringify(e)}catch(e){return console.warn("無法將物件轉為 JSON 字串:",e),""}return"string"==typeof e?e.trim():String(e)}function q(e){return Array.isArray(e)?e:null==e?[]:[e]}let U=[];R.Z.create({baseURL:"https://clinic.aspiratcm.com/api/v1",timeout:1e4,headers:{"Content-Type":"application/json"}});let H=async function(e,t,s){var r,o,n,a,i,l,c,d,u,m,p,g;let h=arguments.length>3&&void 0!==arguments[3]?arguments[3]:3,x=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1e3,b=0,v=null;for(;b<h;)try{let r;let o=(0,F.l9)(t);if(console.log("嘗試 ".concat(e.toUpperCase()," 請求到: ").concat(o)),"get"===e.toLowerCase())r=await R.Z.get(o,{params:s,timeout:1e4});else if("post"===e.toLowerCase())r=await R.Z.post(o,s,{timeout:1e4});else if("put"===e.toLowerCase())r=await R.Z.put(o,s,{timeout:1e4});else if("patch"===e.toLowerCase())r=await R.Z.patch(o,s,{timeout:1e4});else if("delete"===e.toLowerCase())r=await R.Z.delete(o,{timeout:1e4});else throw Error("不支持的HTTP方法: ".concat(e));return r.data}catch(e){if(v=e,(null===(o=e.response)||void 0===o?void 0:o.status)===404){console.log("資源不存在: ".concat(t),null===(c=e.response)||void 0===c?void 0:c.data);let s=null===(d=e.response)||void 0===d?void 0:d.data,r=(null==s?void 0:s.detail)||"資源不存在";throw Error("找不到資源: ".concat(r))}if((null===(n=e.response)||void 0===n?void 0:n.status)===400){console.log("請求參數錯誤: ".concat(t),null===(u=e.response)||void 0===u?void 0:u.data);let s=null===(m=e.response)||void 0===m?void 0:m.data,r=(null==s?void 0:s.detail)||"請求參數錯誤";throw Error("請求參數錯誤: ".concat(r))}if((null===(a=e.response)||void 0===a?void 0:a.status)===401)throw console.log("未授權訪問: ".concat(t)),Error("您的登錄狀態已過期，請重新登錄");if((null===(i=e.response)||void 0===i?void 0:i.status)&&e.response.status>=400&&e.response.status<500){console.log("客戶端錯誤: ".concat(t),null===(p=e.response)||void 0===p?void 0:p.data);let s=null===(g=e.response)||void 0===g?void 0:g.data,r=(null==s?void 0:s.detail)||"請求出現錯誤";throw Error("請求錯誤: ".concat(r))}b++,console.log("API請求失敗 (".concat(b,"/").concat(h,")..."),e),console.log("請求URL: ".concat(t)),console.log("錯誤詳情:",(null===(l=e.response)||void 0===l?void 0:l.data)||e.message),await new Promise(e=>setTimeout(e,x*Math.pow(2,b-1)))}let y="系統暫時無法連接，請稍後再試";throw(null==v?void 0:null===(r=v.response)||void 0===r?void 0:r.status)===500?y="系統內部錯誤，請聯繫技術支持":(null==v?void 0:v.code)==="ECONNABORTED"?y="連接超時，請檢查網絡連接":(null==v?void 0:v.message)&&(y="請求失敗: ".concat(v.message)),console.error("重試 ".concat(h," 次後仍然失敗:"),t,v),Error(y)},z={getPatientRecords:async e=>{try{return console.log("正在獲取患者病歷，患者ID:",e),await H("get","/medical-records/by-patient/".concat(e))}catch(t){throw console.error("獲取患者病歷失敗，患者ID: ".concat(e,":"),t),t}},getRecordById:async e=>{try{return console.log("正在獲取病歷詳情，記錄ID:",e),await H("get","/medical-records/".concat(e))}catch(t){throw console.error("獲取病歷詳情失敗，記錄ID: ".concat(e,":"),t),t}},createRecord:async e=>{try{console.log("收到病歷資料，準備清洗資料並轉換格式:",e);let n=function(e){if(!e)return{};let t={...e};if(["chief_complaint","present_illness","observation","left_pulse","right_pulse","tongue_quality","tongue_shape","tongue_color","tongue_coating","prescription_instructions"].forEach(e=>{e in t&&(t[e]=T(t[e]))}),"observation"in t){if("object"==typeof t.observation&&null!==t.observation)try{t.observation=JSON.stringify(t.observation)}catch(e){console.warn("無法將 observation 物件轉為 JSON 字串:",e),t.observation=""}else(null===t.observation||void 0===t.observation)&&(t.observation="")}return t.diagnosis_structured&&(null===t.diagnosis_structured.modernDiseases||void 0===t.diagnosis_structured.modernDiseases?t.diagnosis_structured.modernDiseases=[]:t.diagnosis_structured.modernDiseases=q(t.diagnosis_structured.modernDiseases),null===t.diagnosis_structured.cmSyndromes||void 0===t.diagnosis_structured.cmSyndromes?t.diagnosis_structured.cmSyndromes=[]:t.diagnosis_structured.cmSyndromes=q(t.diagnosis_structured.cmSyndromes),null===t.diagnosis_structured.cmPrinciple||void 0===t.diagnosis_structured.cmPrinciple?t.diagnosis_structured.cmPrinciple=[]:t.diagnosis_structured.cmPrinciple=q(t.diagnosis_structured.cmPrinciple)),t.diagnosis&&"object"==typeof t.diagnosis&&null!==t.diagnosis&&(null===t.diagnosis.modern_diseases||void 0===t.diagnosis.modern_diseases?t.diagnosis.modern_diseases=[]:t.diagnosis.modern_diseases=q(t.diagnosis.modern_diseases),null===t.diagnosis.cm_syndromes||void 0===t.diagnosis.cm_syndromes?t.diagnosis.cm_syndromes=[]:t.diagnosis.cm_syndromes=q(t.diagnosis.cm_syndromes)),t}(e);console.log("清理後的資料:",n);let a={...n};if(n.diagnosis_structured){var t,s,r,o;let e=n.diagnosis_structured;a.diagnosis={modern_diseases:(e.modernDiseases||[]).map(e=>e.code||e.name||""),cm_syndromes:(e.cmSyndromes||[]).map(e=>e.code||e.name||""),cm_principle:(null===(s=e.cmPrinciple)||void 0===s?void 0:null===(t=s[0])||void 0===t?void 0:t.code)||(null===(o=e.cmPrinciple)||void 0===o?void 0:null===(r=o[0])||void 0===r?void 0:r.name)||void 0},delete a.diagnosis_structured}else a.diagnosis||(a.diagnosis={modern_diseases:[],cm_syndromes:[],cm_principle:""});return n.prescription&&Array.isArray(n.prescription)&&(a.prescription={instructions:T(n.prescription_instructions||""),structured_instructions:n.prescription_structured_instructions||{total_days:7,times_per_day:2,timing:"早晚服"},herbs:n.prescription.map((e,t)=>({herb_name:e.name||"",amount:e.amount||e.powder_amount||"0",unit:e.unit||"g",sequence:t,source:"manual",structured_data:{price_per_gram:e.price_per_gram||0,total_price:e.total_price||0,brand:e.brand||"",is_compound:e.is_compound||!1,code:e.code||""}}))}),a.prescription?a.prescription&&!a.prescription.herbs&&(a.prescription={instructions:a.prescription_instructions||"",structured_instructions:a.prescription_structured_instructions||{total_days:7,times_per_day:2,timing:"早晚服"},herbs:a.prescription}):a.prescription={instructions:"",structured_instructions:{total_days:7,times_per_day:2,timing:"早晚服"},herbs:[]},delete a.prescription_instructions,delete a.prescription_structured_instructions,console.log("轉換後準備發送的病歷資料:",a),await H("post","/medical-records",a)}catch(e){throw console.error("創建病歷失敗:",e),e}},updateRecord:async(e,t)=>{try{return console.log("正在更新病歷，記錄ID: ".concat(e,":"),t),await H("put","/medical-records/".concat(e),t)}catch(t){throw console.error("更新病歷失敗，記錄ID: ".concat(e,":"),t),t}}},V={getPatientById:async e=>{try{if(console.log("正在獲取患者資料，患者ID:",e),!e)throw Error("缺少有效的患者ID");let t=await H("get","/patient_registration/".concat(e)),s=W(t);return console.log("清理後的患者資料:",s),s}catch(s){if(console.error("獲取患者資料失敗，患者ID: ".concat(e,":"),s),s.response){var t;throw console.error("API響應狀態: ".concat(s.response.status)),console.error("請求URL: ".concat(null===(t=s.config)||void 0===t?void 0:t.url)),console.error("回應數據: ",s.response.data),Error("獲取患者資料失敗(".concat(s.response.status,"): 可能是程式邏輯錯誤，請通知技術人員"))}throw s}},getPatientByPhoneNumber:async e=>{try{console.log("正在獲取患者資料，電話號碼:",e);let t=e.replace(/[\s\-\(\)]/g,"");try{console.log("嘗試使用查詢參數格式 API 端點");let e=await R.Z.get((0,F.l9)("/patients/by-phone-number?phone=".concat(t)),{timeout:5e3});console.log("成功獲取患者資料（查詢參數格式）");let s=W(e.data);return console.log("清理後的患者資料:",s),s}catch(r){console.warn("使用新 API 端點失敗，嘗試舊式端點格式:",null==r?void 0:r.message),console.log("嘗試使用原始路徑參數格式 API 端點（即將淘汰）");let e=await H("get","/patient_registration/by-phone-number/".concat(t,"/")),s=W(e);return console.log("清理後的患者資料:",s),s}}catch(s){if(console.error("獲取患者資料失敗，電話號碼: ".concat(e,":"),s),s.response){var t;throw console.error("API響應狀態: ".concat(s.response.status)),console.error("請求URL: ".concat(null===(t=s.config)||void 0===t?void 0:t.url)),console.error("回應數據: ",s.response.data),Error("獲取患者資料失敗(".concat(s.response.status,"): 可能是程式邏輯錯誤，請通知技術人員"))}throw s}},updatePatient:async(e,t)=>{try{return console.log("正在更新患者資料，患者ID: ".concat(e,":"),t),await H("patch","/patients/".concat(e),t)}catch(t){if(console.error("更新患者資料失敗，患者ID: ".concat(e,":"),t),t.response){var s;throw console.error("API響應狀態: ".concat(t.response.status)),console.error("請求URL: ".concat(null===(s=t.config)||void 0===s?void 0:s.url)),console.error("回應數據: ",t.response.data),Error("更新患者資料失敗(".concat(t.response.status,"): 可能是程式邏輯錯誤，請通知技術人員"))}throw t}},updatePatientMarkers:async(e,t)=>{try{let s=await fetch("".concat((0,F.l9)("/patients/".concat(e))),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!s.ok)throw console.error("API響應狀態: ".concat(s.status)),console.error("請求URL: ".concat((0,F.l9)("/patients/".concat(e)))),Error("更新患者標記失敗(".concat(s.status,"): 可能是程式邏輯錯誤，請通知技術人員"));return await s.json()}catch(e){throw console.error("更新患者標記時出錯:",e),e}}};function W(e){if(!e)return{};let t={...e};if(["basic_diseases","drug_allergies","food_allergies"].forEach(e=>{e in t&&null!==t[e]&&void 0!==t[e]?Array.isArray(t[e])||(t[e]=[t[e]]):t[e]=[]}),["note","chief_complaint","special_note"].forEach(e=>{e in t&&(null===t[e]||void 0===t[e])&&(t[e]="")}),"observation"in t){if(null===t.observation||void 0===t.observation||"object"==typeof t.observation&&0===Object.keys(t.observation).length)t.observation="";else if("object"==typeof t.observation)try{t.observation=JSON.stringify(t.observation)}catch(e){console.warn("將 observation 對象轉換為字符串時出錯:",e),t.observation=""}}return t.medical_records&&Array.isArray(t.medical_records)&&(t.medical_records=t.medical_records.map(e=>{if(!e)return e;if("observation"in e){if(null===e.observation||void 0===e.observation||"object"==typeof e.observation&&0===Object.keys(e.observation).length)e.observation="";else if("object"==typeof e.observation)try{e.observation=JSON.stringify(e.observation)}catch(t){console.warn("將醫療記錄中的 observation 對象轉換為字符串時出錯:",t),e.observation=""}}return e.diagnosis&&(e.diagnosis.modern_diseases&&null!==e.diagnosis.modern_diseases||(e.diagnosis.modern_diseases=[]),e.diagnosis.cm_syndromes&&null!==e.diagnosis.cm_syndromes||(e.diagnosis.cm_syndromes=[])),e})),"is_troublesome"in t&&null===t.is_troublesome&&(t.is_troublesome=0),"is_contagious"in t&&null===t.is_contagious&&(t.is_contagious=0),t}let B={getWaitingList:async()=>{try{console.log("正在從掛號系統獲取候診名單");let e="/patient_registration/waiting-list";console.log("使用候診清單端點: ".concat(e)),console.log("完整 URL: ".concat((0,F.l9)(e)));let t=await H("get",e);if(console.log("候診清單響應:",t),!Array.isArray(t))return console.warn("候診名單響應不是數組格式:",t),[];return t}catch(t){if(console.error("獲取候診名單失敗:",t),t.response){var e;console.error("API響應狀態: ".concat(t.response.status)),console.error("請求URL: ".concat(null===(e=t.config)||void 0===e?void 0:e.url)),console.error("回應數據: ",t.response.data)}return[]}},removePatientFromWaitingList:async e=>{try{return console.log("正在從候診清單中移除患者，ID: ".concat(e)),await H("delete","/patient_registration/waiting-list/".concat(e))}catch(s){if(console.error("從候診清單中移除患者失敗，ID: ".concat(e,":"),s),s.response){var t;throw console.error("API響應狀態: ".concat(s.response.status)),console.error("請求URL: ".concat(null===(t=s.config)||void 0===t?void 0:t.url)),console.error("回應數據: ",s.response.data),Error("從候診清單中移除患者失敗(".concat(s.response.status,"): 可能是程式邏輯錯誤，請通知技術人員"))}throw s}},updateStatus:async(e,t)=>{try{return console.log("正在更新預約狀態：ID=".concat(e,", 狀態=").concat(t)),await H("patch","/appointments/".concat(e,"/status"),{status:t})}catch(t){if(console.error("更新預約狀態失敗：ID=".concat(e),t),t.response){var s;throw console.error("API響應狀態: ".concat(t.response.status)),console.error("請求URL: ".concat(null===(s=t.config)||void 0===s?void 0:s.url)),console.error("回應數據: ",t.response.data),Error("更新預約狀態失敗(".concat(t.response.status,"): 可能是程式邏輯錯誤，請通知技術人員"))}throw t}},createFollowUp:async e=>{try{return console.log("正在創建覆診預約:",e),await H("post","/appointments",e)}catch(e){if(console.error("創建覆診預約失敗:",e),e.response){var t;throw console.error("API響應狀態: ".concat(e.response.status)),console.error("請求URL: ".concat(null===(t=e.config)||void 0===t?void 0:t.url)),console.error("回應數據: ",e.response.data),Error("創建覆診預約失敗(".concat(e.response.status,"): 可能是程式邏輯錯誤，請通知技術人員"))}throw e}}},J={getAllModernDiseases:async()=>{try{console.log("正在獲取所有現代病名資料");let e=await H("get","/reference-data/modern-diseases");return(null==e?void 0:e.data)||[]}catch(e){return console.error("獲取現代病名資料失敗:",e),[]}},getModernDiseaseTree:async()=>{try{return console.log("正在獲取現代病名樹狀數據"),await H("get","/reference-data/modern-disease-tree")||[]}catch(e){return console.error("獲取現代病名樹狀數據失敗:",e),[]}},getAllCMSyndromes:async()=>{try{console.log("正在獲取所有中醫證候資料");let e=await H("get","/reference-data/cm-syndromes");return(null==e?void 0:e.data)||[]}catch(e){return console.error("獲取中醫證候資料失敗:",e),[]}},getCMSyndromeTree:async()=>{try{return console.log("正在獲取中醫證候樹狀數據"),await H("get","/reference-data/cm-syndrome-tree")||[]}catch(e){return console.error("獲取中醫證候樹狀數據失敗:",e),[]}},getAllTreatmentPrinciples:async()=>{try{console.log("正在獲取所有中醫治則資料");let e=await H("get","/reference-data/tcm-principles");return(null==e?void 0:e.data)||[]}catch(e){return console.error("獲取中醫治則資料失敗:",e),[]}},getTreatmentPrincipleTree:async()=>{try{return console.log("正在獲取中醫治則樹狀數據"),await H("get","/reference-data/cm-treatment-rule-tree")||[]}catch(e){return console.error("獲取中醫治則樹狀數據失敗:",e),[]}},getCMSyndromeAutocomplete:async()=>{try{return console.log("正在獲取中醫辨證自動完成數據"),await H("get","/reference-data/cm-syndrome-autocomplete")||[]}catch(e){return console.error("獲取中醫辨證自動完成數據失敗:",e),[]}},getModernDiseaseAutocomplete:async()=>{try{return console.log("正在獲取現代病名自動完成數據"),await H("get","/reference-data/modern-disease-autocomplete")||[]}catch(e){return console.error("獲取現代病名自動完成數據失敗:",e),[]}},getTreatmentPrincipleAutocomplete:async()=>{try{return console.log("正在獲取中醫治則自動完成數據"),await H("get","/reference-data/cm-treatment-rule-autocomplete")||[]}catch(e){return console.error("獲取中醫治則自動完成數據失敗:",e),[]}},searchModernDiseases:async e=>{try{if(console.log("正在搜尋現代病名: ".concat(e)),!e)return[];let t=await H("get","/reference-data/search/modern-diseases?q=".concat(encodeURIComponent(e)));return(null==t?void 0:t.data)||[]}catch(t){return console.error("搜尋現代病名失敗: ".concat(e),t),[]}},searchCMSyndromes:async e=>{try{if(console.log("正在搜尋中醫證候: ".concat(e)),!e)return[];let t=await H("get","/reference-data/search/cm-syndromes?q=".concat(encodeURIComponent(e)));return(null==t?void 0:t.data)||[]}catch(t){return console.error("搜尋中醫證候失敗: ".concat(e),t),[]}},searchTreatmentRules:async e=>{try{if(console.log("正在搜尋中醫治則: ".concat(e)),!e)return[];let t=await H("get","/reference-data/search/tcm-principles?q=".concat(encodeURIComponent(e)));return(null==t?void 0:t.data)||[]}catch(t){return console.error("搜尋中醫治則失敗: ".concat(e),t),[]}},searchMedicines:async e=>{try{if(console.log("正在搜尋中藥: ".concat(e)),U&&U.length>0){let t=U.filter(t=>{var s;return t.name.toLowerCase().includes(e.toLowerCase())||(null===(s=t.aliases)||void 0===s?void 0:s.some(t=>t.toLowerCase().includes(e.toLowerCase())))});return console.log("從已載入的中藥資料中找到 ".concat(t.length," 筆結果")),t}try{let t=await fetch("/data/powder_ratio_price.json");if(t.ok){let s=(await t.json()).filter(t=>{var s;return t.name.toLowerCase().includes(e.toLowerCase())||(null===(s=t.aliases)||void 0===s?void 0:s.some(t=>t.toLowerCase().includes(e.toLowerCase())))});return console.log("從本地檔案搜尋中藥結果: ".concat(s.length," 筆")),s}}catch(e){console.error("讀取或搜尋本地中藥數據失敗:",e)}let t="/herbs?search=".concat(encodeURIComponent(e),"&limit=50");console.log("使用中藥搜尋端點: ".concat(t));let s=await H("get",t);if((null==s?void 0:s.items)&&Array.isArray(s.items))return console.log("API返回中藥搜尋結果: ".concat(s.items.length," 筆")),s.items||[];if(Array.isArray(s))return console.log("API返回中藥搜尋結果: ".concat(s.length," 筆")),s;return console.warn("API返回的中藥搜尋結果格式不正確:",s),[]}catch(t){return console.error("搜尋中藥失敗: ".concat(e),t),[]}},getPowderRatioPrice:async()=>{try{try{console.log("嘗試從本地檔案獲取中藥資料");let e=await fetch("/data/powder_ratio_price.json");if(e.ok){let t=await e.json();return console.log("成功從本地檔案獲取中藥資料，共",t.length,"筆"),t&&t.length>0&&(U=t),t}console.error("本地檔案獲取失敗:",e.statusText)}catch(e){console.error("讀取本地中藥數據失敗:",e)}console.log("正在從API獲取中藥粉末與飲片換算資料");let e=await H("get","/herbs/powder-ratio-price");return console.log("成功從API獲取中藥資料，共",e.length,"筆"),e&&e.length>0&&(U=e),e||[]}catch(e){console.error("從API獲取中藥粉末與飲片換算資料失敗:",e);try{console.log("再次嘗試從本地檔案獲取中藥資料");let e=await fetch("/data/powder_ratio_price.json");if(e.ok){let t=await e.json();return console.log("成功從本地檔案獲取中藥資料，共",t.length,"筆"),t&&t.length>0&&(U=t),t}}catch(e){console.error("讀取本地中藥數據失敗:",e)}return[]}}};var Z=e=>{let{placeholder:t,onChange:s,loadOptions:r,value:o,defaultValue:i=[],className:l="",multiple:c=!0,disabled:d=!1,labelExtractor:u=e=>e.name||"",valueExtractor:m=e=>e.code||""}=e,[p,g]=(0,a.useState)([]),[h,x]=(0,a.useState)(""),[b,v]=(0,a.useState)(!1),[y,f]=(0,a.useState)(i),[_,j]=(0,a.useState)(!1),w=(0,a.useCallback)(E()(async e=>{if(!e||e.length<1){g([]);return}v(!0);try{let t=await r(e);g(t)}catch(e){console.error("搜尋選項失敗:",e),g([])}finally{v(!1)}},300),[r]),N=e=>{if(c){if(!y.some(t=>t.value===e.value)){let t=[...y,e];f(t),s(t)}}else f([e]),s([e]);x(""),g([]),j(!1)},C=e=>{let t=y.filter(t=>t.value!==e.value);f(t),s(t)};(0,a.useEffect)(()=>{o&&f(o)},[o]),(0,a.useEffect)(()=>()=>{w.cancel()},[w]),(0,a.useEffect)(()=>{let e=e=>{e.target.closest(".async-select-container")||j(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[]);let S=e=>{if(e.label.includes(" - ")){let t=e.label.split(" - "),s=t[0].trim(),r=t[1].trim();return(0,n.jsxs)("div",{className:"flex flex-col",children:[(0,n.jsx)("span",{className:"font-medium",children:s}),(0,n.jsx)("span",{className:"text-gray-500 text-xs mt-1",children:r})]})}if(e.data&&e.data.brand){let t=e.data.brand,s={},r=null;return t.toLowerCase().includes("漢方")?(s={color:"#2563eb"},r=(0,n.jsx)("span",{className:"ml-1 px-1 py-0.5 text-xs bg-blue-100 text-blue-800 rounded",children:"漢方"})):t.toLowerCase().includes("海天")&&(s={color:"#16a34a"},r=(0,n.jsx)("span",{className:"ml-1 px-1 py-0.5 text-xs bg-green-100 text-green-800 rounded",children:"海天"})),(0,n.jsxs)("div",{className:"flex flex-col",children:[(0,n.jsx)("span",{className:"font-medium",children:e.label}),(0,n.jsxs)("div",{className:"flex items-center mt-1",children:[(0,n.jsx)("span",{className:"text-gray-500 text-xs",style:s,children:t}),r]})]})}return(0,n.jsx)("span",{children:e.label})};return(0,n.jsxs)("div",{className:"async-select-container relative w-full ".concat(l),children:[(0,n.jsxs)("div",{className:"flex flex-wrap items-center w-full p-2 border border-gray-300 rounded-md focus-within:border-blue-500",children:[y.map(e=>(0,n.jsxs)("div",{className:"flex items-center m-1 px-2 py-1 bg-blue-100 text-blue-800 rounded-md",children:[(0,n.jsx)("span",{className:"mr-1",children:e.label}),(0,n.jsx)("button",{type:"button",onClick:()=>C(e),className:"text-blue-500 hover:text-blue-700",children:"\xd7"})]},e.value)),(0,n.jsx)("input",{type:"text",value:h,onChange:e=>{let{value:t}=e.target;x(t),w(t),t.length>0&&j(!0)},placeholder:y.length>0?"":t,className:"flex-grow min-w-[100px] outline-none",disabled:d,onFocus:()=>j(!0),readOnly:!c&&y.length>0}),b&&(0,n.jsx)("div",{className:"ml-2 h-4 w-4 rounded-full border-2 border-blue-500 border-t-transparent animate-spin"})]}),_&&p.length>0&&(0,n.jsx)("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto",children:p.map(e=>(0,n.jsx)("div",{className:"px-4 py-2 cursor-pointer hover:bg-gray-100",onClick:()=>N(e),children:S(e)},e.value))}),_&&h&&!b&&0===p.length&&(0,n.jsx)("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg p-2 text-center text-gray-500",children:"無符合結果"})]})};(r=o||(o={})).NORMAL="normal",r.LOW="low",r.OUT_OF_STOCK="out_of_stock",r.UNKNOWN="unknown";let Q=(0,a.forwardRef)((e,t)=>{let{initialValues:s,onSave:r}=e,o={herbs:[],instructions:"",structured_instructions:{total_days:7,times_per_day:2,timing:"早晚服"},total_price:0,per_dose_price:0},[i,l]=(0,a.useState)(s||{...o,herbs:[_()]}),[c,d]=(0,a.useState)([]),[u,m]=(0,a.useState)(!1),[p,g]=(0,a.useState)({}),[h,x]=(0,a.useState)(!0),[b,v]=(0,a.useState)([]),[y,f]=(0,a.useState)(!1);function _(){return{id:Date.now().toString(),code:"",name:"",brand:"",powder_amount:"",decoction_amount:"",price_per_gram:0,total_price:0,unit:"g",is_compound:!1,concentration_ratio:1,decoction_equivalent_per_g:1,inventory_status:"unknown",source:"manual"}}(0,a.useEffect)(()=>{(async()=>{f(!0);try{let e=await J.getPowderRatioPrice();v(e),console.log("載入中藥資料成功，共",e.length,"筆")}catch(e){console.error("載入中藥資料失敗:",e)}finally{f(!1)}})()},[]),(0,a.useEffect)(()=>{let e=i.herbs.reduce((e,t)=>e+t.total_price,0),t=i.structured_instructions.total_days*i.structured_instructions.times_per_day*e;l(s=>({...s,total_price:t,per_dose_price:e}))},[i.herbs,i.structured_instructions.total_days,i.structured_instructions.times_per_day]);let j=async e=>{if(!e||e.length<1)return[];m(!0);try{if(b.length>0)return b.filter(t=>{var s;return t.name.toLowerCase().includes(e.toLowerCase())||(null===(s=t.aliases)||void 0===s?void 0:s.some(t=>t.toLowerCase().includes(e.toLowerCase())))}).map(e=>{let t=w(e);return{label:"".concat(e.name," - ").concat(e.brand||"未知品牌"),value:e.code,data:{...e,price_per_gram:t}}});return(await J.searchMedicines(e)).map(e=>{let t=w(e);return{label:"".concat(e.name," - ").concat(e.brand||"未知品牌"),value:e.code,data:{...e,price_per_gram:t}}})}catch(e){return console.error("搜尋中藥失敗:",e),[]}finally{m(!1)}},w=e=>"number"==typeof e.price_per_gram&&!isNaN(e.price_per_gram)&&e.price_per_gram>0?e.price_per_gram:"number"!=typeof e.price||"number"!=typeof e.quantity_per_bottle||isNaN(e.price)||isNaN(e.quantity_per_bottle)||!(e.quantity_per_bottle>0)?0:e.price/e.quantity_per_bottle,N=async(e,t)=>{try{let s=await fetch("/api/v1/herbs/inventory/check",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({herb_code:e,required_powder_amount:t})});if(s.ok){let t=await s.json();g(s=>({...s,[e]:t})),l(s=>({...s,herbs:s.herbs.map(s=>{if(s.code===e){let e="normal";return!1===t.has_sufficient_stock&&(e=t.available_amount>0?"low":"out_of_stock"),{...s,inventory_status:e}}return s})}))}}catch(e){console.error("Error checking inventory:",e)}},C=(0,a.useMemo)(()=>E()((e,t)=>N(e,t),500),[]);(0,a.useEffect)(()=>(i.herbs.forEach(e=>{if(e.code&&e.powder_amount){let t=parseFloat(e.powder_amount);!isNaN(t)&&t>0&&C(e.code,t)}}),()=>{C.cancel()}),[i.herbs,C]);let S=e=>{l(t=>({...t,herbs:t.herbs.filter(t=>t.id!==e)}))},D=(e,t)=>{if(0===t.length)return;let s=t[0].data;s&&l(t=>({...t,herbs:t.herbs.map(t=>{if(t.id===e){let e=w(s),r={...t,code:s.code,name:s.name,brand:s.brand||"",is_compound:s.is_compound||!1,ingredients:s.ingredients,registration_code:s.registration_code,concentration_ratio:s.concentration_ratio||1,decoction_equivalent_per_g:s.decoction_equivalent_per_g||1,price_per_gram:e,unit:s.unit||"g",source:t.source||"manual"};if(t.decoction_amount){let o=parseFloat(t.decoction_amount);if(!isNaN(o)){let t=P(o,s.decoction_equivalent_per_g,s.concentration_ratio);r.powder_amount=t.toFixed(1),r.total_price=t*e}}if(t.powder_amount&&!t.decoction_amount){let o=parseFloat(t.powder_amount);if(!isNaN(o)){let t=I(o,s.decoction_equivalent_per_g,s.concentration_ratio);r.decoction_amount=t.toFixed(1),r.total_price=o*e}}return r}return t})}))},P=(e,t,s)=>e/t*s,I=(e,t,s)=>e/s*t,k=(e,t)=>{l(s=>({...s,herbs:s.herbs.map(s=>{if(s.id===e){let e=parseFloat(t)||0,r="",o=e*(s.price_per_gram||0);return e>0&&(r=I(e,s.decoction_equivalent_per_g,s.concentration_ratio).toFixed(1)),{...s,powder_amount:t,decoction_amount:r,total_price:o}}return s})}))},A=(e,t)=>{l(s=>({...s,herbs:s.herbs.map(s=>{if(s.id===e){let e=parseFloat(t)||0,r="",o=0;if(e>0){let t=P(e,s.decoction_equivalent_per_g,s.concentration_ratio);r=t.toFixed(1),o=t*(s.price_per_gram||0)}return{...s,decoction_amount:t,powder_amount:r,total_price:o}}return s})}))},L=e=>{l(t=>({...t,instructions:e}))},M=(e,t)=>{let s="string"==typeof t?parseInt(t)||0:t;l(t=>({...t,structured_instructions:{...t.structured_instructions,[e]:s},instructions:"共".concat(s,"天，每日").concat(t.structured_instructions.times_per_day,"次，").concat(t.structured_instructions.timing)}))},O=e=>{l(t=>({...t,structured_instructions:{...t.structured_instructions,timing:e},instructions:"共".concat(t.structured_instructions.total_days,"天，每日").concat(t.structured_instructions.times_per_day,"次，").concat(e)}))},R=()=>({herbs:i.herbs.map(e=>({id:e.id,code:e.code,name:e.name,brand:e.brand,powder_amount:e.powder_amount,decoction_amount:e.decoction_amount,price_per_gram:e.price_per_gram,total_price:e.total_price,unit:e.unit,is_compound:e.is_compound,concentration_ratio:e.concentration_ratio,decoction_equivalent_per_g:e.decoction_equivalent_per_g,inventory_status:e.inventory_status,source:e.source,ingredients:e.ingredients})),instructions:i.instructions,structured_instructions:i.structured_instructions,total_price:i.total_price,per_dose_price:i.per_dose_price});(0,a.useImperativeHandle)(t,()=>({addHerb:e=>{if(i.herbs.some(t=>t.code===e.code||t.name===e.name)){alert("處方中已存在相同藥材：".concat(e.name));return}let t={id:Date.now().toString(),code:e.code||"",name:e.name||"",brand:e.brand||"",powder_amount:e.amount||"3",decoction_amount:"",price_per_gram:e.price_per_gram||0,total_price:parseFloat(e.amount||"3")*(e.price_per_gram||0)||0,unit:"g",is_compound:!1,concentration_ratio:e.concentration_ratio||1,decoction_equivalent_per_g:e.decoction_equivalent_per_g||1,inventory_status:"unknown",source:e.source||"AI_suggested"};l(e=>({...e,herbs:[...e.herbs,t]}))},resetForm:()=>{console.log("重置中藥處方表單"),l({...o,herbs:[_()]})}}));let F=e=>e.name&&e.code?[{label:"".concat(e.name," - ").concat(e.brand||"未知品牌"),value:e.code,data:e}]:[],T=e=>{switch(e){case"normal":return"bg-green-100 text-green-800";case"low":return"bg-yellow-100 text-yellow-800";case"out_of_stock":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}},q=e=>{switch(e){case"normal":return"庫存正常";case"low":return"庫存偏低";case"out_of_stock":return"庫存不足";default:return"庫存狀態未知"}};return(0,n.jsxs)("div",{className:"bg-white p-4 rounded-md shadow",children:[(0,n.jsx)("h2",{className:"text-lg font-semibold mb-3 text-gray-800 border-b pb-2",children:"中藥處方"}),(0,n.jsxs)("form",{onSubmit:e=>{e.preventDefault(),r(R())},className:"space-y-4",children:[(0,n.jsxs)("div",{className:"border rounded-md overflow-hidden shadow-sm",children:[(0,n.jsxs)("div",{className:"grid grid-cols-12 bg-gray-100 p-2 border-b font-medium text-sm",children:[(0,n.jsx)("div",{className:"col-span-3",children:"中藥名稱"}),(0,n.jsx)("div",{className:"col-span-2",children:"藥粉量 (g)"}),(0,n.jsx)("div",{className:"col-span-2",children:"飲片量 (g)"}),(0,n.jsx)("div",{className:"col-span-2",children:"品牌/規格"}),(0,n.jsx)("div",{className:"col-span-1 text-right pr-2",children:"單價 ($/g)"}),(0,n.jsx)("div",{className:"col-span-1 text-right pr-2",children:"小計 ($)"}),(0,n.jsx)("div",{className:"col-span-1 text-center",children:"操作"})]}),(0,n.jsx)("div",{className:"divide-y",children:i.herbs.map((e,t)=>{let s="AI_suggested"===e.source,r=T(e.inventory_status),o=q(e.inventory_status),a="";e.brand&&(e.brand.toLowerCase().includes("漢方")?a="bg-blue-50":e.brand.toLowerCase().includes("海天")?a="bg-green-50":e.brand.toLowerCase().includes("香港中文大學")&&(a="bg-yellow-50"));let i=!e.name||!e.code,l=i?"搜尋並選擇藥材":"搜尋中藥名稱";return(0,n.jsxs)("div",{className:"grid grid-cols-12 p-2 items-center text-sm ".concat(s?"bg-green-50":a),children:[(0,n.jsxs)("div",{className:"col-span-3 pr-2 relative",children:[s&&(0,n.jsx)("span",{className:"absolute -left-1 -top-1 z-10 text-xs bg-green-500 text-white px-1 py-0.5 rounded-full",children:"AI"}),(0,n.jsx)(Z,{placeholder:l,loadOptions:j,onChange:t=>D(e.id,t),value:F(e),multiple:!1,className:"w-full",disabled:!1}),e.is_compound&&e.ingredients&&e.ingredients.length>0&&(0,n.jsxs)("div",{className:"mt-1 p-1 bg-gray-50 text-xs rounded-md",children:[(0,n.jsx)("div",{className:"font-medium text-gray-700",children:"複方成分:"}),(0,n.jsx)("ul",{className:"list-disc pl-3",children:e.ingredients.map((e,t)=>(0,n.jsxs)("li",{children:[e.name," ",e.amount,"g"]},t))})]})]}),(0,n.jsx)("div",{className:"col-span-2 pr-2",children:(0,n.jsx)("input",{type:"text",value:e.powder_amount,onChange:t=>k(e.id,t.target.value),placeholder:"藥粉量",className:"w-full p-2 border border-gray-300 rounded-md",disabled:i})}),(0,n.jsx)("div",{className:"col-span-2 pr-2",children:(0,n.jsx)("input",{type:"text",value:e.decoction_amount,onChange:t=>A(e.id,t.target.value),placeholder:"飲片量",className:"w-full p-2 border border-gray-300 rounded-md",disabled:i})}),(0,n.jsx)("div",{className:"col-span-2 pr-2 text-xs",children:(0,n.jsxs)("div",{className:"flex flex-col",children:[e.brand?(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)("span",{className:"font-medium",children:e.brand}),e.brand.toLowerCase().includes("漢方")&&(0,n.jsx)("span",{className:"ml-1 px-1 py-0.5 text-xs bg-blue-100 text-blue-800 rounded",children:"漢方"}),e.brand.toLowerCase().includes("海天")&&(0,n.jsx)("span",{className:"ml-1 px-1 py-0.5 text-xs bg-green-100 text-green-800 rounded",children:"海天"})]}):(0,n.jsx)("span",{className:"font-medium text-gray-500",children:"未知品牌"}),!i&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("span",{className:"text-gray-500",children:["濃縮比: ",e.concentration_ratio,":1"]}),(0,n.jsx)("span",{className:"mt-1 px-1.5 py-0.5 rounded-full text-center ".concat(r),children:o})]})]})}),(0,n.jsx)("div",{className:"col-span-1 pr-2 text-right font-medium",children:(e.price_per_gram||0).toFixed(2)}),(0,n.jsx)("div",{className:"col-span-1 pr-2 text-right font-medium",children:(e.total_price||0).toFixed(2)}),(0,n.jsx)("div",{className:"col-span-1 flex justify-center",children:(0,n.jsx)("button",{type:"button",onClick:()=>S(e.id),className:"text-red-500 hover:text-red-700 w-6 h-6 flex items-center justify-center rounded-full hover:bg-red-100",title:"刪除此藥材",children:"\xd7"})})]},e.id)})}),(0,n.jsx)("div",{className:"p-3 bg-gray-50 flex justify-center",children:(0,n.jsxs)("button",{type:"button",onClick:()=>{l(e=>({...e,herbs:[...e.herbs,_()]}))},className:"px-4 py-1.5 text-sm bg-blue-100 text-blue-700 hover:bg-blue-200 rounded-md shadow-sm flex items-center",children:[(0,n.jsx)("span",{className:"mr-1 font-bold",children:"+"})," 新增藥材"]})})]}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("label",{className:"block text-sm font-medium text-gray-600",children:"服法"}),(0,n.jsxs)("div",{className:"flex flex-wrap gap-4 items-center",children:[(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)("span",{className:"mr-2",children:"共"}),(0,n.jsx)("select",{value:i.structured_instructions.total_days,onChange:e=>M("total_days",e.target.value),className:"p-1.5 border border-gray-300 rounded-md w-16 text-center",children:[1,2,3,4,5,6,7,8,9,10,14,21,28].map(e=>(0,n.jsx)("option",{value:e,children:e},e))}),(0,n.jsx)("span",{className:"ml-2",children:"天"})]}),(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)("span",{className:"mr-2",children:"每日"}),(0,n.jsx)("select",{value:i.structured_instructions.times_per_day,onChange:e=>M("times_per_day",e.target.value),className:"p-1.5 border border-gray-300 rounded-md w-16 text-center",children:[1,2,3,4].map(e=>(0,n.jsx)("option",{value:e,children:e},e))}),(0,n.jsx)("span",{className:"ml-2",children:"次"})]}),(0,n.jsx)("div",{className:"flex items-center",children:(0,n.jsxs)("select",{value:i.structured_instructions.timing,onChange:e=>O(e.target.value),className:"p-1.5 border border-gray-300 rounded-md",children:[(0,n.jsx)("option",{value:"早晚服",children:"早晚服"}),(0,n.jsx)("option",{value:"午晚服",children:"午晚服"}),(0,n.jsx)("option",{value:"三餐服",children:"三餐服"}),(0,n.jsx)("option",{value:"早中晚服",children:"早中晚服"}),(0,n.jsx)("option",{value:"睡前服",children:"睡前服"}),(0,n.jsx)("option",{value:"飯前服",children:"飯前服"}),(0,n.jsx)("option",{value:"飯後服",children:"飯後服"}),(0,n.jsx)("option",{value:"自行安排",children:"自行安排"})]})})]}),(0,n.jsx)("input",{type:"text",value:i.instructions,onChange:e=>L(e.target.value),placeholder:"自定義服法說明",className:"w-full p-2 border border-gray-300 rounded-md mt-2"})]}),(0,n.jsxs)("div",{className:"flex justify-between items-center",children:[(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)("input",{type:"checkbox",id:"showPriceInfo",checked:h,onChange:()=>x(!h),className:"mr-2"}),(0,n.jsx)("label",{htmlFor:"showPriceInfo",className:"text-sm text-gray-700",children:"顯示價格信息"})]}),h&&(0,n.jsxs)("div",{className:"text-right p-2 bg-blue-50 rounded-md space-y-1",children:[(0,n.jsxs)("p",{className:"text-sm font-medium text-blue-600",children:["每服處方價錢: ",(0,n.jsxs)("span",{children:[i.per_dose_price.toFixed(2)," HKD"]})]}),(0,n.jsxs)("p",{className:"text-xl font-bold text-blue-700",children:["處方總價: ",(0,n.jsxs)("span",{children:[i.total_price.toFixed(2)," HKD"]})]})]})]}),(0,n.jsxs)("div",{className:"flex justify-between items-center mt-2",children:[(0,n.jsx)("button",{type:"button",onClick:()=>{try{if(0===i.herbs.length){alert("處方中沒有藥材，無法儲存模板");return}let e=prompt("請輸入處方模板名稱:");if(!e)return;let t=localStorage.getItem("prescription_templates"),s=t?JSON.parse(t):[],r={id:Date.now().toString(),name:e,herbs:i.herbs,instructions:i.instructions,structured_instructions:i.structured_instructions,created_at:new Date().toISOString()};localStorage.setItem("prescription_templates",JSON.stringify([...s,r])),alert("處方模板儲存成功")}catch(e){console.error("儲存處方模板失敗:",e),alert("儲存處方模板失敗")}},className:"text-sm text-blue-600 hover:underline",children:"儲存為處方模板"}),(0,n.jsx)("button",{type:"button",onClick:()=>{try{let e=localStorage.getItem("prescription_templates");if(!e){alert("沒有儲存的處方模板");return}let t=JSON.parse(e);if(0===t.length){alert("沒有儲存的處方模板");return}let s=t.map((e,t)=>"".concat(t+1,". ").concat(e.name)).join("\n"),r=parseInt(prompt("請選擇要載入的模板號碼:\n".concat(s))||"0")-1;if(isNaN(r)||r<0||r>=t.length){alert("選擇無效");return}let o=t[r];l({herbs:o.herbs,instructions:o.instructions,structured_instructions:o.structured_instructions,total_price:o.herbs.reduce((e,t)=>e+t.total_price,0)*o.structured_instructions.total_days*o.structured_instructions.times_per_day,per_dose_price:o.herbs.reduce((e,t)=>e+t.total_price,0)}),alert("處方模板載入成功")}catch(e){console.error("載入處方模板失敗:",e),alert("載入處方模板失敗")}},className:"text-sm text-blue-600 hover:underline",children:"載入處方模板"})]}),(0,n.jsx)("div",{className:"flex justify-end",children:(0,n.jsx)("button",{type:"submit",className:"bg-blue-500 text-white px-6 py-2 rounded-md hover:bg-blue-600 shadow-sm",children:"儲存處方"})})]})]})});Q.displayName="HerbalPrescriptionForm";let K=["正常","浮","沉","遲","數","滑","澀","虛","實","長","短","洪","微","緊","緩","弦","芤","革","牢","濡","弱","散","細","伏","動","促","結","代","大"],Y=["寸","關","尺","整體"],$=["正常","柔嫩","老嫩適中","硬","老","嫩","榮潤","枯槁","光剝","乾燥","潤澤","裂紋","紫斑","瘀斑","齒痕","重舌","瘦小","黏膩","水滑"],G=["正常舌","胖大舌","瘦薄舌","尖細舌","短小舌","痿軟舌","齒痕舌","裂紋舌","橫裂舌","腫脹舌","短縮舌","舌中凹陷舌","舌尖翹起舌","舌尖凹","舌體偏小舌","舌根腫大舌","舌體斜裂舌","卷縮舌","歪斜舌","歪扭舌","顫動舌","強硬舌","雙舌尖舌","點狀舌頭突出舌"],X=["正常","淡紅","紅","絳","深紅","暗紅","淡白","蒼白","枯白","青紫","紫","淡紫","紅紫","絳紫","舌尖紅","尖邊紅","瘀斑","淡紫瘀堵","底瘀絡粗","底瘀絡怒張","底瘀絡紫紅","底瘀絡紫黑","底有瘀點"],ee=["正常","無苔","薄苔","厚苔","白苔","薄白苔","薄白潤苔","薄白滑苔","厚白","白膩苔","白滑膩苔","白黏膩苔","白厚膩苔","白厚鬆苔","白膩苔化燥","黃苔","薄黃苔","黃厚膩苔","黃膩苔","黃黏膩苔","黃滑苔","黃燥苔","黃瓣苔","黃膩苔化燥","黄厚黏腻苔","灰苔","灰白膩苔","灰黃膩苔","垢腻灰苔","黑苔","黑腻苔","焦黑苔","黑燥苔","膩苔","滑苔","乾苔","燥苔","潤苔","腐苔","剝苔","無根苔","膩苔中剝","類剝苔","地圖舌","鏡面舌","舌面潰瘍","舌底潰瘍","舌邊潰瘍","根部厚膩","薄膩","厚膩"],et={正常:["正常"],偏軟型:["柔嫩","榮潤","潤澤","嫩"],偏硬型:["硬","老","老嫩適中"],萎縮型:["枯槁","光剝","乾燥","瘦小"],其他特徵:["黏膩","水滑","裂紋","瘀斑","紫斑","重舌","齒痕"]},es={正常:["正常舌"],腫大型:["胖大舌","舌根腫大舌","腫脹舌"],萎縮型:["瘦薄舌","短小舌","痿軟舌","尖細舌","舌體偏小舌","短縮舌"],裂紋型:["裂紋舌","橫裂舌","舌體斜裂舌","齒痕舌"],歪斜型:["歪斜舌","歪扭舌"],強硬型:["強硬舌","卷縮舌"],其他特殊型:["舌尖翹起舌","舌尖凹","舌中凹陷舌","雙舌尖舌","點狀舌頭突出舌","顫動舌"]},er={正常色:["正常","淡紅"],紅色系:["紅","深紅","暗紅","絳"],蒼白系:["淡白","蒼白","枯白"],紫色系:["青紫","紫","淡紫","紅紫","絳紫"],舌尖變化:["舌尖紅","尖邊紅"],舌底瘀絡:["底瘀絡粗","底瘀絡怒張","底瘀絡紫紅","底瘀絡紫黑","底有瘀點"],其他:["瘀斑","淡紫瘀堵"]},eo={正常:["正常"],無苔類:["無苔"],基本厚薄:["薄苔","厚苔"],白苔類:["白苔","薄白苔","薄白潤苔","薄白滑苔","厚白","白膩苔","白滑膩苔","白黏膩苔","白厚膩苔","白厚鬆苔","白膩苔化燥"],黃苔類:["黃苔","薄黃苔","黃厚膩苔","黃膩苔","黃黏膩苔","黃滑苔","黃燥苔","黃瓣苔","黃膩苔化燥","黄厚黏腻苔"],灰黑苔類:["灰苔","灰白膩苔","灰黃膩苔","垢腻灰苔","黑苔","黑腻苔","焦黑苔","黑燥苔"],剝苔類:["剝苔","膩苔中剝","類剝苔","地圖舌","鏡面舌"],特性類:["膩苔","滑苔","乾苔","燥苔","潤苔","腐苔","無根苔"],分佈特性:["舌面潰瘍","舌底潰瘍","舌邊潰瘍","根部厚膩","薄膩","厚膩"]},en=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],s={整體:1,寸:2,關:3,尺:4},r={};return t.forEach(e=>{r[e]=[]}),t.forEach(t=>{e.forEach(e=>{r[t].push({label:"".concat(t).concat(e),value:"".concat(t).concat(e)})})}),Object.keys(r).sort((e,t)=>(s[e]||99)-(s[t]||99)).map(e=>({label:e,options:r[e]}))},ea=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0,s=[],r=new Set;Object.entries(t).forEach(t=>{let[o,n]=t,a=[];n.forEach(t=>{e.includes(t)&&(a.push({label:t,value:t}),r.add(t))}),a.length>0&&s.push({label:o,options:a})});let o=e.filter(e=>!r.has(e)).map(e=>({label:e,value:e}));return o.length>0&&s.push({label:"其他",options:o}),s},ei=()=>en(K,Y),el=()=>ea($,et),ec=()=>ea(G,es),ed=()=>ea(X,er),eu=()=>ea(ee,eo);var em=e=>{var t,s;let{initialValues:r={observation:"",leftPulse:[],rightPulse:[],tongueQuality:[],tongueShape:[],tongueColor:[],tongueCoating:[],menstrualPeriod:{startDate:"",endDate:""}},onSave:o,showMenstrualField:i=!1}=e,[l,c]=(0,a.useState)(r),[d]=(0,a.useState)(ei()),[u]=(0,a.useState)(el()),[m]=(0,a.useState)(ec()),[p]=(0,a.useState)(ed()),[g]=(0,a.useState)(eu()),h=(e,t)=>{let s=t.map(e=>e.value);c(t=>({...t,[e]:s}))},x=(e,t)=>{c(s=>({...s,[e]:t}))},b=(e,t)=>{c(s=>({...s,menstrualPeriod:{...s.menstrualPeriod,[e]:t}}))};return(0,n.jsxs)("div",{className:"bg-white p-4 rounded-md shadow",children:[(0,n.jsx)("h2",{className:"text-lg font-semibold mb-3 text-gray-800 border-b pb-2",children:"醫師觀察"}),(0,n.jsxs)("form",{onSubmit:e=>{e.preventDefault(),o(l)},className:"space-y-4",children:[(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("label",{className:"block text-sm font-medium text-gray-600",children:"望診觀察"}),(0,n.jsx)("textarea",{value:l.observation,onChange:e=>x("observation",e.target.value),className:"w-full p-2 border border-gray-300 rounded-md",placeholder:"請輸入望診觀察內容",rows:3})]}),(0,n.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("label",{className:"block text-sm font-medium text-gray-600",children:"左手脈象（多選）"}),(0,n.jsx)("div",{children:(0,n.jsx)(S,{placeholder:"從分類選擇左手脈象",options:d,value:l.leftPulse.map(e=>({label:e,value:e})),onChange:e=>h("leftPulse",e),isMulti:!0,allowCreation:!0,className:"w-full",noOptionsMessage:"無符合的脈象，可直接輸入新增"})})]}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("label",{className:"block text-sm font-medium text-gray-600",children:"右手脈象（多選）"}),(0,n.jsx)("div",{children:(0,n.jsx)(S,{placeholder:"從分類選擇右手脈象",options:d,value:l.rightPulse.map(e=>({label:e,value:e})),onChange:e=>h("rightPulse",e),isMulti:!0,allowCreation:!0,className:"w-full",noOptionsMessage:"無符合的脈象，可直接輸入新增"})})]})]}),(0,n.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("label",{className:"block text-sm font-medium text-gray-600",children:"舌質（多選）"}),(0,n.jsx)("div",{children:(0,n.jsx)(S,{placeholder:"從分類選擇舌質",options:u,value:l.tongueQuality.map(e=>({label:e,value:e})),onChange:e=>h("tongueQuality",e),isMulti:!0,allowCreation:!0,className:"w-full",noOptionsMessage:"無符合的舌質，可直接輸入新增"})})]}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("label",{className:"block text-sm font-medium text-gray-600",children:"舌型（多選）"}),(0,n.jsx)("div",{children:(0,n.jsx)(S,{placeholder:"從分類選擇舌型",options:m,value:l.tongueShape.map(e=>({label:e,value:e})),onChange:e=>h("tongueShape",e),isMulti:!0,allowCreation:!0,className:"w-full",noOptionsMessage:"無符合的舌型，可直接輸入新增"})})]}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("label",{className:"block text-sm font-medium text-gray-600",children:"舌色（多選）"}),(0,n.jsx)("div",{children:(0,n.jsx)(S,{placeholder:"從分類選擇舌色",options:p,value:l.tongueColor.map(e=>({label:e,value:e})),onChange:e=>h("tongueColor",e),isMulti:!0,allowCreation:!0,className:"w-full",noOptionsMessage:"無符合的舌色，可直接輸入新增"})})]}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("label",{className:"block text-sm font-medium text-gray-600",children:"舌苔（多選）"}),(0,n.jsx)("div",{children:(0,n.jsx)(S,{placeholder:"從分類選擇舌苔",options:g,value:l.tongueCoating.map(e=>({label:e,value:e})),onChange:e=>h("tongueCoating",e),isMulti:!0,allowCreation:!0,className:"w-full",noOptionsMessage:"無符合的舌苔，可直接輸入新增"})})]})]}),i&&(0,n.jsxs)("div",{className:"border p-3 rounded-md bg-gray-50",children:[(0,n.jsx)("h3",{className:"text-md font-medium mb-2",children:"上次月經"}),(0,n.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[(0,n.jsxs)("div",{className:"space-y-1",children:[(0,n.jsx)("label",{className:"block text-sm text-gray-600",children:"起始日"}),(0,n.jsx)("input",{type:"date",value:(null===(t=l.menstrualPeriod)||void 0===t?void 0:t.startDate)||"",onChange:e=>b("startDate",e.target.value),className:"w-full p-2 border border-gray-300 rounded-md"})]}),(0,n.jsxs)("div",{className:"space-y-1",children:[(0,n.jsx)("label",{className:"block text-sm text-gray-600",children:"結束日"}),(0,n.jsx)("input",{type:"date",value:(null===(s=l.menstrualPeriod)||void 0===s?void 0:s.endDate)||"",onChange:e=>b("endDate",e.target.value),className:"w-full p-2 border border-gray-300 rounded-md"})]}),(0,n.jsx)("div",{className:"space-y-1 flex items-end",children:(0,n.jsxs)("div",{className:"p-2 bg-white border border-gray-300 rounded-md w-full",children:[(0,n.jsx)("span",{className:"font-medium",children:(()=>{var e,t;if(!(null===(e=l.menstrualPeriod)||void 0===e?void 0:e.startDate)||!(null===(t=l.menstrualPeriod)||void 0===t?void 0:t.endDate))return 0;let s=new Date(l.menstrualPeriod.startDate);return Math.ceil(Math.abs(new Date(l.menstrualPeriod.endDate).getTime()-s.getTime())/864e5)+1})()})," 天"]})})]})]}),(0,n.jsx)("div",{className:"flex justify-end",children:(0,n.jsx)("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600",children:"儲存"})})]})]})},ep=e=>{let{onSave:t,onPrint:s,onScheduleFollowUp:r,onNextPatient:o,onCopyLastPrescription:a,isLoading:i=!1}=e;return(0,n.jsx)("div",{className:"bg-white p-4 rounded-md shadow",children:(0,n.jsxs)("div",{className:"flex flex-wrap gap-3 justify-end",children:[(0,n.jsxs)("button",{type:"button",onClick:t,disabled:i,className:"px-5 py-2 rounded ".concat(i?"bg-blue-300 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"," text-white"),children:[(0,n.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 mr-1",viewBox:"0 0 20 20",fill:"currentColor",children:(0,n.jsx)("path",{fillRule:"evenodd",d:"M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z",clipRule:"evenodd"})}),i?"保存中...":"保存病歷"]}),(0,n.jsxs)("button",{type:"button",onClick:s,disabled:i,className:"px-5 py-2 rounded ".concat(i?"bg-green-300 cursor-not-allowed":"bg-green-600 hover:bg-green-700"," text-white"),children:[(0,n.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 mr-1",viewBox:"0 0 20 20",fill:"currentColor",children:(0,n.jsx)("path",{fillRule:"evenodd",d:"M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z",clipRule:"evenodd"})}),"列印藥方"]}),(0,n.jsxs)("button",{type:"button",onClick:r,disabled:i,className:"px-5 py-2 rounded ".concat(i?"bg-purple-300 cursor-not-allowed":"bg-purple-600 hover:bg-purple-700"," text-white"),children:[(0,n.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 mr-1",viewBox:"0 0 20 20",fill:"currentColor",children:(0,n.jsx)("path",{fillRule:"evenodd",d:"M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z",clipRule:"evenodd"})}),"預約覆診"]}),(0,n.jsxs)("button",{type:"button",onClick:o,disabled:i,className:"px-5 py-2 rounded ".concat(i?"bg-gray-300 cursor-not-allowed":"bg-gray-600 hover:bg-gray-700"," text-white"),children:[(0,n.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 mr-1",viewBox:"0 0 20 20",fill:"currentColor",children:[(0,n.jsx)("path",{fillRule:"evenodd",d:"M10.293 15.707a1 1 0 010-1.414L14.586 10l-4.293-4.293a1 1 0 111.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0z",clipRule:"evenodd"}),(0,n.jsx)("path",{fillRule:"evenodd",d:"M4.293 15.707a1 1 0 010-1.414L8.586 10 4.293 5.707a1 1 0 011.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0z",clipRule:"evenodd"})]}),"下一位患者"]}),a&&(0,n.jsx)("button",{type:"button",onClick:a,className:"py-2 px-4 bg-gray-100 text-gray-700 rounded hover:bg-gray-200",title:"複製上次處方",children:(0,n.jsx)("span",{className:"flex items-center",children:"複製上次處方"})})]})})},eg=e=>{let{records:t,onViewRecord:s,patientName:r}=e;return(0,n.jsxs)("div",{className:"bg-white rounded-md shadow overflow-hidden",children:[(0,n.jsx)("div",{className:"p-3 bg-green-500 text-white font-medium",children:r?"".concat(r," 的過往病歷"):"過往病歷"}),(0,n.jsx)("div",{className:"overflow-y-auto max-h-[calc(100vh-10rem)]",children:t.length>0?(0,n.jsx)("div",{className:"divide-y",children:t.map(e=>(0,n.jsxs)("div",{className:"p-3 hover:bg-gray-100 cursor-pointer",onClick:()=>s(e.id),children:[(0,n.jsx)("div",{className:"font-medium mb-1 text-gray-800",children:e.date}),(0,n.jsxs)("div",{className:"text-sm text-gray-600 mb-1",children:[(0,n.jsx)("span",{className:"font-medium",children:"診斷: "}),e.diagnosis]}),(0,n.jsxs)("div",{className:"text-sm text-gray-600",children:[(0,n.jsx)("span",{className:"font-medium",children:"處方: "}),(0,n.jsx)("span",{className:"text-gray-500",children:e.prescription})]})]},e.id))}):(0,n.jsx)("div",{className:"p-4 text-center text-gray-500 italic",children:r?"此患者無過往病歷":"請先選擇患者"})})]})};let eh=["頸椎","胸椎","腰椎","薦椎","尾椎","肩關節","肩胛骨","鎖骨","胸骨","肘關節","腕關節","指關節","髖關節","膝關節","踝關節","趾關節","骶髂關節","顳顎關節","枕骨","枕環關節","齒狀突","脊柱整體","骨盆整體","四肢整體","上肢","下肢","骶椎","椎體旋轉","側彎","關節錯位"],ex=["一重穴","三叉一穴","三叉三穴","三叉二穴","三叉神經點","三河穴","三焦俞","三神穴","三聖穴","三角灸穴","三重穴","三間","三陰交","三陽絡","上九里穴","上巨虛","上廉","上星","上曲穴","上泉穴","上瘤穴","上白穴","上脘","上里穴","上關","上髎","上高穴","下九里穴","下巨虛","下廉","下曲穴","下泉穴","下白穴","下脘","下關","下髎","下高穴","不容","丘墟","中九里穴","中力穴","中封","中府","中庭","中極","中樞","中泉穴","中注","中渚","中瀆","中白穴","中脘","中膂俞","中衝","中都","中間穴","中髎","乳中","乳根","二角明穴","二重穴","二間","五樞","五處","交信","京門","京骨","人士穴","人宗穴","人皇穴","人迎","伏兔","俞府","俠溪","俠白","偏歷","偏肩穴","側三里穴","側下三里","側間穴","僕參","光明","光明穴","兌端","內庭","內白穴","內通天穴","內通山穴","內通關穴","內金穴","內關","公孫","六完穴","其正穴","其角穴","其門穴","其黃穴","分枝上穴","分枝下穴","分枝中穴","分水穴","分白穴","分金穴","列缺","制污穴","前會穴","前谷","前頂","勞宮","厥陰俞","合谷","合金穴","合陽","周榮","命門","商丘","商曲","商陽","啞門","喉中穴","喉靈穴","四滿","四瀆","四白","四神聰穴","四縫穴","四腑一穴","四腑二穴","四花上穴","四花下穴","四花中穴","四花副穴","四花外穴","囟會","土昌穴","土水穴","土耳穴","土靈穴","地五會","地倉","地士穴","地宗穴","地機","地皇穴","外三關穴","外丘","外白穴","外耳穴","外關","外陵","大包","大巨","大敦","大杼","大椎","大橫","大白穴","大腸俞","大赫","大迎","大都","大鐘","大間穴","大陵","天井","天士穴","天宗","天宗穴","天容","天府","天柱","天樞","天池","天泉","天溪","天牖","天皇副穴","天皇穴","天突","天窗","天耳穴","天衝","天髎","天黃穴","天鼎","太乙","太淵","太溪","太白","太衝","太陽穴","失枕穴","失音穴","姐妹一穴","姐妹三穴","姐妹二穴","委中","委陽","婦科五穴","婦靈一穴","婦靈二穴","子宮穴","孔最","安眠穴","安脊穴","完骨","定喘穴","小海","小腸俞","小間穴","少商","少府","少海","少澤","少白穴","少衝","尺澤","居髎","屋翳","崑崙","州圓穴","州天穴","州崙穴","州昆穴","州銀穴","州靈穴","巨闕","巨骨","巨髎","帶脈","幽門","府舍","庫房","廉泉","建中穴","建力穴","建里","強間","彧中","後會穴","後溪","後頂","復原一穴","復原三穴","復原二穴","復溜","心俞","心常一穴","心常三穴","心常二穴","心膝穴","心門穴","心靈一穴","心靈三穴","心靈二穴","志室","急脈","意舍","感冒一穴","感冒二穴","懸樞","懸釐","懸鐘","懸顱","手三里","手五里","手五金穴","手千金穴","手解穴","扶突","承光","承山","承扶","承泣","承滿","承漿","承筋","承靈","指三重穴","指腎穴","指駟馬穴","攢竹","支正","支溝","日月","明黃穴","曲垣","曲差","曲池","曲泉","曲澤","曲陵穴","曲骨","曲鬢","會宗","會陰","會陽","期門","木一穴","木三穴","木二穴","木婦穴","木府穴","木斗穴","木昌穴","木梁穴","木火四穴","木炎一穴","木炎三穴","木炎二穴","木留穴","木硬穴","木耳穴","木關穴","本神","李白穴","束骨","梁丘","梁門","條口","極泉","橫骨","次髎","止涎五穴","正士穴","正宗穴","正會穴","正本穴","正營","正筋穴","正脊一穴","正脊三穴","正脊二穴","步廊","歷兌","歸來","殷門","氣戶","氣海","氣海俞","氣穴","氣舍","氣衝","水仙穴","水分","水曲穴","水泉","水海穴","水清穴","水源穴","水溝","水相穴","水突","水耳穴","水腰穴","水通穴","水道","水金穴","浮白","浮郄","海豹穴","消濼","液門","淵腋","清冷淵","湧泉","溫溜","滑肉門","漏谷","火串穴","火主穴","火包穴","火山穴","火府穴","火散穴","火昌穴","火星上穴","火星下穴","火梁穴","火硬穴","火耳穴","火腑海穴","火菊穴","火連穴","火陵穴","然谷","照海","牽正穴","犢鼻","狹心點","率谷","玉堂","玉枕","珠圓穴","璇璣","環跳","甲狀腺腫穴","申脈","瘛脈","白環俞","百會","皮膚穴","目窗","眉衝","睛明","督俞","瞳子髎","石門","石關","神堂","神封","神庭","神耳上穴","神耳下穴","神耳中穴","神肩穴","神藏","神道","神門","神闕","禾髎","秉風","秩邊","章門","筋縮","箕門","築賓","素髎","紫宮","結核穴","絕陽","絡卻","絲竹空","經渠","維道","總樞穴","缺盆","翳風","耳三穴","耳和髎","耳尖穴","耳門","聽宮","聽會","肓俞","肓門","肘髎","肝俞","肝門穴","肝靈穴","肩中俞","肩中穴","肩井","肩外俞","肩峰穴","肩貞","肩髃","肩髎","肺俞","肺心穴","肺氣腫點","肺金穴","胃俞","胃倉","背面穴","胞肓","胸鄉","脊中","脾俞","脾腫一穴","脾腫二穴","腎俞","腑快穴","腑腸穴","腕順一穴","腕順二穴","腕骨","腦戶","腦空","腫瘤穴","腰俞","腰痛點穴","腰陽關","腸門穴","腹哀","腹結","腹通谷","膀胱俞","膈俞","膈關","膏肓","膝眼穴","膝關","膝陽關","膺窗","膻中","膽俞","膽囊穴","膽穴","臂臑","臑俞","臑會","至陰","至陽","興奮穴","花骨一穴","花骨三穴","花骨四穴","華蓋","落枕穴","蠡溝","血海","行間","衝門","衝陽","角孫","解溪","解穴","譩譆","豐隆","足三里","足五里","足五金穴","足千金穴","足竅陰","足臨泣","足通骨","跗陽","踝靈穴","身柱","輒筋","迎香","通天","通天穴","通山穴","通心穴","通胃穴","通背穴","通腎穴","通里","通關穴","通靈穴","還巢穴","郄門","重仙穴","重子穴","重魁穴","金前上穴","金前下穴","金府穴","金昌穴","金梁穴","金津玉液穴","金耳穴","金門","鎮靜穴","長強","門金穴","開脾穴","間使","關元","關元俞","關衝","關門","阿是穴","附分","降壓穴","陰交","陰包","陰市","陰廉","陰谷","陰郄","陰都","陰陵泉","陶道","陷谷","陽交","陽池","陽溪","陽白","陽綱","陽谷","陽輔","陽陵泉","隱白","雙龍一穴","雙龍二穴","雲白穴","雲門","靈台","靈墟","靈道","靈骨穴","青靈","項緊穴","頭竅陰","頭維","頭臨泣","頰車","頷厭","顱息","顴髎","風市","風府","風池","風門","飛揚","食竇","養老","馬快水穴","馬金水穴","駟馬上穴","駟馬下穴","駟馬中穴","骨關穴","髀關","魂門","魄戶","魚際","鳩尾","鼻翼穴","齦交"],eb=["針灸","正骨","艾灸","天灸","穴位埋線","耳穴","其他手法"];var ev=e=>{let{initialValues:t={treatments:[{method:"",targets:[],id:"0"}]},onSave:s}=e,[r,o]=(0,a.useState)(t),i=e=>{o(t=>({...t,treatments:t.treatments.filter(t=>t.id!==e)}))},l=(e,t)=>{o(s=>({...s,treatments:s.treatments.map(s=>s.id===e?{...s,method:t,targets:[]}:s)}))},c=(e,t)=>{o(s=>({...s,treatments:s.treatments.map(s=>s.id===e?{...s,targets:[...s.targets,t]}:s)}))},d=(e,t)=>{o(s=>({...s,treatments:s.treatments.map(s=>s.id===e?{...s,targets:s.targets.filter(e=>e!==t)}:s)}))},u=(e,t)=>{o(s=>({...s,treatments:s.treatments.map(s=>s.id===e?{...s,targets:[t]}:s)}))},m=e=>{switch(e){case"正骨":return eh;case"針灸":case"艾灸":case"天灸":case"穴位埋線":case"耳穴":return ex;default:return[]}};return(0,n.jsxs)("div",{className:"bg-white p-4 rounded-md shadow",children:[(0,n.jsx)("h2",{className:"text-lg font-semibold mb-3 text-gray-800 border-b pb-2",children:"中醫治療方法"}),(0,n.jsxs)("form",{onSubmit:e=>{e.preventDefault(),s(r)},className:"space-y-4",children:[(0,n.jsx)("div",{className:"space-y-4",children:r.treatments.map((e,t)=>(0,n.jsxs)("div",{className:"border rounded-md p-3 bg-gray-50",children:[(0,n.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,n.jsxs)("h3",{className:"font-medium",children:["治療方法 ",t+1]}),r.treatments.length>1&&(0,n.jsx)("button",{type:"button",onClick:()=>i(e.id),className:"text-red-500 hover:text-red-700",children:"移除"})]}),(0,n.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[(0,n.jsxs)("div",{className:"space-y-1",children:[(0,n.jsx)("label",{className:"block text-sm text-gray-600",children:"方法類別"}),(0,n.jsx)(L,{options:eb,placeholder:"請選擇治療方法",value:e.method,onSelect:t=>l(e.id,t),className:"border-gray-300"})]}),(0,n.jsxs)("div",{className:"space-y-1",children:[(0,n.jsx)("label",{className:"block text-sm text-gray-600",children:"正骨"===e.method?"部位（多選）":"穴位（多選）"}),"其他手法"===e.method?(0,n.jsx)("input",{type:"text",value:e.targets[0]||"",onChange:t=>u(e.id,t.target.value),placeholder:"請輸入治療部位或方法描述",className:"w-full p-2 border border-gray-300 rounded-md"}):e.method?(0,n.jsx)(L,{options:m(e.method),placeholder:"請選擇".concat("正骨"===e.method?"部位":"穴位"),onSelect:t=>c(e.id,t),multiple:!0,selectedItems:e.targets,onRemove:t=>d(e.id,t),className:"border-gray-300"}):(0,n.jsx)("div",{className:"p-2 border border-gray-200 bg-gray-100 rounded-md text-gray-500",children:"請先選擇治療方法"})]})]})]},e.id))}),(0,n.jsx)("div",{className:"flex justify-center",children:(0,n.jsx)("button",{type:"button",onClick:()=>{o(e=>({...e,treatments:[...e.treatments,{method:"",targets:[],id:Date.now().toString()}]}))},className:"px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md",children:"+ 新增治療方法"})}),(0,n.jsx)("div",{className:"flex justify-end",children:(0,n.jsx)("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600",children:"儲存"})})]})]})},ey=e=>{let{patients:t,onSelectPatient:s,currentPatientId:r,onRefresh:o}=e,a=!t||0===t.length,i=e=>{if(!e)return"未知";try{let t=new Date(e),s=new Date;if(isNaN(t.getTime()))return"時間格式錯誤";let r=s.getTime()-t.getTime(),o=Math.floor(r/6e4);if(o<1)return"剛剛";if(o<60)return"".concat(o," 分鐘");return"".concat(Math.floor(o/60)," 小時 ").concat(o%60," 分鐘")}catch(e){return console.error("計算等候時間出錯:",e),"計算錯誤"}};return(0,n.jsxs)("div",{className:"bg-white rounded-lg shadow-md overflow-hidden",children:[(0,n.jsxs)("div",{className:"bg-blue-600 text-white px-4 py-2 font-bold flex justify-between items-center",children:[(0,n.jsx)("span",{children:"候診名單"}),o&&(0,n.jsx)("button",{onClick:o,className:"text-white text-sm bg-blue-500 hover:bg-blue-700 rounded px-2 py-1",title:"刷新候診名單",children:"刷新"})]}),a?(0,n.jsxs)("div",{className:"p-4 text-center text-gray-500",children:[(0,n.jsx)("p",{className:"mb-2",children:"目前沒有候診患者"}),(0,n.jsx)("p",{className:"text-sm",children:"請確認是否有今日掛號患者"}),o&&(0,n.jsx)("button",{onClick:o,className:"mt-2 text-blue-500 hover:text-blue-700 text-sm underline",children:"點擊刷新候診名單"})]}):(0,n.jsx)("ul",{className:"divide-y divide-gray-200",children:t.map(e=>(0,n.jsx)("li",{className:"cursor-pointer transition-colors duration-150 ".concat(r===e.id?"bg-blue-100":e.is_contagious?"bg-yellow-50 hover:bg-yellow-100":e.is_troublesome?"bg-red-50 hover:bg-red-100":"hover:bg-blue-50"),onClick:()=>s(e.id),children:(0,n.jsx)("div",{className:"px-4 py-3",children:(0,n.jsxs)("div",{className:"flex justify-between items-start",children:[(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)("span",{className:"text-lg font-medium text-gray-800",children:e.chinese_name||e.name}),e.doctor_name&&(0,n.jsx)("span",{className:"ml-2 text-xs text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded-full",children:e.doctor_name})]}),(0,n.jsxs)("span",{className:"text-gray-500 text-sm block",children:["等候時間: ",e.waiting_since_timestamp?i(e.waiting_since_timestamp):e.waitingSince]}),e.chief_complaint&&(0,n.jsxs)("span",{className:"text-xs text-gray-600 block mt-1 line-clamp-1",children:["主訴: ",e.chief_complaint]}),e.special_note&&(0,n.jsxs)("span",{className:"text-xs font-semibold text-orange-600 block mt-1 line-clamp-1",children:["註記: ",e.special_note]})]}),(0,n.jsxs)("div",{className:"flex flex-col items-end gap-1",children:[e.isFirstVisit?(0,n.jsx)("span",{className:"px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 border border-green-200 whitespace-nowrap",children:"初診"}):(0,n.jsx)("span",{className:"px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800 border border-blue-200 whitespace-nowrap",children:"覆診"}),1===e.is_contagious&&(0,n.jsxs)("span",{className:"px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800 border border-yellow-200 whitespace-nowrap flex items-center",children:[(0,n.jsx)("svg",{className:"h-3 w-3 mr-0.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 9v2m0 4h.01M12 19A7 7 0 1 0 12 5a7 7 0 0 0 0 14Z"})}),"傳染病"]}),1===e.is_troublesome&&(0,n.jsxs)("span",{className:"px-2 py-1 text-xs rounded-full bg-red-100 text-red-800 border border-red-200 whitespace-nowrap flex items-center",children:[(0,n.jsx)("svg",{className:"h-3 w-3 mr-0.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),"麻煩症"]})]})]})})},e.id))})]})};let ef={getRecommendations:async(e,t)=>{try{console.log("正在獲取 AI 用藥建議",{modernDiagnosis:e,cmSyndrome:t});let s=new URLSearchParams;e&&s.append("modern_diagnosis",e),t&&s.append("cm_syndrome",t);let r="/ai/recommendations?".concat(s.toString()),o=(0,F.l9)(r);console.log("AI 建議 API 請求 URL: ".concat(o));let n=await R.Z.get(o,{timeout:1e4});return console.log("AI 用藥建議響應:",n.data),n.data}catch(e){return console.error("獲取 AI 用藥建議失敗:",e),{suggestions:[]}}}};var e_=e=>{let{modernDiagnosis:t=[],cmSyndrome:s=[],onAddHerb:r}=e,[o,i]=(0,a.useState)([]),[l,c]=(0,a.useState)(!1),[d,u]=(0,a.useState)("suggestions");(0,a.useEffect)(()=>{(t.length>0||s.length>0)&&r&&m()},[t,s]);let m=async()=>{if(r){c(!0);try{let e=t.join(","),r=s.join(","),o=await ef.getRecommendations(e,r);i(o.suggestions||[])}catch(e){console.error("獲取 AI 用藥建議失敗:",e),i([])}finally{c(!1)}}},p=e=>{r&&r(e)};return(0,n.jsxs)("div",{className:"mt-6 p-4 bg-gray-50 border border-gray-300 rounded-md",id:"ai-suggestions",children:[(0,n.jsxs)("div",{className:"flex items-center mb-2",children:[(0,n.jsx)("span",{className:"text-gray-700 font-medium",children:"\uD83C\uDF3F AI 用藥建議"}),(0,n.jsx)("span",{className:"ml-2 px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded",children:"即將推出 \uD83D\uDE80"})]}),(0,n.jsx)("div",{className:"text-gray-500 text-sm italic",children:(0,n.jsx)("p",{children:"未來將根據患者診斷資料，智能推薦適合的中藥處方。"})}),(0,n.jsxs)("div",{className:"flex border-b mb-2",children:[(0,n.jsx)("button",{className:"px-3 py-1 ".concat("suggestions"===d?"border-b-2 border-blue-500 text-blue-600":"text-gray-500"),onClick:()=>u("suggestions"),children:"藥材建議"}),(0,n.jsx)("button",{className:"px-3 py-1 ".concat("analysis"===d?"border-b-2 border-blue-500 text-blue-600":"text-gray-500"),onClick:()=>u("analysis"),children:"處方分析"})]}),l?(0,n.jsxs)("div",{className:"mt-2 flex items-center justify-center py-2",children:[(0,n.jsx)("div",{className:"animate-spin h-5 w-5 border-2 border-blue-500 rounded-full border-t-transparent"}),(0,n.jsx)("span",{className:"ml-2 text-sm text-gray-600",children:"正在獲取建議..."})]}):o.length>0?(0,n.jsxs)("div",{className:"mt-2",children:[(0,n.jsx)("div",{className:"text-sm font-medium mb-1",children:"推薦用藥:"}),(0,n.jsx)("div",{className:"space-y-1",children:o.map((e,t)=>(0,n.jsxs)("div",{className:"flex items-center justify-between bg-white p-2 rounded border border-gray-200",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("span",{className:"font-medium",children:e.name}),(0,n.jsxs)("span",{className:"text-xs text-gray-500 ml-1",children:["(",e.recommended_amount,"g)"]}),e.reason&&(0,n.jsx)("p",{className:"text-xs text-gray-600 mt-0.5",children:e.reason})]}),(0,n.jsx)("button",{type:"button",onClick:()=>p(e),className:"px-2 py-1 bg-green-100 text-green-800 text-xs rounded hover:bg-green-200",children:"加入處方"})]},t))})]}):null]})};let ej=e=>e.toLocaleString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),ew=e=>{if(!e)return"不詳";let t=new Date(e),s=new Date,r=s.getFullYear()-t.getFullYear();return(s.getMonth()<t.getMonth()||s.getMonth()===t.getMonth()&&s.getDate()<t.getDate())&&r--,"".concat(r,"歲")};function eN(){var e,t;let[s,r]=(0,a.useState)(null),[o,d]=(0,a.useState)(!1),[u,m]=(0,a.useState)(!1),[p,g]=(0,a.useState)([]),[h,x]=(0,a.useState)(null),[b,v]=(0,a.useState)([]),[y,f]=(0,a.useState)(null),[_,j]=(0,a.useState)(!1),[w,N]=(0,a.useState)({chiefComplaint:"",presentIllness:"",observation:{},diagnosis:{modernDiseases:[],cmSyndromes:[],cmPrinciple:""},prescription:[],treatmentMethods:[],prescription_instructions:"",prescription_structured_instructions:{total_days:7,times_per_day:2,timing:"早晚服"}}),[C,S]=(0,a.useState)({modernDiseases:[],cmSyndromes:[],cmPrinciple:[]}),D=a.useRef(null),P=e=>{let t={chiefComplaint:(null==e?void 0:e.chief_complaint)||"",presentIllness:"",observation:{},diagnosis:{modernDiseases:[],cmSyndromes:[],cmPrinciple:""},prescription:[],treatmentMethods:[],prescription_instructions:"",prescription_structured_instructions:{total_days:7,times_per_day:2,timing:"早晚服"}};S({modernDiseases:[],cmSyndromes:[],cmPrinciple:[]}),N(t),D.current&&"function"==typeof D.current.resetForm&&D.current.resetForm(),console.log("已重置所有表單資料",t)};(0,a.useEffect)(()=>{h&&(P(h),k(h.id))},[null==h?void 0:h.id]),(0,a.useEffect)(()=>{let e=async()=>{try{m(!0),f(null);let e=await B.getWaitingList();console.log("獲取到候診名單:",e),e&&0!==e.length?(g(e),f(null)):(console.warn("候診名單為空或未獲取到數據"),g([]),f("目前沒有已掛號的病人在候診"))}catch(e){console.error("獲取候診名單失敗:",e),f("無法連接掛號系統，請確認網絡連接或聯繫技術支持"),g([])}finally{m(!1)}let t=setInterval(e,3e5);return()=>clearInterval(t)};e()},[]);let I=async()=>{try{m(!0),f(null);let e=await B.getWaitingList();console.log("手動刷新獲取到候診名單:",e),e&&0!==e.length?(g(e),f(null)):(console.warn("候診名單為空或未獲取到數據"),f("目前沒有已掛號的病人在候診區"),g([]))}catch(e){console.error("手動刷新候診名單失敗:",e),f("刷新候診名單失敗，請確認掛號系統是否正常運作")}finally{m(!1)}};(0,a.useEffect)(()=>{let e=setInterval(()=>{if(h&&w)try{localStorage.setItem("draft_".concat(h.id),JSON.stringify({formData:w,rawDiagnosisData:C,timestamp:new Date().toISOString()})),console.log("表單數據已自動保存")}catch(e){console.error("自動保存表單數據失敗:",e)}},6e4);return()=>clearInterval(e)},[h,w,C]);let k=e=>{try{let t=localStorage.getItem("draft_".concat(e));if(!t)return console.log("無草稿資料，患者 ID: ".concat(e)),!1;let s=JSON.parse(t);if(!s||!s.formData||!s.timestamp)return console.error("草稿資料格式不正確"),!1;let r=new Date(s.timestamp);if(isNaN(r.getTime()))return console.error("草稿時間戳格式不正確"),!1;if(new Date().getTime()-r.getTime()<864e5&&window.confirm("發現".concat(ej(r),"的未完成記錄，是否恢復？")))return console.log("載入草稿資料",s.formData),N(s.formData),s.rawDiagnosisData&&S(s.rawDiagnosisData),!0;return console.log("草稿未載入：用戶拒絕或草稿過期"),!1}catch(e){return console.error("載入草稿失敗:",e),!1}},L=async e=>{try{m(!0),f(null);let s=p.find(t=>t.patient_id===e);if(!s)throw Error("候診名單中找不到對應患者，ID: ".concat(e));console.log("獲取患者詳細資料，患者ID:",e);try{let t=await V.getPatientById(e);console.log("獲取到患者資料:",t);let r=1===s.is_contagious,o=1===s.is_troublesome,n=s.special_note||t.special_note||"";x({...t,isContagious:r,isTroublesome:o,isFirstVisit:s.isFirstVisit||!1,special_note:n}),d("女"===t.gender);try{let t=await z.getPatientRecords(e);console.log("獲取到過往病歷:",t);let s=t.map(e=>({id:e.id.toString(),date:new Date(e.created_at).toLocaleDateString("zh-TW"),diagnosis:e.diagnosis||"無診斷",prescription:e.prescription||"無處方"}));v(s)}catch(e){console.error("獲取過往病歷失敗:",e),v([])}k(e)||P(t)}catch(s){if(console.error("獲取患者詳細資料API錯誤:",s),s.response){var t;console.error("API響應狀態: ".concat(s.response.status)),console.error("請求URL: ".concat(null===(t=s.config)||void 0===t?void 0:t.url)),console.error("回應資料: ",s.response.data)}f("無法載入患者詳細資料 (ID: ".concat(e,")：").concat(s.message||"系統錯誤","\n          可能是程式邏輯錯誤，請聯繫技術人員並提供上述錯誤訊息。")),x(null),v([])}}catch(e){console.error("獲取患者詳細資料邏輯錯誤:",e),f("無法載入患者詳細資料，請刷新頁面或聯繫技術支持"),x(null),v([])}finally{m(!1)}},O=e=>{N(t=>({...t,prescription:e.herbs.map(e=>({id:e.id,name:e.name,code:e.code||"",amount:e.amount,powder_amount:e.powder_amount,decoction_amount:e.decoction_amount,brand:e.brand,price_per_gram:e.price_per_gram,total_price:e.total_price,unit:e.unit||"g",is_compound:e.is_compound})),prescription_instructions:e.instructions,prescription_structured_instructions:e.structured_instructions})),console.log("已更新中藥處方:",e)},E=async()=>{if(!h){alert("請先選擇患者");return}try{m(!0);let e=[w.diagnosis.modernDiseases.length>0?"現代病名: ".concat(w.diagnosis.modernDiseases.join("、")):"",w.diagnosis.cmSyndromes.length>0?"中醫辨證: ".concat(w.diagnosis.cmSyndromes.join("、")):"",w.diagnosis.cmPrinciple?"中醫治則: ".concat(w.diagnosis.cmPrinciple):""].filter(Boolean).join("；"),t={patient_id:h.id,doctor_id:h.doctor_id,chief_complaint:T(w.chiefComplaint),present_illness:T(w.presentIllness),observation:T(w.observation),left_pulse:T(w.observation.leftPulse),right_pulse:T(w.observation.rightPulse),tongue_quality:T(w.observation.tongueQuality),tongue_shape:T(w.observation.tongueShape),tongue_color:T(w.observation.tongueColor),tongue_coating:T(w.observation.tongueCoating),diagnosis:T(e)||"無診斷",diagnosis_structured:{modernDiseases:C.modernDiseases,cmSyndromes:C.cmSyndromes,cmPrinciple:C.cmPrinciple},prescription:w.prescription.map(e=>({name:e.name,code:e.code,amount:e.powder_amount,powder_amount:e.powder_amount,decoction_amount:e.decoction_amount,brand:T(e.brand)||"",unit:T(e.unit)||"g",price_per_gram:e.price_per_gram||0,total_price:e.total_price||0,is_compound:e.is_compound||!1})),prescription_instructions:w.prescription_instructions||"",prescription_structured_instructions:w.prescription_structured_instructions||{total_days:7,times_per_day:2,timing:"早晚服"},treatment_methods:w.treatmentMethods};console.log("提交完整病歷數據:",t);let s=await z.createRecord(t);console.log("病歷保存成功:",s);try{console.log("嘗試從候診清單中移除患者 ID: ".concat(h.id)),await B.removePatientFromWaitingList(h.id),console.log("已從候診清單中移除患者 ID: ".concat(h.id)),I()}catch(e){console.error("從候診清單中移除患者失敗:",e)}alert("病歷已成功保存");let r=(await z.getPatientRecords(h.id)).map(e=>({id:e.id.toString(),date:new Date(e.created_at).toLocaleDateString("zh-TW"),diagnosis:e.diagnosis||"無診斷",prescription:e.prescription||"無處方"}));v(r)}catch(e){console.error("保存病歷失敗:",e),alert("保存病歷失敗，請重試")}finally{m(!1)}},R=e=>{P(),r(e);let t=p.find(t=>t.id===e);t?L(t.patient_id):(console.error("無法在候診名單中找到患者 ID: ".concat(e)),f("無法找到選定的患者，請刷新頁面重試"))},F=async e=>{try{var t,s,r,o,n,a,l,c;m(!0);let d=await z.getRecordById(e);if(console.log("病歷詳情:",d),d.diagnosis){let e={modernDiseases:(null===(t=d.diagnosis.modern_diseases)||void 0===t?void 0:t.map(e=>({code:"string"==typeof e?e:"",name:"string"==typeof e?e:""})))||[],cmSyndromes:(null===(s=d.diagnosis.cm_syndromes)||void 0===s?void 0:s.map(e=>({code:"string"==typeof e?e:"",name:"string"==typeof e?e:""})))||[],cmPrinciple:d.diagnosis.cm_principle?[{code:d.diagnosis.cm_principle,name:d.diagnosis.cm_principle}]:[]};S(e),N(t=>({...t,diagnosis:{modernDiseases:e.modernDiseases.map(e=>e.name||""),cmSyndromes:e.cmSyndromes.map(e=>e.name||""),cmPrinciple:e.cmPrinciple.map(e=>e.name||"").join("、")||""}}))}if(d.prescription&&d.prescription.herbs){let e=d.prescription.herbs.map(e=>{var t,s,r,o,n;return{id:Date.now().toString()+Math.random().toString(36).substring(2,9),code:(null===(t=e.structured_data)||void 0===t?void 0:t.code)||"",name:e.herb_name,brand:(null===(s=e.structured_data)||void 0===s?void 0:s.brand)||"",amount:e.amount,powder_amount:e.amount,decoction_amount:"",price_per_gram:(null===(r=e.structured_data)||void 0===r?void 0:r.price_per_gram)||0,total_price:(null===(o=e.structured_data)||void 0===o?void 0:o.total_price)||0,unit:e.unit||"g",is_compound:(null===(n=e.structured_data)||void 0===n?void 0:n.is_compound)||!1}});N(t=>({...t,prescription:e})),D.current&&"function"==typeof D.current.resetForm&&setTimeout(()=>{if(D.current){let t=e.reduce((e,t)=>e+(t.total_price||0),0),s={herbs:e,instructions:d.prescription.instructions||"",structured_instructions:{total_days:7,times_per_day:2,timing:"早晚服"},total_price:14*t,per_dose_price:t};D.current.resetForm(),O(s)}},100)}(d.observation||d.left_pulse||d.right_pulse||d.tongue_quality)&&(null===(r=d.left_pulse)||void 0===r||r.split("、"),null===(o=d.right_pulse)||void 0===o||o.split("、"),null===(n=d.tongue_quality)||void 0===n||n.split("、"),null===(a=d.tongue_shape)||void 0===a||a.split("、"),null===(l=d.tongue_color)||void 0===l||l.split("、"),null===(c=d.tongue_coating)||void 0===c||c.split("、"),N(e=>({...e,observation:{...e.observation,leftPulse:d.left_pulse||"",rightPulse:d.right_pulse||"",tongueQuality:d.tongue_quality||"",tongueShape:d.tongue_shape||"",tongueColor:d.tongue_color||"",tongueCoating:d.tongue_coating||""}}))),(d.chief_complaint||d.present_illness)&&N(e=>({...e,chiefComplaint:d.chief_complaint||"",presentIllness:d.present_illness||""})),i.Am.success("已載入 ".concat(new Date(d.created_at).toLocaleDateString("zh-TW")," 的診療記錄"))}catch(t){console.error("獲取病歷詳情失敗，ID: ".concat(e,":"),t),i.Am.error("獲取病歷詳情失敗")}finally{m(!1)}},q=async e=>{try{if(!(null==h?void 0:h.id)){console.error("患者資料不存在");return}await V.updatePatientMarkers(h.id,e),h&&x({...h,...e}),j(!1),i.Am.success("患者特殊標記已更新")}catch(e){console.error("更新患者標記時出錯:",e),i.Am.error("更新患者標記失敗")}};return(0,n.jsx)("div",{className:"min-h-screen bg-gray-100",children:(0,n.jsxs)("div",{className:"container mx-auto px-4 py-6",children:[(0,n.jsx)("h1",{className:"text-2xl font-bold mb-6 text-gray-800",children:"中醫病歷系統"}),y&&(0,n.jsxs)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4",role:"alert",children:[(0,n.jsx)("p",{children:y}),!p.length&&(0,n.jsx)("div",{className:"mt-2",children:(0,n.jsx)("button",{onClick:I,className:"bg-red-200 hover:bg-red-300 text-red-800 px-3 py-1 rounded text-sm",children:"重新載入候診清單"})})]}),(0,n.jsxs)("div",{className:"grid grid-cols-12 gap-6",children:[(0,n.jsxs)("div",{className:"col-span-12 md:col-span-3",children:[(0,n.jsx)(ey,{patients:p,onSelectPatient:R,currentPatientId:s,onRefresh:I}),h&&(0,n.jsx)("div",{className:"mt-6",children:(0,n.jsx)(eg,{records:b,onViewRecord:F,patientName:null==h?void 0:h.chinese_name})})]}),(0,n.jsx)("div",{className:"col-span-12 md:col-span-9 space-y-6",children:h?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"mb-6 bg-white p-4 rounded-lg shadow",children:[(0,n.jsxs)("div",{className:"flex justify-between items-start mb-2",children:[(0,n.jsx)("h2",{className:"text-xl font-bold",children:"患者信息"}),(0,n.jsx)("button",{onClick:()=>j(!_),className:"text-sm text-blue-600 hover:text-blue-800",children:_?"取消編輯":"編輯特殊標記"})]}),(0,n.jsxs)("div",{className:"flex items-start justify-between",children:[(0,n.jsxs)("div",{children:[(0,n.jsxs)("p",{className:"text-gray-700",children:[(0,n.jsx)("span",{className:"font-medium",children:"姓名:"})," ",null==h?void 0:h.chinese_name]}),(0,n.jsxs)("p",{className:"text-gray-700",children:[(0,n.jsx)("span",{className:"font-medium",children:"年齡:"})," ",ew(null==h?void 0:h.birth_date)]}),(0,n.jsxs)("p",{className:"text-gray-700",children:[(0,n.jsx)("span",{className:"font-medium",children:"性別:"})," ",null==h?void 0:h.gender]}),(0,n.jsxs)("p",{className:"text-gray-700",children:[(0,n.jsx)("span",{className:"font-medium",children:"電話:"})," ",null==h?void 0:h.phone_number]})]}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("p",{className:"text-gray-700",children:[(0,n.jsx)("span",{className:"font-medium",children:"病歷號:"})," ",null==h?void 0:h.id]}),(0,n.jsxs)("p",{className:"text-gray-700",children:[(0,n.jsx)("span",{className:"font-medium",children:"過敏藥物:"})," ",null==h?void 0:null===(e=h.drug_allergies)||void 0===e?void 0:e.join(", ")]}),(0,n.jsxs)("p",{className:"text-gray-700",children:[(0,n.jsx)("span",{className:"font-medium",children:"既往疾病:"})," ",null==h?void 0:null===(t=h.basic_diseases)||void 0===t?void 0:t.join(", ")]})]})]}),(0,n.jsx)("div",{className:"mt-2",children:(0,n.jsx)(l,{isTroublesome:(null==h?void 0:h.isTroublesome)?1:0,isContagious:(null==h?void 0:h.isContagious)?1:0,specialNote:null==h?void 0:h.special_note})})]}),_&&(0,n.jsx)(c,{isTroublesome:(null==h?void 0:h.isTroublesome)?1:0,isContagious:(null==h?void 0:h.isContagious)?1:0,specialNote:(null==h?void 0:h.special_note)||"",onUpdate:q}),(0,n.jsx)(M,{initialChiefComplaint:h.chief_complaint||"",onSave:e=>{N(t=>({...t,chiefComplaint:e.chiefComplaint,presentIllness:e.presentIllness})),console.log("已更新主訴與現病史:",e)}}),(0,n.jsx)(em,{onSave:e=>{N(t=>{var s,r,o,n,a,i;return{...t,observation:{...e,leftPulse:(null===(s=e.leftPulse)||void 0===s?void 0:s.join("、"))||"",rightPulse:(null===(r=e.rightPulse)||void 0===r?void 0:r.join("、"))||"",tongueQuality:(null===(o=e.tongueQuality)||void 0===o?void 0:o.join("、"))||"",tongueShape:(null===(n=e.tongueShape)||void 0===n?void 0:n.join("、"))||"",tongueColor:(null===(a=e.tongueColor)||void 0===a?void 0:a.join("、"))||"",tongueCoating:(null===(i=e.tongueCoating)||void 0===i?void 0:i.join("、"))||""}}}),console.log("已更新醫師觀察:",e)},showMenstrualField:o}),(0,n.jsx)(A,{initialValues:w.diagnosis,onSave:e=>{let t={modernDiseases:Array.isArray(e.modernDiseases)?e.modernDiseases:[],cmSyndromes:Array.isArray(e.cmSyndromes)?e.cmSyndromes:[],cmPrinciple:Array.isArray(e.cmPrinciple)?e.cmPrinciple:[]};S(t),N(e=>({...e,diagnosis:{modernDiseases:t.modernDiseases.map(e=>e.name||""),cmSyndromes:t.cmSyndromes.map(e=>e.name||""),cmPrinciple:t.cmPrinciple.map(e=>e.name||"").join("、")||""}})),console.log("已更新中醫診斷:",e)}}),(0,n.jsx)(e_,{modernDiagnosis:w.diagnosis.modernDiseases,cmSyndrome:w.diagnosis.cmSyndromes,onAddHerb:e=>{D.current&&"function"==typeof D.current.addHerb?D.current.addHerb({...e,source:"AI_suggested"}):console.warn("無法添加 AI 建議藥材：處方表單引用不可用")}}),(0,n.jsx)(Q,{initialValues:{herbs:w.prescription.map(e=>({id:e.id||Date.now().toString(),code:e.code||"",name:e.name||"",brand:e.brand||"",powder_amount:e.amount||"",decoction_amount:e.decoction_amount||"",price_per_gram:e.price_per_gram||0,total_price:e.total_price||0,unit:"g",is_compound:e.is_compound||!1,concentration_ratio:1,decoction_equivalent_per_g:1,inventory_status:"normal"})),instructions:w.prescription_instructions||"",structured_instructions:w.prescription_structured_instructions,per_dose_price:w.prescription.reduce((e,t)=>e+(t.total_price||0),0),total_price:w.prescription.reduce((e,t)=>e+(t.total_price||0),0)*(w.prescription_structured_instructions.total_days*w.prescription_structured_instructions.times_per_day)},onSave:O,ref:D}),(0,n.jsx)(ev,{onSave:e=>{N(t=>({...t,treatmentMethods:e.treatments.map(e=>{var t;return"".concat(e.method).concat((null===(t=e.targets)||void 0===t?void 0:t.length)>0?": ".concat(e.targets.join("、")):"")})})),console.log("已更新治療方法:",e)}}),(0,n.jsx)(ep,{onSave:E,onPrint:()=>{if(!h){alert("請先選擇患者");return}alert("藥方已送出列印")},onScheduleFollowUp:()=>{if(!h){alert("請先選擇患者");return}alert("開啟預約覆診表單")},onNextPatient:()=>{if(0===p.length){alert("候診名單已空");return}if(s&&h)try{B.removePatientFromWaitingList(h.id).then(()=>{console.log("已從候診清單中移除患者 ID: ".concat(h.id))}).catch(e=>{console.error("從候診清單中移除患者失敗:",e)})}catch(e){console.error("移至下一位患者時出錯:",e)}if(P(),s){let e=p.findIndex(e=>e.id===s);if(-1!==e&&e<p.length-1){R(p[e+1].id),setTimeout(()=>{I()},500);return}}p.length>0&&(R(p[0].id),setTimeout(()=>{I()},500))},onCopyLastPrescription:()=>{if(!h||0===b.length){alert("沒有可複製的處方");return}let e=b[0].id;m(!0),z.getRecordById(e).then(e=>{if(e.prescription&&e.prescription.herbs){var t;let s=e.prescription.herbs.map(e=>{var t,s,r,o,n;return{id:Date.now().toString()+Math.random().toString(36).substring(2,9),code:(null===(t=e.structured_data)||void 0===t?void 0:t.code)||"",name:e.herb_name,brand:(null===(s=e.structured_data)||void 0===s?void 0:s.brand)||"",amount:e.amount,powder_amount:e.amount,decoction_amount:"",price_per_gram:(null===(r=e.structured_data)||void 0===r?void 0:r.price_per_gram)||0,total_price:(null===(o=e.structured_data)||void 0===o?void 0:o.total_price)||0,unit:e.unit||"g",is_compound:(null===(n=e.structured_data)||void 0===n?void 0:n.is_compound)||!1}}),r=(null===(t=e.prescription.structured_data)||void 0===t?void 0:t.structured_instructions)||{total_days:7,times_per_day:2,timing:"早晚服"};s.reduce((e,t)=>e+(t.total_price||0),0),r.total_days,r.times_per_day,N(t=>({...t,prescription:s,prescription_instructions:e.prescription.instructions||"",prescription_structured_instructions:r})),alert("已成功複製上次處方")}else alert("無法複製上次處方，因為缺少結構化資料")}).catch(e=>{console.error("複製上次處方失敗:",e),alert("複製上次處方失敗")}).finally(()=>{m(!1)})},isLoading:u})]}):(0,n.jsxs)("div",{className:"bg-white p-6 rounded-md shadow text-center",children:[(0,n.jsx)("p",{className:"text-gray-500 mb-4",children:"請從候診名單中選擇患者"}),0===p.length&&!u&&(0,n.jsxs)("div",{children:[(0,n.jsx)("p",{className:"text-sm text-gray-400 mb-3",children:"候診名單為空"}),(0,n.jsx)("button",{onClick:I,className:"bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-2 rounded-md text-sm",children:"重新載入候診清單"})]}),u&&(0,n.jsxs)("div",{className:"flex justify-center items-center mt-4",children:[(0,n.jsx)("div",{className:"w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"}),(0,n.jsx)("span",{className:"ml-2 text-blue-600",children:"載入中..."})]})]})})]})]})})}},5585:function(e,t,s){"use strict";s.d(t,{l9:function(){return o}});var r=s(3107);let o=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=e.startsWith("/")?e:"/".concat(e);return"".concat("https://clinic.aspiratcm.com/api/v1").concat(t)},n=r.Z.create({baseURL:o(),headers:{"Content-Type":"application/json",Accept:"application/json"},timeout:15e3});n.interceptors.request.use(e=>{var t;if(console.log("[API請求] ".concat(null===(t=e.method)||void 0===t?void 0:t.toUpperCase()," ").concat(e.url)),e.params&&console.log("[請求參數] ".concat(JSON.stringify(e.params))),e.data&&"string"!=typeof e.data)try{console.log("[請求數據] ".concat(JSON.stringify(e.data)))}catch(e){console.log("[請求數據] 無法序列化")}return e},e=>(console.error("[API請求錯誤]",e),Promise.reject(e))),n.interceptors.response.use(e=>(console.log("[API響應] ".concat(e.status," ").concat(e.config.url)),e),e=>{var t,s,r,o;let n=null==e?void 0:null===(t=e.response)||void 0===t?void 0:t.status,a=null==e?void 0:null===(s=e.config)||void 0===s?void 0:s.url,i=null==e?void 0:null===(o=e.config)||void 0===o?void 0:null===(r=o.method)||void 0===r?void 0:r.toUpperCase();return n?console.error("[".concat(i," ").concat(a,"] 錯誤 ").concat(n),e.response.data):console.error("[API錯誤]",e.message),Promise.reject(e)})}},function(e){e.O(0,[107,687,317,971,69,744],function(){return e(e.s=3166)}),_N_E=e.O()}]);