(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[530],{5466:function(e,s,o){Promise.resolve().then(o.bind(o,8434))},7907:function(e,s,o){"use strict";var t=o(5313);o.o(t,"usePathname")&&o.d(s,{usePathname:function(){return t.usePathname}}),o.o(t,"useRouter")&&o.d(s,{useRouter:function(){return t.useRouter}})},8434:function(e,s,o){"use strict";o.r(s),o.d(s,{default:function(){return y}});var t=o(3827),r=o(4090),a=o(7907),n=o(5585),l=o(3107);function i(e){return e.startsWith("/")?e:e.startsWith("http:")?(console.log("⚠️ 將 HTTP URL 替換為 HTTPS:",e),e.replace("http:","https:")):e}async function c(){let e={basic_diseases:["我沒有任何基礎病","高血壓","糖尿病","心臟病","其他，請列明"],drug_allergies:["我沒有任何藥物過敏","青黴素","非類固醇消炎藥","其他藥物，請列明"],food_allergies:["我沒有任何食物過敏","海鮮","堅果","其他食物，請列明"],data_sources:["朋友介紹","網絡","Instagram","Facebook"],regions:{香港:{中西區:["中環","上環"]}},doctors:[]},s=async function(e){let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;try{let s=await fetch(e,{method:"GET",headers:{Accept:"application/json","Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},cache:"no-store"});if(!s.ok)throw Error("HTTP error ".concat(s.status));return s}catch(r){if(o<=1)throw r;return console.log("重試請求 (".concat(4-o,"/3): ").concat(e)),await new Promise(e=>setTimeout(e,t)),s(e,o-1,1.5*t)}};try{let o=i((0,n.l9)("/patient_registration/reference-data/"));console.log("\uD83D\uDD12 請求參考資料:",o);let t=await s(o),r=await t.json();if(console.log("\uD83D\uDCCA 成功獲取參考資料，資料結構:",Object.keys(r)),r.doctors&&Array.isArray(r.doctors)&&0!==r.doctors.length)console.log("✅ 參考資料中已包含醫師資料，數量:",r.doctors.length);else{console.warn("⚠️ 參考資料中沒有醫師資料，嘗試從醫師 API 獲取");try{let e=i((0,n.l9)("/doctors/")),o=await s(e),t=await o.json();console.log("✅ 成功從專用 API 獲取醫師資料:",t),Array.isArray(t)&&t.length>0?r.doctors=t:console.warn("⚠️ 醫師 API 返回空數據或格式錯誤")}catch(e){console.error("❌ 無法從專用 API 獲取醫師資料:",e)}}for(let s of["basic_diseases","drug_allergies","food_allergies","data_sources"])r[s]&&Array.isArray(r[s])&&0!==r[s].length||(console.warn("⚠️ 參考資料中缺少 ".concat(s,"，使用備用數據")),r[s]=e[s]);return r.regions&&0!==Object.keys(r.regions).length||(console.warn("⚠️ 參考資料中缺少 regions，使用備用數據"),r.regions=e.regions),r}catch(o){console.error("❌ 獲取參考資料失敗:",o);try{let o=i((0,n.l9)("/doctors/"));console.log("\uD83D\uDD04 嘗試從醫師 API 獲取醫師資料（最後嘗試）:",o);let t=await s(o,2),r=await t.json();Array.isArray(r)&&r.length>0&&(console.log("✅ 成功獲取醫師資料:",r),e.doctors=r)}catch(e){console.error("❌ 最終嘗試獲取醫師資料失敗")}return console.log("\uD83D\uDD04 使用後備參考資料:",e),e}}async function d(e){try{let s=e.replace(/[\(\)]/g,"").trim();console.log("\uD83D\uDD0D 格式化後的身份證號碼:",s);let o=i((0,n.l9)("/patient_registration/check-id-number/"));return(await l.Z.get(o,{params:{id_number:s}})).data}catch(e){if(console.error("檢查身份證號碼失敗:",e),e.response){if(404===e.response.status)return{exists:!1,patient:null};if(500===e.response.status)throw console.error("後端處理身份證號碼時出錯:",e.response.data),Error("系統處理身份證號碼時出錯，請稍後再試或聯絡客服")}throw e}}async function u(e){try{let s={...e};s.email&&""!==s.email&&"undefined"!==s.email&&("string"!=typeof s.email||""!==s.email.trim())||(console.log("API 調用前檢查: email 欄位為空，設置為 no@no.com"),s.email="no@no.com"),console.log("API 最終請求數據:",JSON.stringify(s));try{if(s.id_number){console.log("首先嘗試通過身份證號碼檢查患者是否存在: ".concat(s.id_number));let e=await d(s.id_number);if(e.exists&&e.patient){console.log("發現患者已存在，自動處理為覆診流程");let o=e.patient.id,t={doctor_id:s.doctor_id,note:s.note,basic_diseases:s.basic_diseases,drug_allergies:s.drug_allergies,food_allergies:s.food_allergies,chief_complaint:s.chief_complaint},r=await h(o,t);return console.log("✅ 患者覆診資料更新成功:",r),r}}if(s.phone_number){console.log("嘗試通過電話號碼檢查患者是否存在: ".concat(s.phone_number));try{let e=await g(s.phone_number);if(e){console.log("通過電話號碼找到現有患者，自動處理為覆診流程");let o=e.id,t={doctor_id:s.doctor_id,note:s.note,basic_diseases:s.basic_diseases,drug_allergies:s.drug_allergies,food_allergies:s.food_allergies,chief_complaint:s.chief_complaint},r=await h(o,t);return console.log("✅ 通過電話號碼找到患者並更新成功:",r),r}}catch(e){console.log("使用電話號碼查詢患者失敗，繼續嘗試其他方法:",e)}}}catch(e){console.log("預先檢查患者是否存在時出錯，繼續嘗試提交流程:",e)}let o=i((0,n.l9)("/patient_registration/"));console.log("\uD83D\uDD37 提交患者數據到:",o);try{let e=await l.Z.post(o,s);return console.log("✅ 患者創建成功:",e.data),e.data}catch(e){if(console.error("❌ POST 請求失敗，檢查錯誤類型:",e),e.response&&409===e.response.status){console.log("處理409衝突: 患者已存在，嘗試獲取患者信息並自動處理為覆診流程");try{let o=null,t=null;if(e.response.data&&e.response.data.patient_id){t=e.response.data.patient_id,console.log("從409響應中獲取患者ID: ".concat(t));try{o=await m(t)}catch(e){console.log("通過ID ".concat(t," 獲取患者失敗:"),e)}}if(!o&&e.response.data&&e.response.data.detail){let s=e.response.data.detail;console.log("分析錯誤詳情尋找患者ID:",s);let r=/patient_id: (\d+)/.exec(s)||/patient id: (\d+)/.exec(s)||/id: (\d+)/.exec(s);if(r&&r[1]){t=parseInt(r[1]),console.log("從錯誤詳情中提取到患者ID: ".concat(t));try{o=await m(t)}catch(e){console.log("通過提取的ID ".concat(t," 獲取患者失敗:"),e)}}}if(!o&&s.id_number){console.log("使用身份證再次檢查獲取患者: ".concat(s.id_number));try{let e=await d(s.id_number);e.exists&&e.patient&&(t=(o=e.patient).id)}catch(e){console.log("使用身份證查詢失敗:",e)}}if(!o&&s.phone_number){console.log("使用電話號碼再次嘗試獲取患者: ".concat(s.phone_number));try{(o=await g(s.phone_number))&&(t=o.id)}catch(e){console.log("使用電話號碼查詢失敗:",e)}}if(o&&t){console.log("成功找到現有患者記錄:",o);let e={doctor_id:s.doctor_id,note:s.note,chief_complaint:s.chief_complaint,basic_diseases:s.basic_diseases,drug_allergies:s.drug_allergies,food_allergies:s.food_allergies};try{console.log("嘗試使用主要 API 路徑更新患者 ID ".concat(t));let s=await h(t,e);return console.log("✅ 成功處理409衝突並更新患者覆診資料:",s),s}catch(e){console.error("使用主要 API 路徑更新患者失敗，嘗試備用方法:",e);try{let e=i((0,n.l9)("/patients/revisit"));console.log("嘗試使用覆診專用端點:",e);let o={...s,patient_id:t},r=await l.Z.post(e,o);return console.log("✅ 使用覆診專用端點成功:",r.data),r.data}catch(e){throw console.error("覆診專用端點也失敗:",e),Error("此患者已存在，但系統無法自動完成掛號。請先切換到覆診模式，然後搜尋此患者資料再提交。")}}}else{console.warn("409錯誤處理: 仍然無法找到相關患者信息，嘗試最後的應急方法");try{let e=i((0,n.l9)("/patients/revisit"));console.log("嘗試使用覆診專用端點:",e);let o=await l.Z.post(e,s);return console.log("✅ 使用覆診專用端點成功:",o.data),o.data}catch(e){throw console.error("覆診專用端點也失敗:",e),Error("此患者已存在，但系統無法自動完成掛號。請先切換到覆診模式，然後搜尋此患者資料再提交。")}}}catch(e){throw console.error("恢復409衝突時出錯:",e),Error("此患者已在系統中，但系統無法自動處理為覆診流程。請切換到覆診模式，搜尋患者後再提交。")}}throw e}}catch(t){if(console.error("❌ 創建患者失敗，處理各種錯誤情況:",t),t.response&&404===t.response.status){console.log("患者不存在，嘗試創建新患者");try{let s=i((0,n.l9)("/patients/"));console.log("\uD83D\uDD37 使用替代 API 端點嘗試創建患者:",s);let o=await l.Z.post(s,e);return console.log("✅ 使用替代端點成功創建患者:",o.data),o.data}catch(e){throw console.error("使用替代端點創建患者失敗:",e),Error("無法創建患者記錄，請稍後再試或聯絡櫃檯人員協助。")}}if(t.response&&422===t.response.status){var s;let e=(null===(s=t.response.data)||void 0===s?void 0:s.detail)||[],o={},r="資料驗證失敗";Array.isArray(e)?(e.forEach(e=>{if(e.loc&&Array.isArray(e.loc)&&e.loc.length>1){let s=e.loc.slice(1).join(".");o[s]=e.msg,console.error('欄位 "'.concat(s,'" 驗證失敗:'),e.msg)}}),Object.keys(o).length>0&&(r="資料驗證失敗: ".concat(Object.keys(o).map(e=>"".concat(e," (").concat(o[e],")")).join(", ")))):"object"==typeof t.response.data&&(r=t.response.data.detail||"資料驗證失敗，請檢查輸入",o=t.response.data);let a=Error(r);throw a.response=t.response,a.validationErrors=o,a.isValidationError=!0,a.status=422,a}if(t.response){console.error("服務器回應 ".concat(t.response.status," 錯誤:"),t.response.data);let e="系統處理請求時發生錯誤，請稍後再試";401===t.response.status||403===t.response.status?e="您沒有權限執行此操作，請聯絡系統管理員":t.response.status>=500&&(e="系統內部錯誤，請稍後再試或聯絡技術支援");let s=Error(e);throw s.response=t.response,s.status=t.response.status,s}let o=Error("連接伺服器失敗，請檢查網絡連接");throw o.isNetworkError=!0,o}}async function m(e){try{let s=i((0,n.l9)("/patient_registration/".concat(e)));return(await l.Z.get(s)).data}catch(o){if(console.error("獲取患者 ID ".concat(e," 失敗:"),o),o.response){var s;throw console.error("API響應狀態: ".concat(o.response.status)),console.error("請求URL: ".concat(null===(s=o.config)||void 0===s?void 0:s.url)),console.error("回應數據: ",o.response.data),Error("獲取患者資料失敗(".concat(o.response.status,"): 可能是程式邏輯錯誤，請通知技術人員"))}throw o}}async function g(e){try{let s=e.replace(/[\s\-\(\)]/g,"");console.log("\uD83D\uDD0D 格式化後的電話號碼:",s);try{let e=i((0,n.l9)("/patients/by-phone-number?phone=".concat(s)));return console.log("嘗試使用查詢參數格式 API 端點:",e),(await l.Z.get(e,{timeout:5e3})).data}catch(o){console.warn("使用新 API 路徑失敗，嘗試舊路徑格式:",o.message);let e=i((0,n.l9)("/patient_registration/by-phone-number/".concat(s,"/")));return console.log("嘗試使用原始路徑參數格式 API 端點（即將淘汰）:",e),(await l.Z.get(e)).data}}catch(o){if(console.error("通過電話號碼 ".concat(e," 獲取患者失敗:"),o),o.response){var s;if(console.error("API響應狀態: ".concat(o.response.status)),console.error("請求URL: ".concat(null===(s=o.config)||void 0===s?void 0:s.url)),console.error("回應數據: ",o.response.data),404===o.response.status)throw Error("未找到電話號碼為 ".concat(e," 的患者記錄"));if(500===o.response.status)throw console.error("後端處理電話號碼時出錯:",o.response.data),Error("系統處理電話號碼時出錯 (500): 可能是程式邏輯錯誤，請通知技術人員");if(o.response.data&&o.response.data.detail)throw Error(o.response.data.detail)}throw Error("無法查詢電話號碼，請確認格式正確或稍後再試")}}async function h(e,s){try{let o=i((0,n.l9)("/patient_registration/".concat(e)));return console.log("嘗試更新患者 ID ".concat(e,"，URL: ").concat(o)),(await l.Z.patch(o,s)).data}catch(t){if(console.error("更新患者 ID ".concat(e," 失敗:"),t),t.response){var o;if(console.error("API響應狀態: ".concat(t.response.status)),console.error("請求URL: ".concat(null===(o=t.config)||void 0===o?void 0:o.url)),console.error("回應數據: ",t.response.data),404===t.response.status){console.log("主要患者更新端點返回 404，嘗試備用端點...");try{let o=i((0,n.l9)("/patients/update/".concat(e)));return console.log("嘗試使用備用 API 路徑更新患者 ID ".concat(e,"，URL: ").concat(o)),(await l.Z.patch(o,s)).data}catch(e){console.error("備用患者更新端點也失敗:",e)}}throw Error("更新患者資料失敗(".concat(t.response.status,"): 可能是程式邏輯錯誤，請通知技術人員"))}throw t}}var b=e=>{let{regions:s,value:o,onChange:a,required:n=!1,readOnly:l=!1}=e,[i,c]=(0,r.useState)([]),[d,u]=(0,r.useState)([]);return(0,r.useEffect)(()=>{if(o.region&&s[o.region]){let e=Object.keys(s[o.region]);c(e),e.length>0&&!e.includes(o.district)&&a({...o,district:"",subDistrict:""})}else c([]),u([])},[o.region,s]),(0,r.useEffect)(()=>{if(o.region&&o.district&&s[o.region]&&s[o.region][o.district]){let e=s[o.region][o.district];u(e),e.length>0&&!e.includes(o.subDistrict)&&a({...o,subDistrict:""})}else u([])},[o.region,o.district,s]),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["區域 ",n&&(0,t.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{value:o.region,onChange:e=>{a({region:e.target.value,district:"",subDistrict:""})},className:"mt-1 block w-full px-3 py-2 ".concat(l?"bg-gray-100":"bg-white"," border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"),required:n,disabled:l,children:[(0,t.jsx)("option",{value:"",children:"請選擇區域"}),Object.keys(s).map(e=>(0,t.jsx)("option",{value:e,children:e},e))]})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["地區 ",n&&(0,t.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{value:o.district,onChange:e=>{a({...o,district:e.target.value,subDistrict:""})},className:"mt-1 block w-full px-3 py-2 ".concat(l?"bg-gray-100":"bg-white"," border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"),disabled:l||!o.region||0===i.length,required:n,children:[(0,t.jsx)("option",{value:"",children:"請選擇地區"}),i.map(e=>(0,t.jsx)("option",{value:e,children:e},e))]})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["細分地區 ",n&&(0,t.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{value:o.subDistrict,onChange:e=>{a({...o,subDistrict:e.target.value})},className:"mt-1 block w-full px-3 py-2 ".concat(l?"bg-gray-100":"bg-white"," border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"),disabled:l||!o.district||0===d.length,required:n,children:[(0,t.jsx)("option",{value:"",children:"請選擇細分地區"}),d.map(e=>(0,t.jsx)("option",{value:e,children:e},e))]})]})]})};class x extends r.Component{static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,s){console.error("PatientForm 錯誤邊界捕獲到錯誤:",e,s)}render(){if(this.state.hasError){var e;return this.props.fallback?this.props.fallback:(0,t.jsxs)("div",{className:"p-4 bg-red-50 border border-red-200 rounded-md text-red-700",children:[(0,t.jsx)("h3",{className:"text-lg font-medium mb-2",children:"發生錯誤"}),(0,t.jsx)("p",{className:"mb-4",children:"很抱歉，表單處理過程中發生錯誤。"}),(0,t.jsxs)("details",{className:"text-sm text-red-600",children:[(0,t.jsx)("summary",{children:"錯誤詳情"}),(0,t.jsx)("pre",{className:"mt-2 whitespace-pre-wrap",children:null===(e=this.state.error)||void 0===e?void 0:e.toString()})]}),(0,t.jsx)("button",{onClick:()=>window.location.reload(),className:"mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"重新載入頁面"})]})}return this.props.children}constructor(e){super(e),this.state={hasError:!1,error:null}}}var p=()=>{var e,s;(0,a.useRouter)();let[o,l]=(0,r.useState)(!1),[i,m]=(0,r.useState)(null),[h,p]=(0,r.useState)(null),[f,y]=(0,r.useState)(!0),[_,j]=(0,r.useState)(""),[v,w]=(0,r.useState)(!1),[N,D]=(0,r.useState)(null),[k,E]=(0,r.useState)(!1),[C,A]=(0,r.useState)(!1),[I,S]=(0,r.useState)(!1),[P,O]=(0,r.useState)(""),[W,T]=(0,r.useState)(""),[q,R]=(0,r.useState)(""),[L,U]=(0,r.useState)({chinese_name:"",english_name:"",id_number:"",birth_date:"",phone_number:"",email:"no@no.com",gender:"",basic_diseases:["我沒有任何基礎病"],drug_allergies:["我沒有任何藥物過敏"],food_allergies:["我沒有任何食物過敏"],note:"",has_appointment:!1,doctor_id:void 0,data_source:"",region:"",district:"",sub_district:"",chief_complaint:""});(0,r.useEffect)(()=>{(async()=>{try{if("serviceWorker"in navigator)try{navigator.serviceWorker.getRegistrations().then(e=>{e.forEach(e=>{console.log("\uD83E\uDDF9 清除 Service Worker 緩存:",e),e.unregister()})})}catch(e){console.warn("無法清除 Service Worker 緩存:",e)}let e=(0,n.l9)("/patient_registration/reference-data/");console.log("\uD83D\uDD0D 測試 URL 生成:",e),console.log("\uD83D\uDD0D window.location.origin =",window.location.origin),console.log("\uD83D\uDD0D window.location.protocol =",window.location.protocol),e.startsWith("http:")&&console.error("⛔ URL 協議錯誤，使用了 HTTP:",e),console.log("\uD83D\uDD52 正在請求參考數據，時間戳:",new Date().toISOString());let s=await c();console.log("✅ 成功獲取參考數據!",s);let o=s.doctors;if(!o||!Array.isArray(o)||0===o.length){console.warn("⚠️ 未能從 API 獲取醫師數據，嘗試獲取緊急備用方案");try{o=[{id:1,name:"郭鎮峰",specialty:"中醫師"}],console.log("✅ 使用硬編碼的醫師資料:",o),s.doctors=o}catch(e){console.error("❌ 緊急備用方案失敗:",e)}}s.doctors&&s.doctors.length>0?console.log("\uD83D\uDC68‍⚕️ 成功載入醫師數據:",s.doctors):console.warn("⚠️ 醫師數據為空或不存在:",s.doctors),p(s)}catch(s){console.error("❌ 獲取參考數據失敗:",s),s instanceof Error&&(console.error("錯誤名稱:",s.name),console.error("錯誤訊息:",s.message),console.error("錯誤堆疊:",s.stack));let e={basic_diseases:["我沒有任何基礎病","高血壓","糖尿病","心臟病","其他，請列明"],drug_allergies:["我沒有任何藥物過敏","青黴素","非類固醇消炎藥","其他藥物，請列明"],food_allergies:["我沒有任何食物過敏","海鮮","堅果","其他食物，請列明"],data_sources:["朋友介紹","網絡","Instagram","Facebook"],regions:{香港:{中西區:["中環","上環"]}},doctors:[{id:1,name:"郭鎮峰",specialty:"中醫師"}]};console.log("\uD83D\uDD04 使用後備參考資料:",e),p(e),m({type:"error",text:"無法加載參考數據，已使用基本資料。您可以繼續填寫表單，但若無法提交請刷新頁面重試。"})}})()},[]),(0,r.useEffect)(()=>{let e=async()=>{if(L.id_number.length>=8)try{(await d(L.id_number)).exists?m({type:"info",text:"此身份證/護照號碼已存在，系統將自動使用覆診流程。若要建立新患者，請確認身份證是否正確。"}):m(null)}catch(e){console.error("檢查患者錯誤:",e)}};if(f){let s=setTimeout(e,500);return()=>clearTimeout(s)}},[L.id_number,f]);let Z=e=>{let{name:s,value:o}=e.target;U(e=>({...e,[s]:o}))},F=(e,s,o)=>{console.log("複選框變更: ".concat(e,", ").concat(s,", ").concat(o)),U(t=>{let r=[...t[e]],a=s.includes("我沒有"),n=s.includes("其他");return o?a?(r=[s],"basic_diseases"===e?O(""):"drug_allergies"===e?T(""):"food_allergies"===e&&R("")):(r=r.filter(e=>!e.includes("我沒有"))).push(s):(r=r.filter(e=>e!==s),n&&("basic_diseases"===e?O(""):"drug_allergies"===e?T(""):"food_allergies"===e&&R("")),0===r.length&&(r="basic_diseases"===e?["我沒有任何基礎病"]:"drug_allergies"===e?["我沒有任何藥物過敏"]:["我沒有任何食物過敏"])),console.log("".concat(e," 最終選項:"),r),{...t,[e]:r}})},H=(e,s)=>{let o="basic_diseases"===e?"其他，請列明":"drug_allergies"===e?"其他藥物，請列明":"其他食物，請列明";console.log("其他選項輸入變更: ".concat(e,', "').concat(o,'", 值: "').concat(s,'"')),"basic_diseases"===e?O(s):"drug_allergies"===e?T(s):R(s),L[e].includes(o)||(console.log('強制將 "'.concat(o,'" 選項添加到 ').concat(e)),U(s=>{let t=s[e].filter(e=>!e.includes("我沒有"));return t.includes(o)?s:{...s,[e]:[...t,o]}}))},z=e=>{y(e),e?(U({chinese_name:"",english_name:"",id_number:"",birth_date:"",phone_number:"",email:"no@no.com",gender:"",basic_diseases:["我沒有任何基礎病"],drug_allergies:["我沒有任何藥物過敏"],food_allergies:["我沒有任何食物過敏"],note:"",has_appointment:!1,doctor_id:void 0,data_source:"",region:"",district:"",sub_district:"",chief_complaint:""}),O(""),T(""),R(""),m(null),w(!1),E(!1),A(!1),S(!1)):(j(""),m({type:"info",text:"請輸入身份證號碼或電話號碼查詢現有患者"}),setTimeout(()=>{let e=document.getElementById("patient-search");e&&e.focus()},100))},M=async()=>{if(!_||_.length<5){m({type:"error",text:"請輸入有效的身份證號碼或電話號碼"});return}l(!0);try{let e;if(/^\d+$/.test(_))e=await g(_);else{let s=await d(_);if(s.exists&&s.patient)e=s.patient;else throw Error("找不到此身份證對應的患者記錄")}U({chinese_name:e.chinese_name,english_name:e.english_name,id_number:e.id_number,birth_date:e.birth_date,phone_number:e.phone_number,email:e.email||"",gender:e.gender||"",basic_diseases:e.basic_diseases,drug_allergies:e.drug_allergies,food_allergies:e.food_allergies,note:e.note||"",has_appointment:e.has_appointment,doctor_id:e.doctor_id,data_source:e.data_source,region:e.region,district:e.district,sub_district:e.sub_district,chief_complaint:e.chief_complaint||""}),B(e.basic_diseases,"basic_diseases"),B(e.drug_allergies,"drug_allergies"),B(e.food_allergies,"food_allergies"),E(!e.basic_diseases.some(e=>e.includes("我沒有"))),A(!e.drug_allergies.some(e=>e.includes("我沒有"))),S(!e.food_allergies.some(e=>e.includes("我沒有"))),w(!0),m({type:"success",text:"已找到患者: ".concat(e.chinese_name," (").concat(e.registration_number,")，請選擇主診醫師並完成覆診掛號")})}catch(e){console.error("查詢患者失敗:",e),m({type:"error",text:e.message||"無法找到患者記錄，請檢查輸入或轉為初診"})}finally{l(!1)}},B=(e,s)=>{let o=e.find(e=>e.startsWith("其他:")||e.startsWith("其他，請列明:")||e.startsWith("其他藥物:")||e.startsWith("其他食物:"));if(!o)return;let t="";o.startsWith("其他:")?t=o.replace("其他:","").trim():o.startsWith("其他，請列明:")?t=o.replace("其他，請列明:","").trim():o.startsWith("其他藥物:")?t=o.replace("其他藥物:","").trim():o.startsWith("其他食物:")&&(t=o.replace("其他食物:","").trim()),"basic_diseases"===s?(O(t),U(e=>({...e,[s]:[...e[s].filter(e=>!e.startsWith("其他:")&&!e.startsWith("其他，請列明:")),"其他疾病，請列明"]}))):"drug_allergies"===s?(T(t),U(e=>({...e,[s]:[...e[s].filter(e=>!e.startsWith("其他藥物:")&&!e.startsWith("其他，請列明:")),"其他藥物，請列明"]}))):"food_allergies"===s&&(R(t),U(e=>({...e,[s]:[...e[s].filter(e=>!e.startsWith("其他食物:")&&!e.startsWith("其他，請列明:")),"其他食物，請列明"]})))},J=async e=>{var s,o,t,r;e.preventDefault(),l(!0),m(null),D(null);try{if(!L.doctor_id){m({type:"error",text:"請選擇醫師"}),l(!1);return}let e=["chinese_name","english_name","id_number","birth_date","phone_number","data_source","region","district","sub_district"].filter(e=>!L[e]);if(e.length>0){m({type:"error",text:"以下欄位為必填: ".concat(e.join(", "))}),l(!1);return}if(!/^[\u4e00-\u9fa5]{2,10}$/.test(L.chinese_name)){m({type:"error",text:"中文姓名必須為2-10個中文字"}),l(!1);return}if(!/^[A-Za-z\s]+$/.test(L.english_name)){m({type:"error",text:"英文姓名只能包含英文字母和空格"}),l(!1);return}let t={...L};if(t.email&&""!==t.email&&"undefined"!==t.email&&("string"!=typeof t.email||""!==t.email.trim())||(console.log("處理 email 之前:",t.email,typeof t.email),console.log("Email 欄位無效，設置為 no@no.com"),t.email="no@no.com"),console.log("處理 email 之後:",t.email),f)try{(await d(t.id_number)).exists&&(console.log("初診流程發現患者已存在，自動轉為覆診流程"),m({type:"info",text:"此身份證號碼已存在，系統將自動使用覆診流程"}))}catch(e){console.log("檢查患者是否存在時出錯，繼續流程:",e)}if(t.basic_diseases.includes("其他，請列明")&&P.trim()){let e=[...t.basic_diseases],s=e.indexOf("其他，請列明");-1!==s&&(e[s]="其他，請列明: ".concat(P.trim()),t.basic_diseases=e)}else t.basic_diseases.includes("其他，請列明")&&(t.basic_diseases=t.basic_diseases.filter(e=>"其他，請列明"!==e),0===t.basic_diseases.length&&(t.basic_diseases=["我沒有任何基礎病"]));if(t.drug_allergies.includes("其他藥物，請列明")&&W.trim()){let e=[...t.drug_allergies],s=e.indexOf("其他藥物，請列明");-1!==s&&(e[s]="其他藥物: ".concat(W.trim()),t.drug_allergies=e)}else t.drug_allergies.includes("其他藥物，請列明")&&(t.drug_allergies=t.drug_allergies.filter(e=>"其他藥物，請列明"!==e),0===t.drug_allergies.length&&(t.drug_allergies=["我沒有任何藥物過敏"]));if(t.food_allergies.includes("其他食物，請列明")&&q.trim()){let e=[...t.food_allergies],s=e.indexOf("其他食物，請列明");-1!==s&&(e[s]="其他食物: ".concat(q.trim()),t.food_allergies=e)}else t.food_allergies.includes("其他食物，請列明")&&(t.food_allergies=t.food_allergies.filter(e=>"其他食物，請列明"!==e),0===t.food_allergies.length&&(t.food_allergies=["我沒有任何食物過敏"]));console.log("✅ 嘗試提交表單數據:",JSON.stringify(t)),console.log("確認 Email 值:",t.email),t.email&&""!==t.email&&"string"==typeof t.email||(t.email="no@no.com",console.log("最終安全檢查: 設置 email 為 no@no.com"));let r=await u(t);console.log("✅ 患者創建/更新成功:",r);let a=(null==h?void 0:null===(o=h.doctors)||void 0===o?void 0:null===(s=o.find(e=>e.id===L.doctor_id))||void 0===s?void 0:s.name)||"未知醫師";D({chinese_name:L.chinese_name,registration_number:r.registration_number,doctor_name:a,registration_time:new Date().toLocaleString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}),m({type:"success",text:"患者".concat(f?"登記":"覆診","成功！掛號編號: ").concat(r.registration_number)}),w(!1),O(""),T(""),R("")}catch(e){if(console.error("❌ 提交患者登記表單錯誤:",e),e.isValidationError||e.response&&422===e.response.status){if(e.validationErrors&&Object.keys(e.validationErrors).length>0){let s=Object.entries(e.validationErrors).map(e=>{let[s,o]=e;return"".concat(s,": ").concat(o)}).join("\n");m({type:"error",text:"請檢查以下欄位:\n".concat(s)})}else if(null===(r=e.response)||void 0===r?void 0:null===(t=r.data)||void 0===t?void 0:t.detail){let s="";s=Array.isArray(e.response.data.detail)?e.response.data.detail.map(e=>{let s=e.loc&&e.loc.length>1?e.loc.slice(1).join("."):"未知欄位";return"".concat(s,": ").concat(e.msg)}).join("\n"):e.response.data.detail,m({type:"error",text:"資料驗證失敗:\n".concat(s)})}else m({type:"error",text:e.message||"資料驗證失敗，請檢查輸入"})}else if(e.isNetworkError)m({type:"error",text:"連接伺服器失敗，請檢查網絡連接並稍後再試"});else if(e.response){if(409===e.response.status){let s=e.message||"";s.includes("請先切換到覆診模式")||s.includes("請切換到覆診模式")?(m({type:"info",text:e.message}),setTimeout(()=>{y(!1),j(L.id_number||L.phone_number||""),m({type:"info",text:"系統已自動切換為覆診模式，請點擊「搜尋」按鈕查詢患者資料"})},1e3)):m({type:"info",text:"此患者已存在，系統嘗試自動處理為覆診流程但未成功。請手動切換到覆診模式並搜尋患者資料。"})}else 404===e.response.status?f?m({type:"info",text:"系統處理患者資料時遇到問題，正在嘗試自動恢復。請稍後再試或聯絡技術支援。"}):m({type:"error",text:"系統找不到此患者記錄。如果是新患者，請切換到初診模式進行登記。"}):m({type:"error",text:e.message&&(e.message.includes("患者")||e.message.includes("病人")||e.message.includes("覆診"))?e.message:"系統處理請求時發生錯誤 (".concat(e.response.status,")，請稍後再試或聯絡櫃檯人員")})}else m({type:"error",text:e.message||"發生未知錯誤，請稍後再試"})}finally{l(!1)}};return((0,r.useEffect)(()=>{console.log("當前表單狀態:"),console.log("- 基礎疾病:",L.basic_diseases),console.log("- 藥物過敏:",L.drug_allergies),console.log("- 食物過敏:",L.food_allergies),console.log("- 其他基礎疾病值:",P),console.log("- 其他藥物過敏值:",W),console.log("- 其他食物過敏值:",q)},[L.basic_diseases,L.drug_allergies,L.food_allergies,P,W,q]),(0,r.useEffect)(()=>{let e=L.drug_allergies.includes("其他藥物，請列明"),s=L.food_allergies.includes("其他食物，請列明");console.log("渲染檢查:"),console.log("- 藥物過敏包含「其他」選項:",e),console.log("- 食物過敏包含「其他」選項:",s),h&&console.log("- 醫師列表狀態:",h.doctors?"有效 (".concat(Array.isArray(h.doctors)?h.doctors.length:"非數組",")"):"無效")},[L.drug_allergies,L.food_allergies,h]),(0,r.useEffect)(()=>{if(console.log("初始化頁面狀態:"),console.log("- 參考資料:",h),console.log("- 表單數據:",L),h&&(!h.doctors||!Array.isArray(h.doctors)||0===h.doctors.length)){console.warn("⚠️ 醫師資料加載失敗，嘗試重新載入");let e=setTimeout(async()=>{try{console.log("\uD83D\uDD04 自動重試載入醫師資料");let e=await c();e.doctors&&Array.isArray(e.doctors)&&e.doctors.length>0?(console.log("✅ 重試成功，載入了醫師資料:",e.doctors),p(e),m({type:"success",text:"醫師資料已自動更新"})):(console.error("❌ 重試後仍無法獲取醫師資料"),m({type:"error",text:"無法載入醫師資料，請點擊「重新載入醫師資料」按鈕嘗試手動更新"}))}catch(e){console.error("❌ 自動重試載入醫師資料失敗:",e)}},3e3);return()=>clearTimeout(e)}},[h]),h)?(0,t.jsx)(x,{children:(0,t.jsx)("div",{className:"bg-white shadow-md rounded-lg p-6",children:N?N?(0,t.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[(0,t.jsxs)("div",{className:"flex items-center text-green-600 mb-4",children:[(0,t.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-8 w-8 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}),(0,t.jsx)("h2",{className:"text-xl font-semibold",children:"掛號成功"})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-gray-600",children:"患者姓名"}),(0,t.jsx)("p",{className:"font-medium",children:N.chinese_name})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-gray-600",children:"掛號編號"}),(0,t.jsx)("p",{className:"font-medium",children:N.registration_number})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-gray-600",children:"主診醫師"}),(0,t.jsx)("p",{className:"font-medium",children:N.doctor_name||"未指定"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-gray-600",children:"登記時間"}),(0,t.jsx)("p",{className:"font-medium",children:N.registration_time})]})]}),(0,t.jsxs)("div",{className:"flex flex-wrap gap-3 mt-6",children:[(0,t.jsx)("button",{onClick:()=>{U({chinese_name:"",english_name:"",id_number:"",birth_date:"",phone_number:"",email:"no@no.com",gender:"",basic_diseases:["我沒有任何基礎病"],drug_allergies:["我沒有任何藥物過敏"],food_allergies:["我沒有任何食物過敏"],note:"",has_appointment:!1,doctor_id:void 0,data_source:"",region:"",district:"",sub_district:"",chief_complaint:""}),E(!1),A(!1),S(!1),D(null)},className:"flex-1 min-w-[120px] py-2 px-4 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors",children:"再登記一位病人"}),(0,t.jsx)("a",{href:"/appointments?patient_name=".concat(encodeURIComponent(N.chinese_name),"&phone_number=").concat(encodeURIComponent(L.phone_number)),className:"flex-1 min-w-[120px] py-2 px-4 bg-orange-500 text-white rounded hover:bg-orange-600 transition-colors text-center",children:"為此患者預約"}),(0,t.jsx)("a",{href:"/medical_record",className:"flex-1 min-w-[120px] py-2 px-4 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors text-center",children:"前往病歷系統"})]})]}):null:(0,t.jsxs)("form",{onSubmit:J,children:[i&&(0,t.jsx)("div",{className:"mb-4 p-3 rounded-md ".concat("error"===i.type?"bg-red-50 text-red-700 border border-red-200":"success"===i.type?"bg-green-50 text-green-700 border border-green-200":"bg-blue-50 text-blue-700 border border-blue-200"),children:(0,t.jsx)("p",{className:"whitespace-pre-line",children:i.text})}),(0,t.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,t.jsx)("div",{className:"text-lg font-bold",children:"患者登記表"}),(0,t.jsxs)("div",{className:"flex space-x-2",children:[(0,t.jsx)("button",{type:"button",className:"px-4 py-2 rounded-md ".concat(f?"bg-blue-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"),onClick:()=>z(!0),children:"初診"}),(0,t.jsx)("button",{type:"button",className:"px-4 py-2 rounded-md ".concat(f?"bg-gray-200 text-gray-700 hover:bg-gray-300":"bg-blue-600 text-white"),onClick:()=>z(!1),children:"覆診"})]})]}),!f&&(0,t.jsxs)("div",{className:"mb-6 p-4 bg-blue-50 rounded-md border border-blue-200",children:[(0,t.jsx)("div",{className:"text-blue-700 mb-2",children:"覆診病人需先輸入身份證或電話搜尋現有紀錄"}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsx)("input",{id:"patient-search",type:"text",value:_,onChange:e=>j(e.target.value),placeholder:"輸入身份證號碼或電話號碼",className:"flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"}),(0,t.jsx)("button",{type:"button",onClick:M,disabled:o,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-blue-300",children:o?"搜尋中...":"搜尋"})]})]}),!f&&v&&(0,t.jsx)("div",{className:"mb-4 flex justify-end",children:(0,t.jsxs)("button",{type:"button",onClick:()=>{w(!1),console.log("✅ 已解除唯讀狀態，fieldsReadOnly =",!1),setTimeout(()=>{let e=document.querySelectorAll('select[name="gender"]'),s=document.querySelectorAll('input[name="id_number"], input[name="birth_date"], input[name="chinese_name"]');e.forEach(e=>{e instanceof HTMLSelectElement&&(e.disabled=!1,console.log("✓ 已解除性別欄位的禁用狀態"))}),s.forEach(e=>{e instanceof HTMLInputElement&&(e.readOnly=!1,console.log("✓ 已解除 ".concat(e.name," 欄位的唯讀狀態")))})},100),m({type:"info",text:"您現在可以編輯患者資料。請注意，修改基本個人資料可能影響醫療記錄的一致性。"})},className:"px-3 py-1 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 flex items-center text-sm",children:[(0,t.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 mr-1",viewBox:"0 0 20 20",fill:"currentColor",children:(0,t.jsx)("path",{d:"M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"})}),"編輯患者資料"]})}),(0,t.jsx)("h2",{className:"text-xl font-bold mb-4",children:"基本資料"}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["中文姓名 ",(0,t.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,t.jsx)("input",{type:"text",name:"chinese_name",value:L.chinese_name,onChange:Z,readOnly:v,className:"mt-1 block w-full px-3 py-2 border ".concat(v?"bg-gray-100":"bg-white"," border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"),required:!0})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["英文姓名 ",(0,t.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,t.jsx)("input",{type:"text",name:"english_name",value:L.english_name,onChange:Z,readOnly:v,className:"mt-1 block w-full px-3 py-2 border ".concat(v?"bg-gray-100":"bg-white"," border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"),required:!0})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["身份證號碼 ",(0,t.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,t.jsx)("input",{type:"text",name:"id_number",value:L.id_number,onChange:Z,readOnly:v,className:"mt-1 block w-full px-3 py-2 border ".concat(v?"bg-gray-100":"bg-white"," border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"),required:!0})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["出生日期 ",(0,t.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,t.jsx)("input",{type:"date",name:"birth_date",value:L.birth_date,onChange:Z,readOnly:v,className:"mt-1 block w-full px-3 py-2 border ".concat(v?"bg-gray-100":"bg-white"," border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"),required:!0})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["手機號碼 ",(0,t.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,t.jsx)("input",{type:"tel",name:"phone_number",value:L.phone_number,onChange:Z,readOnly:v,className:"mt-1 block w-full px-3 py-2 border ".concat(v?"bg-gray-100":"bg-white"," border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"),required:!0})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"電子郵件 (選填)"}),(0,t.jsx)("input",{type:"email",name:"email",value:"no@no.com"===L.email?"":L.email,onChange:Z,readOnly:v,className:"mt-1 block w-full px-3 py-2 border ".concat(v?"bg-gray-100":"bg-white"," border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"),placeholder:"輸入電子郵件或留空"})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["性別 ",(0,t.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{name:"gender",value:L.gender,onChange:Z,required:!0,disabled:v,className:"mt-1 block w-full px-3 py-2 ".concat(v?"bg-gray-100":"bg-white"," border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"),children:[(0,t.jsx)("option",{value:"",children:"請選擇"}),(0,t.jsx)("option",{value:"男",children:"男"}),(0,t.jsx)("option",{value:"女",children:"女"}),(0,t.jsx)("option",{value:"其他",children:"其他"})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["從何得知本診所 ",(0,t.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{name:"data_source",value:L.data_source,onChange:Z,disabled:v,className:"mt-1 block w-full px-3 py-2 border ".concat(v?"bg-gray-100":"bg-white"," border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"),required:!0,children:[(0,t.jsx)("option",{value:"",children:"請選擇"}),h.data_sources.map(e=>(0,t.jsx)("option",{value:e,children:e},e))]})]})]}),(0,t.jsx)("h2",{className:"text-xl font-bold mb-4",children:"居住地區"}),(0,t.jsx)("div",{className:"mb-6",children:(0,t.jsx)(b,{regions:h.regions,onChange:e=>{U(s=>({...s,region:e.region,district:e.district,sub_district:e.subDistrict}))},value:{region:L.region,district:L.district,subDistrict:L.sub_district},required:!0,readOnly:v})}),(0,t.jsx)("h2",{className:"text-xl font-bold mb-4",children:"健康資訊"}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["是否有基礎疾病 ",(0,t.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{name:"has_basic_disease",value:k?"是":"否",onChange:e=>{let s="是"===e.target.value;E(s),s||(U(e=>({...e,basic_diseases:["我沒有任何基礎病"]})),O(""))},disabled:v,className:"mt-1 block w-full px-3 py-2 border ".concat(v?"bg-gray-100":"bg-white"," border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"),required:!0,children:[(0,t.jsx)("option",{value:"",children:"請選擇"}),(0,t.jsx)("option",{value:"是",children:"是"}),(0,t.jsx)("option",{value:"否",children:"否"})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["是否有藥物過敏 ",(0,t.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{name:"has_drug_allergy",value:C?"是":"否",onChange:e=>{let s="是"===e.target.value;A(s),s||(U(e=>({...e,drug_allergies:["我沒有任何藥物過敏"]})),T(""))},disabled:v,className:"mt-1 block w-full px-3 py-2 border ".concat(v?"bg-gray-100":"bg-white"," border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"),required:!0,children:[(0,t.jsx)("option",{value:"",children:"請選擇"}),(0,t.jsx)("option",{value:"是",children:"是"}),(0,t.jsx)("option",{value:"否",children:"否"})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["是否有食物過敏 ",(0,t.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{name:"has_food_allergy",value:I?"是":"否",onChange:e=>{let s="是"===e.target.value;S(s),s||(U(e=>({...e,food_allergies:["我沒有任何食物過敏"]})),R(""))},disabled:v,className:"mt-1 block w-full px-3 py-2 border ".concat(v?"bg-gray-100":"bg-white"," border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"),required:!0,children:[(0,t.jsx)("option",{value:"",children:"請選擇"}),(0,t.jsx)("option",{value:"是",children:"是"}),(0,t.jsx)("option",{value:"否",children:"否"})]})]})]}),k&&(0,t.jsxs)("div",{className:"mb-6 p-4 bg-gray-50 rounded-md border border-gray-200",children:[(0,t.jsx)("div",{className:"mb-2 font-medium",children:"請選擇基礎疾病（可多選）"}),(0,t.jsx)("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2 mb-3",children:h.basic_diseases.filter(e=>!e.includes("我沒有")).map((e,s)=>(0,t.jsxs)("label",{className:"inline-flex items-center",children:[(0,t.jsx)("input",{type:"checkbox",checked:L.basic_diseases.includes(e),onChange:s=>F("basic_diseases",e,s.target.checked),disabled:v,className:"h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"}),(0,t.jsx)("span",{className:"ml-2 text-sm text-gray-700",children:e})]},"basic_disease_".concat(s)))}),L.basic_diseases.includes("其他，請列明")&&(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"其他基礎疾病，請列明"}),(0,t.jsx)("input",{type:"text",value:P,onChange:e=>H("basic_diseases",e.target.value),disabled:v,className:"mt-1 block w-full px-3 py-2 border ".concat(v?"bg-gray-100":"bg-gray-50"," border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"),placeholder:"請詳細說明其他基礎疾病"}),L.basic_diseases.includes("其他，請列明")&&!P&&(0,t.jsx)("p",{className:"text-sm text-red-600 mt-1",children:"請填寫基礎疾病細節"})]})]}),C&&(0,t.jsxs)("div",{className:"mb-6 p-4 bg-gray-50 rounded-md border border-gray-200",children:[(0,t.jsx)("div",{className:"mb-2 font-medium",children:"請選擇藥物過敏（可多選）"}),(0,t.jsx)("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2 mb-3",children:h.drug_allergies.filter(e=>!e.includes("我沒有")).map((e,s)=>(0,t.jsxs)("label",{className:"inline-flex items-center",children:[(0,t.jsx)("input",{type:"checkbox",checked:L.drug_allergies.includes(e),onChange:s=>F("drug_allergies",e,s.target.checked),disabled:v,className:"h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"}),(0,t.jsx)("span",{className:"ml-2 text-sm text-gray-700",children:e})]},"drug_allergy_".concat(s)))}),L.drug_allergies.includes("其他藥物，請列明")&&(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"其他藥物過敏，請列明"}),(0,t.jsx)("input",{type:"text",value:W,onChange:e=>H("drug_allergies",e.target.value),disabled:v,className:"mt-1 block w-full px-3 py-2 border ".concat(v?"bg-gray-100":"bg-gray-50"," border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"),placeholder:"請詳細說明其他藥物過敏"}),L.drug_allergies.includes("其他藥物，請列明")&&!W&&(0,t.jsx)("p",{className:"text-sm text-red-600 mt-1",children:"請填寫藥物過敏細節"})]})]}),I&&(0,t.jsxs)("div",{className:"mb-6 p-4 bg-gray-50 rounded-md border border-gray-200",children:[(0,t.jsx)("div",{className:"mb-2 font-medium",children:"請選擇食物過敏（可多選）"}),(0,t.jsx)("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2 mb-3",children:h.food_allergies.filter(e=>!e.includes("我沒有")).map((e,s)=>(0,t.jsxs)("label",{className:"inline-flex items-center",children:[(0,t.jsx)("input",{type:"checkbox",checked:L.food_allergies.includes(e),onChange:s=>F("food_allergies",e,s.target.checked),disabled:v,className:"h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"}),(0,t.jsx)("span",{className:"ml-2 text-sm text-gray-700",children:e})]},"food_allergy_".concat(s)))}),L.food_allergies.includes("其他食物，請列明")&&(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"其他食物過敏，請列明"}),(0,t.jsx)("input",{type:"text",value:q,onChange:e=>H("food_allergies",e.target.value),disabled:v,className:"mt-1 block w-full px-3 py-2 border ".concat(v?"bg-gray-100":"bg-gray-50"," border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"),placeholder:"請詳細說明其他食物過敏"}),L.food_allergies.includes("其他食物，請列明")&&!q&&(0,t.jsx)("p",{className:"text-sm text-red-600 mt-1",children:"請填寫食物過敏細節"})]})]}),(0,t.jsxs)("div",{className:"mb-6",children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"備註（選填）"}),(0,t.jsx)("textarea",{name:"note",value:L.note,onChange:Z,disabled:v,rows:3,className:"mt-1 block w-full px-3 py-2 border ".concat(v?"bg-gray-100":"bg-white"," border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"),placeholder:"例如：偏好女醫師，懂英語，請準備輪椅"})]}),(0,t.jsxs)("div",{className:"mb-6",children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"自述主訴（選填）"}),(0,t.jsx)("textarea",{name:"chief_complaint",value:L.chief_complaint,onChange:Z,disabled:v,rows:3,className:"mt-1 block w-full px-3 py-2 border ".concat(v?"bg-gray-100":"bg-white"," border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"),placeholder:"請簡述您的不適或求診原因"})]}),(0,t.jsx)("h2",{className:"text-xl font-bold mb-4",children:"診所資訊"}),(0,t.jsxs)("div",{className:"mb-6",children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["主診醫師 ",(0,t.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,t.jsxs)("select",{name:"doctor_id",value:(null===(e=L.doctor_id)||void 0===e?void 0:e.toString())||"",onChange:e=>{let s=e.target.value?parseInt(e.target.value,10):void 0;U(e=>({...e,doctor_id:s}))},className:"mt-1 block w-full px-3 py-2 border bg-white border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",required:!0,children:[(0,t.jsx)("option",{value:"",children:"請選擇醫師"}),null===(s=h.doctors)||void 0===s?void 0:s.map(e=>(0,t.jsxs)("option",{value:e.id.toString(),children:[e.name," ",e.specialty?"(".concat(e.specialty,")"):""]},e.id))]})]}),(0,t.jsx)("div",{className:"flex justify-end",children:(0,t.jsx)("button",{type:"submit",disabled:o,className:"px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-300 flex items-center",children:o?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("svg",{className:"animate-spin -ml-1 mr-2 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,t.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,t.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"處理中..."]}):"提交表單"})})]})})}):(0,t.jsxs)("div",{className:"p-6 bg-white rounded-lg shadow-md",children:[(0,t.jsx)("div",{className:"flex items-center justify-center h-40",children:(0,t.jsxs)("div",{className:"animate-pulse flex flex-col items-center",children:[(0,t.jsx)("div",{className:"h-12 w-12 rounded-full bg-blue-200 mb-4"}),(0,t.jsx)("div",{className:"h-4 w-48 bg-blue-200 rounded mb-2"}),(0,t.jsx)("div",{className:"h-3 w-32 bg-blue-100 rounded"})]})}),(0,t.jsx)("p",{className:"text-center text-gray-500 mt-4",children:"載入中，請稍候..."})]})};class f extends r.Component{static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,s){console.error("患者登記頁面錯誤:",e,s)}render(){if(this.state.hasError){var e;return(0,t.jsx)("div",{className:"container mx-auto py-8 px-4",children:(0,t.jsxs)("div",{className:"max-w-4xl mx-auto p-8 bg-red-50 border border-red-200 rounded-lg shadow text-red-800",children:[(0,t.jsx)("h2",{className:"text-2xl font-bold mb-4",children:"頁面載入錯誤"}),(0,t.jsx)("p",{className:"mb-4",children:"很抱歉，患者登記系統暫時無法使用，請稍後再試。"}),(0,t.jsxs)("details",{className:"mb-4",children:[(0,t.jsx)("summary",{className:"cursor-pointer font-medium",children:"技術詳情"}),(0,t.jsx)("pre",{className:"mt-2 p-4 bg-red-100 rounded text-sm overflow-auto",children:null===(e=this.state.error)||void 0===e?void 0:e.toString()})]}),(0,t.jsxs)("div",{className:"flex gap-4",children:[(0,t.jsx)("button",{onClick:()=>window.location.reload(),className:"px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"重新載入"}),(0,t.jsx)("a",{href:"/appointments",className:"px-6 py-2 bg-gray-600 text-white rounded hover:bg-gray-700",children:"返回預約系統"})]})]})})}return this.props.children}constructor(e){super(e),this.state={hasError:!1,error:null}}}function y(){return(0,t.jsx)(f,{children:(0,t.jsxs)("div",{className:"container mx-auto py-8 px-4",children:[(0,t.jsx)("h1",{className:"text-3xl font-bold text-center mb-8",children:"患者登記系統"}),(0,t.jsx)(p,{})]})})}},5585:function(e,s,o){"use strict";o.d(s,{l9:function(){return r}});var t=o(3107);let r=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",s=e.startsWith("/")?e:"/".concat(e);return"".concat("https://clinic.aspiratcm.com/api/v1").concat(s)},a=t.Z.create({baseURL:r(),headers:{"Content-Type":"application/json",Accept:"application/json"},timeout:15e3});a.interceptors.request.use(e=>{var s;if(console.log("[API請求] ".concat(null===(s=e.method)||void 0===s?void 0:s.toUpperCase()," ").concat(e.url)),e.params&&console.log("[請求參數] ".concat(JSON.stringify(e.params))),e.data&&"string"!=typeof e.data)try{console.log("[請求數據] ".concat(JSON.stringify(e.data)))}catch(e){console.log("[請求數據] 無法序列化")}return e},e=>(console.error("[API請求錯誤]",e),Promise.reject(e))),a.interceptors.response.use(e=>(console.log("[API響應] ".concat(e.status," ").concat(e.config.url)),e),e=>{var s,o,t,r;let a=null==e?void 0:null===(s=e.response)||void 0===s?void 0:s.status,n=null==e?void 0:null===(o=e.config)||void 0===o?void 0:o.url,l=null==e?void 0:null===(r=e.config)||void 0===r?void 0:null===(t=r.method)||void 0===t?void 0:t.toUpperCase();return a?console.error("[".concat(l," ").concat(n,"] 錯誤 ").concat(a),e.response.data):console.error("[API錯誤]",e.message),Promise.reject(e)})}},function(e){e.O(0,[107,971,69,744],function(){return e(e.s=5466)}),_N_E=e.O()}]);